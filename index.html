<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sistema de Ordem de Produção - Embalagens (Firebase)</title>
<style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        .header{background:rgba(255,255,255,.95);padding:20px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);text-align:center;position:relative;}
        .header h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;font-weight:700}
        .header p{color:#7f8c8d;font-size:1.2em}
        
        /* Firebase Status Indicator */
        .firebase-status{position:absolute;top:10px;right:10px;padding:8px 12px;border-radius:20px;font-size:12px;font-weight:bold;color:white;}
        .firebase-status.connected{background:#28a745;}
        .firebase-status.disconnected{background:#dc3545;}
        .firebase-status.loading{background:#ffc107;color:#000;}

        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px}
        .stat-card{background:rgba(255,255,255,.9);padding:20px;border-radius:10px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .stat-number{font-size:2.5em;font-weight:bold;margin-bottom:5px}
        .stat-label{color:#6c757d;font-size:.9em;text-transform:uppercase}

        /* === Novos Estilos para Interface Reorganizada === */
        .top-actions{background:rgba(255,255,255,.95);padding:15px 20px;border-radius:12px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,.1);position:relative;}
        .action-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
        .action-buttons .btn{padding:10px 18px;font-size:14px;}
        
        .main-content-new{max-width:1200px;margin:0 auto;}
        .form-card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        
        /* Sistema de Abas */
        .form-tabs{display:flex;gap:0;margin-bottom:25px;background:#f1f3f4;border-radius:10px;padding:4px;overflow-x:auto;}
        .tab-btn{background:transparent;border:none;padding:12px 20px;border-radius:8px;font-weight:600;color:#6c757d;cursor:pointer;transition:all 0.3s ease;white-space:nowrap;flex:1;}
        .tab-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 12px rgba(102,126,234,.3);}
        .tab-btn:hover:not(.active){background:#e9ecef;color:#495057;}
        
        /* Conteúdo das Abas */
        .tab-content{display:none;}
        .tab-content.active{display:block;animation:fadeIn 0.3s ease;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
        
        /* Status de Produção Compacto */
        .production-status{background:#f8f9ff;border:2px solid #e8f2ff;border-radius:10px;padding:15px;margin:15px 0;}
        .production-status h4{color:#2c3e50;margin-bottom:12px;font-size:16px;}
        .process-checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin-bottom:15px;}
        .checkbox-label{display:flex;align-items:center;gap:8px;color:#495057;font-weight:500;cursor:pointer;padding:8px;border-radius:6px;transition:background 0.3s;}
        .checkbox-label:hover{background:#e8f4fd;}
        .checkbox-label input[type="checkbox"]{transform:scale(1.2);}
        
        .process-flow-compact{display:flex;flex-wrap:wrap;gap:8px;}
        .process-flow-compact .process-step{padding:6px 12px;background:#e9ecef;border-radius:15px;font-size:12px;color:#495057;}
        
        /* Botão de Criar Melhorado */
        .create-order-btn{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;border:none;padding:15px 30px;font-size:16px;font-weight:bold;border-radius:25px;cursor:pointer;margin:20px 0;box-shadow:0 8px 25px rgba(40,167,69,.3);transition:all 0.3s ease;width:100%;}
        .create-order-btn:hover{transform:translateY(-2px);box-shadow:0 12px 35px rgba(40,167,69,.4);}
        .create-order-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;box-shadow:none;}
        
        /* Campos de Entrada Melhorados */
        .form-group{margin-bottom:20px;}
        .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50;}
        .form-group input[type="text"],.form-group input[type="number"],.form-group select,.form-group textarea{width:100%;padding:12px 15px;border:2px solid #e9ecef;border-radius:8px;font-size:16px;transition:all 0.3s ease;background:#fff;}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1);}
        
        /* Grid Responsivo para Form */
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;}
        .form-grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;}
        
        /* Botões Gerais */
        .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;text-decoration:none;display:inline-block;text-align:center;font-size:14px;}
        .btn:hover{transform:translateY(-1px);box-shadow:0 8px 25px rgba(102,126,234,.3);}
        .btn.btn-danger{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);}
        .btn.btn-success{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);}
        .btn.btn-warning{background:linear-gradient(135deg,#ffc107 0%,#e0a800 100%);color:#000;}
        .btn.btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#545b62 100%);}
        .btn.btn-info{background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);}
        
        /* Lista de Ordens */
        .orders-list{margin-top:30px}
        .order-card{background:white;border-radius:12px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,.1);transition:all 0.3s ease;margin-bottom:20px}
        .order-card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.15);}
        .order-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
        .order-id{font-size:18px;font-weight:bold;}
        .order-status{padding:4px 12px;background:rgba(255,255,255,.2);border-radius:15px;font-size:12px;}
        .order-body{padding:20px;}
        .order-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;}
        .info-item{display:flex;flex-direction:column;}
        .info-label{font-size:12px;color:#6c757d;margin-bottom:4px;font-weight:600;text-transform:uppercase;}
        .info-value{font-size:14px;color:#2c3e50;font-weight:500;}
        .order-actions{display:flex;gap:10px;flex-wrap:wrap;}
        .order-actions .btn{padding:8px 15px;font-size:12px;}
        
        /* Processo de Produção Visual */
        .production-process{background:#f8f9fa;border-radius:8px;padding:15px;margin:15px 0;}
        .process-steps{display:flex;gap:10px;overflow-x:auto;padding:10px 0;}
        .process-step{background:#e9ecef;padding:8px 15px;border-radius:20px;white-space:nowrap;font-size:12px;font-weight:500;color:#495057;flex-shrink:0;}
        .process-step.completed{background:#28a745;color:white;}
        .process-step.current{background:#ffc107;color:#000;}
        
        /* Modal */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;z-index:1000;justify-content:center;align-items:center;}
        .modal.active{display:flex;}
        .modal-content{background:white;border-radius:15px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative;}
        .modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:15px 15px 0 0;}
        .modal-header h2{margin:0;font-size:24px;}
        .modal-body{padding:25px;}
        .modal-footer{padding:20px;border-top:1px solid #e9ecef;display:flex;gap:10px;justify-content:flex-end;}
        .close{position:absolute;top:10px;right:15px;font-size:28px;font-weight:bold;cursor:pointer;color:white;z-index:10;}
        .close:hover{opacity:0.8;}
        
        /* Notificações */
        .notification{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;color:white;font-weight:500;z-index:2000;transform:translateX(400px);transition:all 0.3s ease;max-width:350px;}
        .notification.show{transform:translateX(0);}
        .notification.success{background:#28a745;}
        .notification.error{background:#dc3545;}
        .notification.info{background:#17a2b8;}
        .notification.warning{background:#ffc107;color:#000;}
        
        /* FAB */
        .fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(102,126,234,.4);font-size:24px;z-index:1000;transition:all 0.3s ease;}
        .fab:hover{transform:scale(1.1);box-shadow:0 8px 24px rgba(102,126,234,.6);}
        
        /* Lista Compacta */
        .compact-view .order-card{margin-bottom:8px;}
        .compact-view .order-header{padding:10px 15px;font-size:14px;}
        .compact-view .order-body{padding:12px 15px;}
        .compact-view .order-info{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;}
        .compact-view .production-process{display:none;}
        .compact-view .order-actions .btn{padding:6px 12px;font-size:11px;}
        
        /* Input invisível para import */
        #importFile{display:none;}
        
        /* Responsivo */
        @media (max-width: 768px) {
            .container{padding:10px;}
            .header h1{font-size:2em;}
            .form-grid{grid-template-columns:1fr;}
            .order-info{grid-template-columns:1fr;}
            .action-buttons{justify-content:stretch;}
            .action-buttons .btn{flex:1;margin:2px;}
            .form-tabs{flex-direction:column;}
            .tab-btn{border-radius:8px;margin-bottom:4px;}
            .process-steps{flex-direction:column;}
            .order-actions{flex-direction:column;}
            .modal-content{margin:10px;max-width:calc(100vw - 20px);max-height:calc(100vh - 20px);}
            .order-header{flex-direction:column;text-align:center;}
            .fab{bottom:10px;right:10px;width:48px;height:48px;font-size:20px;}
            .form-group input,.form-group select,.form-group textarea{font-size:16px !important;}
        }
        
        /* Animações */
        @keyframes slideIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
        .order-card{animation:slideIn 0.3s ease;}
        
        /* Print styles */
        @media print{
            body{background:white !important;}
            .container{max-width:none;padding:0;}
            .top-actions,.fab,.modal,.notification{display:none !important;}
            .order-card{box-shadow:none;border:1px solid #ddd;margin-bottom:15px;}
            .order-header{background:#f8f9fa !important;color:#333 !important;}
        }
</style>
</head>
<body>
    <div class="container">
        <!-- Header com status do Firebase -->
        <div class="header">
            <div class="firebase-status loading" id="firebase-status">Conectando Firebase...</div>
            <h1>Sistema de Ordem de Produção</h1>
            <p>Gestão de Embalagens com Firebase</p>
        </div>

        <!-- Estatísticas -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-number" id="total-orders">0</div>
                <div class="stat-label">Total de OPs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-orders">0</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="in-progress-orders">0</div>
                <div class="stat-label">Em Produção</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completed-orders">0</div>
                <div class="stat-label">Finalizadas</div>
            </div>
        </div>

        <!-- Ações Principais -->
        <div class="top-actions">
            <div class="action-buttons">
                <button class="btn" onclick="showTab('create')">Nova OP</button>
                <button class="btn btn-info" onclick="showTab('templates')">Modelos</button>
                <button class="btn btn-secondary" onclick="toggleViewMode()">Alternar Visualização</button>
                <button class="btn btn-success" onclick="exportData()">Exportar</button>
                <button class="btn btn-warning" onclick="importData()">Importar</button>
                <button class="btn btn-info" onclick="openSendToGraficaModal()">Enviar à Gráfica</button>
                <button class="btn btn-danger" onclick="clearAllData()">Limpar Dados</button>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="main-content-new">
            <div class="form-card">
                <!-- Abas -->
                <div class="form-tabs">
                    <button class="tab-btn active" onclick="showTab('list')">Lista de OPs</button>
                    <button class="tab-btn" onclick="showTab('create')">Criar OP</button>
                    <button class="tab-btn" onclick="showTab('templates')">Modelos</button>
                </div>

                <!-- Aba: Lista de OPs -->
                <div id="tab-list" class="tab-content active">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                        <h3>Ordens de Produção</h3>
                        <div>
                            <input type="checkbox" onclick="toggleSelectAll()" style="margin-right:5px;">
                            <span style="font-size:14px;color:#6c757d;">Selecionar Todas</span>
                        </div>
                    </div>
                    <div id="orders-list" class="orders-list">
                        <!-- OPs serão carregadas aqui -->
                    </div>
                </div>

                <!-- Aba: Criar OP -->
                <div id="tab-create" class="tab-content">
                    <h3 style="margin-bottom:25px;">Criar Nova Ordem de Produção</h3>
                    
                    <form id="production-form" onsubmit="createOrder(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome do Produto/Template</label>
                                <input type="text" id="nomeTemplate" required placeholder="Ex: Caixa de Pizza Grande">
                            </div>
                            <div class="form-group">
                                <label>Quantidade</label>
                                <input type="number" id="quantidade" required placeholder="1000">
                            </div>
                            <div class="form-group">
                                <label>Cliente</label>
                                <input type="text" id="cliente" placeholder="Nome do Cliente">
                            </div>
                        </div>

                        <div class="form-grid-3">
                            <div class="form-group">
                                <label>Tipo de Papel</label>
                                <input type="text" id="tipoPapel" placeholder="Kraft, Offset, etc.">
                            </div>
                            <div class="form-group">
                                <label>Gramatura</label>
                                <input type="text" id="gramatura" placeholder="180g, 250g, etc.">
                            </div>
                            <div class="form-group">
                                <label>Fornecedor</label>
                                <input type="text" id="fornecedor" placeholder="Nome do Fornecedor">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Resmas Usadas</label>
                                <input type="number" step="0.01" id="resmasUsadas" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>Observações</label>
                                <textarea id="observacoes" placeholder="Informações adicionais" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- Status de Produção -->
                        <div class="production-status">
                            <h4>Status de Produção</h4>
                            <div class="process-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="processo" value="Corte/Vinco"> Corte/Vinco
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="processo" value="Impressão"> Impressão
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="processo" value="Colagem"> Colagem
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="processo" value="Acabamento"> Acabamento
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="processo" value="Embalagem"> Embalagem
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="processo" value="Expedição"> Expedição
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="create-order-btn">
                            🚀 Criar Ordem de Produção
                        </button>
                    </form>
                </div>

                <!-- Aba: Modelos -->
                <div id="tab-templates" class="tab-content">
                    <h3 style="margin-bottom:25px;">Modelos de Produtos</h3>
                    <div id="templates-list">
                        <!-- Modelos serão carregados aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input oculto para importar arquivo -->
    <input type="file" id="importFile" accept=".json" onchange="handleImport(event)">

    <!-- Notificações -->
    <div id="notification" class="notification"></div>

    <!-- Botão Flutuante -->
    <button id="scrollFab" class="fab" title="Ir para Ordens">📋</button>

    <!-- Modal Envio à Gráfica -->
    <div id="graficaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGraficaModal()">&times;</span>
            <div class="modal-header">
                <h2>📦 Envio à Gráfica</h2>
            </div>
            <div class="modal-body">
                <p id="graficaMeta"></p>
                <div id="graficaOrders"></div>
                <div id="graficaTotais" style="margin-top:15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="printGraficaReport()">🖨️ Imprimir</button>
                <button class="btn btn-secondary" onclick="closeGraficaModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBy0RGYoK3oFdFVnoVhG3dNva3BKbvCeUs",
            authDomain: "sistema-de-ordem-de-producao.firebaseapp.com",
            projectId: "sistema-de-ordem-de-producao",
            storageBucket: "sistema-de-ordem-de-producao.firebasestorage.app",
            messagingSenderId: "681409177091",
            appId: "1:681409177091:web:84fda4b78d4e4893dd9036"
        };

        // Inicializar Firebase
        let app, db;
        let isFirebaseConnected = false;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isFirebaseConnected = true;
            updateFirebaseStatus('connected', 'Firebase Conectado');
        } catch (error) {
            console.error('Erro ao conectar com Firebase:', error);
            updateFirebaseStatus('disconnected', 'Firebase Desconectado');
            isFirebaseConnected = false;
        }

        // Storage com fallback para iOS/Android (Private Mode, restrições, etc.)
        const storage = (function(){
            try {
                const testKey = '__t__';
                localStorage.setItem(testKey, '1');
                localStorage.removeItem(testKey);
                return localStorage;
            } catch (e) {
                // Fallback em memória
                const mem = {};
                return {
                    getItem: (k) => (k in mem ? mem[k] : null),
                    setItem: (k, v) => { mem[k] = String(v); },
                    removeItem: (k) => { delete mem[k]; }
                };
            }
        })();

        function getJSON(key, fallback){
            try {
                const v = storage.getItem(key);
                return v ? JSON.parse(v) : fallback;
            } catch(e){
                return fallback;
            }
        }
        
        function setJSON(key, value){
            try { storage.setItem(key, JSON.stringify(value)); } catch(e){}
        }

        // Coleções do Firebase
        const COLLECTIONS = {
            ORDERS: 'production_orders',
            TEMPLATES: 'product_templates',
            SETTINGS: 'app_settings'
        };

        // Variáveis globais
        let orders = [];
        let productTemplates = [];
        let orderIdCounter = 1;
        let selectedOrderIds = new Set();
        let selectedTemplate = null;
        let viewMode = 'detailed';

        // Atualizar status do Firebase
        function updateFirebaseStatus(status, message) {
            const statusEl = document.getElementById('firebase-status');
            if (statusEl) {
                statusEl.className = `firebase-status ${status}`;
                statusEl.textContent = message;
            }
        }

        // ===== FIREBASE OPERATIONS =====
        
        async function loadDataFromFirebase() {
            if (!isFirebaseConnected) return;
            
            try {
                // Carregar ordens
                const ordersSnapshot = await getDocs(query(collection(db, COLLECTIONS.ORDERS), orderBy('createdAt', 'desc')));
                orders = ordersSnapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    ...doc.data(),
                    // Converter timestamps do Firestore para datas legíveis
                    dataCreation: doc.data().dataCreation || (doc.data().createdAt ? new Date(doc.data().createdAt.seconds * 1000).toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR')),
                    horaCreation: doc.data().horaCreation || (doc.data().createdAt ? new Date(doc.data().createdAt.seconds * 1000).toLocaleTimeString('pt-BR') : new Date().toLocaleTimeString('pt-BR'))
                }));

                // Carregar templates
                const templatesSnapshot = await getDocs(collection(db, COLLECTIONS.TEMPLATES));
                productTemplates = templatesSnapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    ...doc.data()
                }));

                // Carregar configurações
                const settingsSnapshot = await getDocs(collection(db, COLLECTIONS.SETTINGS));
                const settingsDoc = settingsSnapshot.docs.find(doc => doc.id === 'counter');
                if (settingsDoc) {
                    orderIdCounter = settingsDoc.data().orderIdCounter || 1;
                } else {
                    // Criar documento de configurações se não existir
                    await setDoc(doc(db, COLLECTIONS.SETTINGS, 'counter'), {
                        orderIdCounter: 1,
                        createdAt: serverTimestamp()
                    });
                }

                console.log('Dados carregados do Firebase:', {
                    orders: orders.length,
                    templates: productTemplates.length,
                    counter: orderIdCounter
                });

            } catch (error) {
                console.error('Erro ao carregar dados do Firebase:', error);
                showNotification('Erro ao carregar dados do Firebase. Usando dados locais.', 'warning');
                loadFromLocalStorage();
            }
        }

        async function saveOrderToFirebase(orderData) {
            if (!isFirebaseConnected) return null;
            
            try {
                const docRef = await addDoc(collection(db, COLLECTIONS.ORDERS), {
                    ...orderData,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                // Atualizar contador
                await updateOrderCounter();
                
                return docRef.id;
            } catch (error) {
                console.error('Erro ao salvar ordem no Firebase:', error);
                throw error;
            }
        }

        async function updateOrderInFirebase(firebaseId, updateData) {
            if (!isFirebaseConnected || !firebaseId) return;
            
            try {
                await updateDoc(doc(db, COLLECTIONS.ORDERS, firebaseId), {
                    ...updateData,
                    updatedAt: serverTimestamp()
                });
            } catch (error) {
                console.error('Erro ao atualizar ordem no Firebase:', error);
            }
        }

        async function deleteOrderFromFirebase(firebaseId) {
            if (!isFirebaseConnected || !firebaseId) return;
            
            try {
                await deleteDoc(doc(db, COLLECTIONS.ORDERS, firebaseId));
            } catch (error) {
                console.error('Erro ao deletar ordem do Firebase:', error);
                throw error;
            }
        }

        async function saveTemplateToFirebase(templateData) {
            if (!isFirebaseConnected) return null;
            
            try {
                const docRef = await addDoc(collection(db, COLLECTIONS.TEMPLATES), {
                    ...templateData,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Erro ao salvar template no Firebase:', error);
                throw error;
            }
        }

        async function updateOrderCounter() {
            if (!isFirebaseConnected) return;
            
            try {
                await setDoc(doc(db, COLLECTIONS.SETTINGS, 'counter'), {
                    orderIdCounter: orderIdCounter,
                    updatedAt: serverTimestamp()
                });
            } catch (error) {
                console.error('Erro ao atualizar contador:', error);
            }
        }

        function setupFirebaseListeners() {
            if (!isFirebaseConnected) return;

            // Listener para ordens
            onSnapshot(query(collection(db, COLLECTIONS.ORDERS), orderBy('createdAt', 'desc')), (snapshot) => {
                orders = snapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    ...doc.data(),
                    dataCreation: doc.data().dataCreation || (doc.data().createdAt ? new Date(doc.data().createdAt.seconds * 1000).toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR')),
                    horaCreation: doc.data().horaCreation || (doc.data().createdAt ? new Date(doc.data().createdAt.seconds * 1000).toLocaleTimeString('pt-BR') : new Date().toLocaleTimeString('pt-BR'))
                }));
                displayOrders();
                updateStats();
            });

            // Listener para templates
            onSnapshot(collection(db, COLLECTIONS.TEMPLATES), (snapshot) => {
                productTemplates = snapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    ...doc.data()
                }));
                loadTemplatesList();
            });
        }

        function loadFromLocalStorage() {
            orders = getJSON('productionOrders', []);
            orderIdCounter = parseInt(storage.getItem('orderIdCounter')) || 1;
            productTemplates = getJSON('productTemplates', []);
            viewMode = storage.getItem('ordersViewMode') || 'detailed';
        }

        function saveToLocalStorage() {
            setJSON('productionOrders', orders);
            setJSON('productTemplates', productTemplates);
            storage.setItem('orderIdCounter', orderIdCounter);
            storage.setItem('ordersViewMode', viewMode);
        }

        // ===== FUNÇÕES PRINCIPAIS =====

        function generateOrderId() {
            const id = orderIdCounter;
            orderIdCounter++;
            
            if (isFirebaseConnected) {
                updateOrderCounter();
            } else {
                saveToLocalStorage();
            }
            
            return `OP-${String(id).padStart(4, '0')}`;
        }

        async function createOrder(event) {
            event.preventDefault();
            
            const orderData = {
                id: generateOrderId(),
                nomeTemplate: document.getElementById('nomeTemplate').value,
                quantidade: parseInt(document.getElementById('quantidade').value),
                cliente: document.getElementById('cliente').value,
                tipoPapel: document.getElementById('tipoPapel').value,
                gramatura: document.getElementById('gramatura').value,
                fornecedor: document.getElementById('fornecedor').value,
                resmasUsadas: parseFloat(document.getElementById('resmasUsadas').value) || 0,
                observacoes: document.getElementById('observacoes').value,
                processosCompletos: [],
                dataCreation: new Date().toLocaleDateString('pt-BR'),
                horaCreation: new Date().toLocaleTimeString('pt-BR'),
                status: 'Pendente'
            };

            // Coletar processos marcados
            const processoCheckboxes = document.querySelectorAll('input[name="processo"]:checked');
            orderData.processosCompletos = Array.from(processoCheckboxes).map(cb => cb.value);
            
            // Determinar status
            if (orderData.processosCompletos.length === 0) {
                orderData.status = 'Pendente';
            } else if (orderData.processosCompletos.length === 6) {
                orderData.status = 'Finalizada';
            } else {
                orderData.status = 'Em Produção';
            }

            try {
                if (isFirebaseConnected) {
                    const firebaseId = await saveOrderToFirebase(orderData);
                    orderData.firebaseId = firebaseId;
                } else {
                    orders.unshift(orderData);
                    saveToLocalStorage();
                }

                // Salvar como template
                await saveAsTemplate(orderData);
                
                showNotification(`OP ${orderData.id} criada com sucesso!`, 'success');
                document.getElementById('production-form').reset();
                showTab('list');
                
                // Atualizar UI se não tiver listeners
                if (!isFirebaseConnected) {
                    displayOrders();
                    updateStats();
                }

            } catch (error) {
                console.error('Erro ao criar ordem:', error);
                showNotification('Erro ao criar ordem de produção', 'error');
            }
        }

        async function saveAsTemplate(orderData) {
            const templateData = {
                nomeTemplate: orderData.nomeTemplate,
                tipoPapel: orderData.tipoPapel,
                gramatura: orderData.gramatura,
                fornecedor: orderData.fornecedor,
                observacoes: orderData.observacoes,
                vezesCriado: 1,
                ultimaVez: new Date().toLocaleDateString('pt-BR')
            };

            const existingIndex = productTemplates.findIndex(t => t.nomeTemplate === templateData.nomeTemplate);
            
            if (existingIndex !== -1) {
                productTemplates[existingIndex].vezesCriado++;
                productTemplates[existingIndex].ultimaVez = templateData.ultimaVez;
                
                if (isFirebaseConnected && productTemplates[existingIndex].firebaseId) {
                    try {
                        await updateDoc(doc(db, COLLECTIONS.TEMPLATES, productTemplates[existingIndex].firebaseId), {
                            vezesCriado: productTemplates[existingIndex].vezesCriado,
                            ultimaVez: templateData.ultimaVez,
                            updatedAt: serverTimestamp()
                        });
                    } catch (error) {
                        console.error('Erro ao atualizar template no Firebase:', error);
                    }
                }
            } else {
                try {
                    if (isFirebaseConnected) {
                        const firebaseId = await saveTemplateToFirebase(templateData);
                        templateData.firebaseId = firebaseId;
                    }
                    productTemplates.push(templateData);
                } catch (error) {
                    console.error('Erro ao salvar template:', error);
                }
            }
            
            if (!isFirebaseConnected) {
                saveToLocalStorage();
                loadTemplatesList();
            }
        }

        function displayOrders() {
            const container = document.getElementById('orders-list');
            
            if (!orders.length) {
                container.innerHTML = `
                    <div style="text-align:center;padding:60px;color:#6c757d;">
                        <h3>Nenhuma ordem de produção encontrada</h3>
                        <p>Clique em "Nova OP" para começar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">${order.id}</div>
                            <div style="font-size:12px;opacity:0.9;">${order.dataCreation} às ${order.horaCreation}</div>
                        </div>
                        <div class="order-status">${order.status}</div>
                    </div>
                    <div class="order-body">
                        <div style="display:flex;align-items:center;margin-bottom:15px;">
                            <input type="checkbox" class="select-order" data-order-id="${order.id}" 
                                   onchange="toggleSelectOrder('${order.id}', this.checked)" style="margin-right:10px;">
                            <span style="font-size:14px;color:#6c757d;">Selecionar para envio à gráfica</span>
                        </div>
                        
                        <div class="order-info">
                            <div class="info-item">
                                <div class="info-label">Produto</div>
                                <div class="info-value">${order.nomeTemplate}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Quantidade</div>
                                <div class="info-value">${order.quantidade.toLocaleString('pt-BR')}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Cliente</div>
                                <div class="info-value">${order.cliente || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Papel</div>
                                <div class="info-value">${order.tipoPapel || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Gramatura</div>
                                <div class="info-value">${order.gramatura || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Resmas</div>
                                <div class="info-value">${(order.resmasUsadas || 0).toLocaleString('pt-BR')}</div>
                            </div>
                        </div>

                        <div class="production-process">
                            <div class="process-steps">
                                ${['Corte/Vinco', 'Impressão', 'Colagem', 'Acabamento', 'Embalagem', 'Expedição'].map(step => 
                                    `<div class="process-step ${order.processosCompletos?.includes(step) ? 'completed' : ''}">${step}</div>`
                                ).join('')}
                            </div>
                        </div>

                        ${order.observacoes ? `<div style="margin-top:15px;padding:10px;background:#f8f9fa;border-radius:6px;font-size:14px;"><strong>Observações:</strong> ${order.observacoes}</div>` : ''}

                        <div class="order-actions" style="margin-top:15px;">
                            <button class="btn btn-info" onclick="editOrder('${order.firebaseId || order.id}')">Editar</button>
                            <button class="btn btn-success" onclick="updateProcesses('${order.firebaseId || order.id}')">Status</button>
                            <button class="btn btn-warning" onclick="duplicateOrder('${order.firebaseId || order.id}')">Duplicar</button>
                            <button class="btn btn-danger" onclick="deleteOrder('${order.firebaseId || order.id}')">Excluir</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Aplicar modo de visualização
            if (viewMode === 'compact') {
                container.classList.add('compact-view');
            }
        }

        function loadTemplatesList() {
            const container = document.getElementById('templates-list');
            
            if (!productTemplates.length) {
                container.innerHTML = `
                    <div style="text-align:center;padding:60px;color:#6c757d;">
                        <h3>Nenhum modelo salvo</h3>
                        <p>Crie algumas ordens para gerar modelos automaticamente</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = productTemplates.map((template, index) => `
                <div class="order-card" style="cursor:pointer;" onclick="selectTemplate(${index})">
                    <div class="order-header" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%);">
                        <div class="order-id">${template.nomeTemplate}</div>
                        <div class="order-status">Usado ${template.vezesCriado}x</div>
                    </div>
                    <div class="order-body">
                        <div class="order-info">
                            <div class="info-item">
                                <div class="info-label">Papel</div>
                                <div class="info-value">${template.tipoPapel || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Gramatura</div>
                                <div class="info-value">${template.gramatura || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fornecedor</div>
                                <div class="info-value">${template.fornecedor || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Última Vez</div>
                                <div class="info-value">${template.ultimaVez}</div>
                            </div>
                        </div>
                        <div class="order-actions" style="margin-top:15px;">
                            <button class="btn btn-success" onclick="event.stopPropagation(); selectTemplate(${index}); showTab('create');">Usar Modelo</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const total = orders.length;
            const pending = orders.filter(o => o.status === 'Pendente').length;
            const inProgress = orders.filter(o => o.status === 'Em Produção').length;
            const completed = orders.filter(o => o.status === 'Finalizada').length;

            document.getElementById('total-orders').textContent = total;
            document.getElementById('pending-orders').textContent = pending;
            document.getElementById('in-progress-orders').textContent = inProgress;
            document.getElementById('completed-orders').textContent = completed;
        }

        function selectTemplate(index) {
            const template = productTemplates[index];
            selectedTemplate = template;
            
            document.getElementById('nomeTemplate').value = template.nomeTemplate || '';
            document.getElementById('tipoPapel').value = template.tipoPapel || '';
            document.getElementById('gramatura').value = template.gramatura || '';
            document.getElementById('fornecedor').value = template.fornecedor || '';
            document.getElementById('observacoes').value = template.observacoes || '';
            
            showNotification(`Modelo "${template.nomeTemplate}" carregado!`, 'success');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function toggleSelectOrder(orderId, checked) {
            if (checked) {
                selectedOrderIds.add(orderId);
            } else {
                selectedOrderIds.delete(orderId);
            }
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.select-order');
            const anyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = anyUnchecked;
                toggleSelectOrder(cb.dataset.orderId, anyUnchecked);
            });
            
            showNotification(anyUnchecked ? 'Todas as OPs selecionadas' : 'Seleção limpa', 'info');
        }

        function toggleViewMode() {
            viewMode = viewMode === 'detailed' ? 'compact' : 'detailed';
            const container = document.getElementById('orders-list');
            
            if (viewMode === 'compact') {
                container.classList.add('compact-view');
            } else {
                container.classList.remove('compact-view');
            }
            
            if (!isFirebaseConnected) {
                saveToLocalStorage();
            }
            
            showNotification(`Modo ${viewMode === 'detailed' ? 'detalhado' : 'compacto'} ativado`, 'info');
        }

        async function deleteOrder(id) {
            if (!confirm('Tem certeza que deseja excluir esta OP?')) return;
            
            try {
                if (isFirebaseConnected) {
                    const order = orders.find(o => o.firebaseId === id || o.id === id);
                    if (order && order.firebaseId) {
                        await deleteOrderFromFirebase(order.firebaseId);
                        showNotification('OP excluída com sucesso!', 'success');
                    }
                } else {
                    const index = orders.findIndex(o => o.id === id);
                    if (index !== -1) {
                        orders.splice(index, 1);
                        saveToLocalStorage();
                        displayOrders();
                        updateStats();
                        showNotification('OP excluída com sucesso!', 'success');
                    }
                }
            } catch (error) {
                console.error('Erro ao excluir OP:', error);
                showNotification('Erro ao excluir OP', 'error');
            }
        }

        function editOrder(id) {
            showNotification('Função de edição em desenvolvimento', 'info');
        }

        function updateProcesses(id) {
            showNotification('Função de atualização de processos em desenvolvimento', 'info');
        }

        function duplicateOrder(id) {
            const order = orders.find(o => (o.firebaseId || o.id) === id);
            if (order) {
                // Preencher formulário com dados da OP
                document.getElementById('nomeTemplate').value = order.nomeTemplate || '';
                document.getElementById('quantidade').value = order.quantidade || '';
                document.getElementById('cliente').value = order.cliente || '';
                document.getElementById('tipoPapel').value = order.tipoPapel || '';
                document.getElementById('gramatura').value = order.gramatura || '';
                document.getElementById('fornecedor').value = order.fornecedor || '';
                document.getElementById('resmasUsadas').value = order.resmasUsadas || '';
                document.getElementById('observacoes').value = order.observacoes || '';
                
                showTab('create');
                showNotification('Dados da OP carregados para duplicação', 'success');
            }
        }

        function exportData() {
            const data = {
                orders: orders,
                templates: productTemplates,
                orderIdCounter: orderIdCounter,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_ops_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Dados exportados com sucesso!', 'success');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('Isso irá substituir todos os dados atuais. Continuar?')) {
                        orders = data.orders || data || [];
                        productTemplates = data.templates || [];
                        orderIdCounter = data.orderIdCounter || 1;
                        
                        if (!isFirebaseConnected) {
                            saveToLocalStorage();
                        }
                        
                        displayOrders();
                        updateStats();
                        loadTemplatesList();
                        showNotification('Dados importados com sucesso!', 'success');
                    }
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    showNotification('Erro ao importar dados. Verifique o formato do arquivo.', 'error');
                }
            };
            reader.readAsText(file);
            
            // Limpar o input para permitir reimportar o mesmo arquivo
            event.target.value = '';
        }

        function clearAllData() {
            if (!confirm('ATENÇÃO: Isso irá apagar TODOS os dados. Esta ação não pode ser desfeita. Continuar?')) return;
            if (!confirm('Tem CERTEZA ABSOLUTA? Todos os dados serão perdidos!')) return;
            
            orders = [];
            productTemplates = [];
            orderIdCounter = 1;
            selectedOrderIds.clear();
            
            if (!isFirebaseConnected) {
                storage.removeItem('productionOrders');
                storage.removeItem('productTemplates');
                storage.removeItem('orderIdCounter');
            }
            
            displayOrders();
            updateStats();
            loadTemplatesList();
            showNotification('Todos os dados foram limpos!', 'success');
        }

        // === MODAL GRÁFICA ===
        function openSendToGraficaModal() {
            if (selectedOrderIds.size === 0) {
                showNotification('Selecione pelo menos uma OP.', 'error');
                return;
            }
            
            const selected = orders.filter(o => selectedOrderIds.has(o.id));
            document.getElementById('graficaMeta').textContent = `Total de ordens selecionadas: ${selected.length}`;
            
            const rows = selected.map(o => {
                const resmas = parseFloat(o.resmasUsadas || 0);
                return `
                    <div style="padding:10px;border-bottom:1px solid #eee;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;font-size:14px;">
                        <div><strong>${o.id}</strong></div>
                        <div>${o.nomeTemplate || ''}</div>
                        <div>${o.cliente || ''}</div>
                        <div>${o.tipoPapel || ''}</div>
                        <div>${o.gramatura || ''}</div>
                        <div style="text-align:right;">${resmas.toLocaleString('pt-BR')}</div>
                    </div>
                `;
            }).join('');
            
            const totalResmas = selected.reduce((sum, o) => sum + (parseFloat(o.resmasUsadas || 0)), 0);
            
            document.getElementById('graficaOrders').innerHTML = `
                <div style="background:#f8f9fa;padding:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;font-weight:bold;border-bottom:2px solid #ddd;">
                    <div>OP</div>
                    <div>Produto</div>
                    <div>Cliente</div>
                    <div>Papel</div>
                    <div>Gramatura</div>
                    <div style="text-align:right;">Resmas</div>
                </div>
                ${rows}
            `;
            
            document.getElementById('graficaTotais').innerHTML = `
                <div style="text-align:right;font-weight:bold;font-size:16px;padding:10px;background:#e9ecef;">
                    Total de Resmas: ${totalResmas.toLocaleString('pt-BR')}
                </div>
            `;
            
            document.getElementById('graficaModal').classList.add('active');
        }

        function closeGraficaModal() {
            document.getElementById('graficaModal').classList.remove('active');
        }

        function printGraficaReport() {
            window.print();
        }

        // === FAB ===
        function initFab() {
            const fab = document.getElementById('scrollFab');
            const ordersSection = document.getElementById('tab-list');
            
            function atTop() {
                return (window.scrollY || document.documentElement.scrollTop || 0) < 150;
            }
            
            function updateFab() {
                if (atTop()) {
                    fab.textContent = '📋';
                    fab.title = 'Ir para Ordens';
                } else {
                    fab.textContent = '⬆️';
                    fab.title = 'Voltar ao topo';
                }
            }
            
            fab.addEventListener('click', function() {
                if (atTop()) {
                    if (ordersSection) {
                        ordersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
            
            window.addEventListener('scroll', updateFab, { passive: true });
            updateFab();
        }

        // === INICIALIZAÇÃO ===
        async function initialize() {
            try {
                if (isFirebaseConnected) {
                    await loadDataFromFirebase();
                    setupFirebaseListeners();
                } else {
                    loadFromLocalStorage();
                }
                
                displayOrders();
                updateStats();
                loadTemplatesList();
                initFab();
                
                // Auto-save para localStorage
                if (!isFirebaseConnected) {
                    setInterval(() => {
                        if (orders.length > 0) saveToLocalStorage();
                    }, 30000);
                }

            } catch (error) {
                console.error('Erro na inicialização:', error);
                showNotification('Erro na inicialização. Alguns recursos podem não funcionar.', 'error');
            }
        }

        // Expor funções globalmente
        window.createOrder = createOrder;
        window.selectTemplate = selectTemplate;
        window.showTab = showTab;
        window.toggleSelectOrder = toggleSelectOrder;
        window.toggleSelectAll = toggleSelectAll;
        window.toggleViewMode = toggleViewMode;
        window.deleteOrder = deleteOrder;
        window.editOrder = editOrder;
        window.updateProcesses = updateProcesses;
        window.duplicateOrder = duplicateOrder;
        window.exportData = exportData;
        window.importData = importData;
        window.handleImport = handleImport;
        window.clearAllData = clearAllData;
        window.openSendToGraficaModal = openSendToGraficaModal;
        window.closeGraficaModal = closeGraficaModal;
        window.printGraficaReport = printGraficaReport;

        // Inicializar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        // Compatibilidade mobile - evitar zoom em inputs no iOS
        document.querySelectorAll('input, select, textarea, button').forEach(el => {
            if (el && el.style) el.style.fontSize = '16px';
        });

        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            const graficaModal = document.getElementById('graficaModal');
            if (event.target === graficaModal) {
                closeGraficaModal();
            }
        };

    </script>
</body>
</html>
