<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sistema de Ordem de Produ√ß√£o - Embalagens</title>
<style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        .header{background:rgba(255,255,255,.95);padding:20px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);text-align:center}
        .header h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;font-weight:700}
        .header p{color:#7f8c8d;font-size:1.2em}

        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px}
        .stat-card{background:rgba(255,255,255,.9);padding:20px;border-radius:10px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .stat-number{font-size:2.5em;font-weight:bold;margin-bottom:5px}
        .stat-label{color:#6c757d;font-size:.9em;text-transform:uppercase}

        /* === Novos Estilos para Interface Reorganizada === */
        .top-actions{background:rgba(255,255,255,.95);padding:15px 20px;border-radius:12px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,.1);}
        .action-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
        .action-buttons .btn{padding:10px 18px;font-size:14px;}
        
        .main-content-new{max-width:1200px;margin:0 auto;}
        .form-card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        
        /* Sistema de Abas */
        .form-tabs{display:flex;gap:0;margin-bottom:25px;background:#f1f3f4;border-radius:10px;padding:4px;overflow-x:auto;}
        .tab-btn{background:transparent;border:none;padding:12px 20px;border-radius:8px;font-weight:600;color:#6c757d;cursor:pointer;transition:all 0.3s ease;white-space:nowrap;flex:1;}
        .tab-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 12px rgba(102,126,234,.3);}
        .tab-btn:hover:not(.active){background:#e9ecef;color:#495057;}
        
        /* Conte√∫do das Abas */
        .tab-content{display:none;}
        .tab-content.active{display:block;animation:fadeIn 0.3s ease;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
        
        /* Status de Produ√ß√£o Compacto */
        .production-status{background:#f8f9ff;border:2px solid #e8f2ff;border-radius:10px;padding:15px;margin:15px 0;}
        .production-status h4{color:#2c3e50;margin-bottom:12px;font-size:16px;}
        .process-checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin-bottom:15px;}
        .checkbox-label{display:flex;align-items:center;gap:8px;color:#495057;font-weight:500;cursor:pointer;padding:8px;border-radius:6px;transition:background 0.3s;}
        .checkbox-label:hover{background:#e8f4fd;}
        .checkbox-label input[type="checkbox"]{transform:scale(1.2);}
        
        .process-flow-compact{display:flex;flex-wrap:wrap;gap:8px;}
        .process-flow-compact .process-step{padding:6px 12px;background:#e9ecef;border-radius:15px;font-size:12px;color:#495057;}
        
        /* Bot√£o de Criar Melhorado */
        .btn-create{width:100%;margin-top:25px;padding:15px;font-size:18px;font-weight:700;background:linear-gradient(135deg,#28a745 0%,#20c997 100%);border:none;border-radius:10px;color:white;box-shadow:0 8px 25px rgba(40,167,69,.3);transition:all 0.3s ease;}
        .btn-create:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(40,167,69,.4);}
        
        /* Layout Responsivo para Abas */
        @media (max-width:768px){
            .form-tabs{flex-direction:column;}
            .tab-btn{text-align:center;}
            .action-buttons{justify-content:stretch;}
            .action-buttons .btn{flex:1;}
            .process-checkboxes{grid-template-columns:1fr;}
        }
        .card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
        .card h2{color:#2c3e50;margin-bottom:20px;font-size:1.8em;display:flex;align-items:center;gap:10px}

        .form-group{margin-bottom:20px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
        .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#34495e}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 15px;border:2px solid #e0e6ed;border-radius:8px;font-size:16px;transition:all .3s ease;background:#f8f9fa}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
        .form-group textarea{height:100px;resize:vertical}

        .image-upload{border:3px dashed #ddd;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .3s ease;background:#f8f9fa}
        .image-upload:hover{border-color:#667eea;background:#f0f4ff}
        .image-upload.dragover{border-color:#667eea;background:#e8f2ff}
        .image-preview{max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}

        .product-selector{background:#e8f4fd;border:2px solid #74b9ff;border-radius:10px;padding:15px;margin-bottom:20px}
        .product-selector h3{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .product-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;max-height:200px;overflow-y:auto}
        .product-item{background:#fff;border:2px solid #e0e6ed;border-radius:8px;padding:12px;cursor:pointer;transition:all .3s ease}
        .product-item:hover{border-color:#667eea;background:#f8f9ff}
        .product-item.selected{border-color:#667eea;background:#e8f2ff}

        .template-actions{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        .btn{padding:12px 25px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}
        .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.3)}
        .btn-success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff}
        .btn-warning{background:linear-gradient(135deg,#ffeaa7 0%,#fab1a0 100%);color:#2d3436}
        .btn-danger{background:linear-gradient(135deg,#fd79a8 0%,#e84393 100%);color:#fff}
        .btn-info{background:linear-gradient(135deg,#74b9ff 0%,#0984e3 100%);color:#fff}
        .btn-secondary{background:linear-gradient(135deg,#636e72 0%,#2d3436 100%);color:#fff}
        .btn-small{padding:8px 15px;font-size:14px}

        .orders-list{grid-column:1 / -1}
        .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
        .filter-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .filter-controls select,.filter-controls input{padding:8px 12px;border:2px solid #e0e6ed;border-radius:6px;font-size:14px}

        .view-toggle{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
        .view-toggle .btn{padding:8px 14px;font-size:14px;}
        .view-toggle .btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%) !important;color:white !important;}

        .order-item{background:#fff;padding:20px;margin-bottom:15px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.08);border-left:5px solid #667eea}
        .order-item.priority-high{border-left-color:#e74c3c}
        .order-item.priority-medium{border-left-color:#f39c12}
        .order-item.priority-low{border-left-color:#27ae60}
        .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
        .order-id{font-weight:bold;color:#2c3e50;font-size:1.2em}
        .status{padding:5px 15px;border-radius:20px;font-weight:600;text-transform:uppercase;font-size:12px}
        .status.em-andamento{background:#ffeaa7;color:#2d3436}
        .status.finalizado{background:#55efc4;color:#2d3436}
        .priority{padding:3px 8px;border-radius:15px;font-size:11px;font-weight:600;text-transform:uppercase}
        .priority.alta{background:#ffebee;color:#c62828}
        .priority.media{background:#fff8e1;color:#f57c00}
        .priority.baixa{background:#e8f5e8;color:#2e7d32}

        .process-flow{display:flex;gap:10px;margin:10px 0;flex-wrap:wrap}
        .process-step{padding:6px 12px;background:#f8f9fa;border-radius:20px;font-size:13px;border:2px solid #e9ecef}
        .process-step.completed{background:#d4edda;border-color:#c3e6cb;color:#155724}
        .process-step.current{background:#fff3cd;border-color:#ffeaa7;color:#856404}

        .order-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:15px 0}
        .detail-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}
        .detail-label{font-weight:600;color:#6c757d}

        .order-images{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:15px 0}
        .order-image{text-align:center}
        .order-image img{max-width:100%;max-height:150px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.1)}

        .order-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .compact-item{padding:14px 16px;background:#fff;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.06);border-left:5px solid #667eea;margin-bottom:8px;transition:all 0.3s ease;position:relative;}
        .compact-item:hover{box-shadow:0 8px 25px rgba(0,0,0,.12);transform:translateY(-1px);}
        
        /* === SISTEMA DE CORES POR STATUS === */
        /* Status: Finalizado - VERDE */
        .compact-item.status-finalizado{border-left:5px solid #28a745;background:linear-gradient(135deg, rgba(40,167,69,0.05) 0%, rgba(32,201,151,0.08) 100%);}
        .compact-item.status-finalizado:hover{box-shadow:0 8px 25px rgba(40,167,69,.25);}
        
        /* Status: Em Andamento - LARANJA */
        .compact-item.status-em-andamento{border-left:5px solid #fd7e14;background:linear-gradient(135deg, rgba(253,126,20,0.05) 0%, rgba(255,193,7,0.08) 100%);}
        .compact-item.status-em-andamento:hover{box-shadow:0 8px 25px rgba(253,126,20,.25);}
        
        /* Selos de Status */
        .status-badge{position:absolute;top:10px;right:10px;padding:4px 12px;border-radius:15px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;z-index:10;}
        .status-badge.finalizado{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;box-shadow:0 3px 10px rgba(40,167,69,.3);}
        .status-badge.em-andamento{background:linear-gradient(135deg,#fd7e14 0%,#ffc107 100%);color:white;box-shadow:0 3px 10px rgba(253,126,20,.3);}
        
        /* Para cart√µes detalhados tamb√©m */
        .order-card.status-finalizado{border:2px solid #28a745;background:linear-gradient(135deg, rgba(40,167,69,0.03) 0%, rgba(32,201,151,0.05) 100%);}
        .order-card.status-em-andamento{border:2px solid #fd7e14;background:linear-gradient(135deg, rgba(253,126,20,0.03) 0%, rgba(255,193,7,0.05) 100%);}
        
        /* Status visual na meta-informa√ß√£o */
        .compact-meta .status-text.finalizado{color:#28a745;font-weight:700;}
        .compact-meta .status-text.em-andamento{color:#fd7e14;font-weight:700;}
        .compact-title{display:flex;gap:8px;align-items:center;font-weight:600;color:#2c3e50;}
        .compact-meta{font-size:12px;color:#6c757d;margin-top:4px;}
        .compact-expanded{margin-top:12px;border-top:1px dashed #e0e6ed;padding-top:12px;background:#f8f9ff;padding:15px;border-radius:8px;}
        
        /* Tags de Gr√°fica (Terceiriza√ß√£o) */
        .grafica-tag{background:#e8f4fd !important;color:#0984e3 !important;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px;margin-left:8px;box-shadow:0 2px 4px rgba(9,132,227,0.2);}
        .grafica-tag-detailed{background:#e8f4fd !important;color:#0984e3 !important;padding:4px 10px;border-radius:15px;font-size:12px;font-weight:bold;display:inline-flex;align-items:center;gap:4px;margin-left:8px;box-shadow:0 2px 6px rgba(9,132,227,0.3);}

        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5)}
        .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:15px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
        .modal-content.large{max-width:900px}
        .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
        .close:hover{color:#000}

        .print-preview{background:#fff;padding:30px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.1)}
        .print-header{text-align:center;margin-bottom:20px;border-bottom:3px solid #667eea;padding-bottom:12px}
        .print-images{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin:18px 0}
        .print-image{text-align:center}
        .print-image img{max-width:100%;max-height:300px;border:2px solid #ddd;border-radius:10px}

        .edit-form{background:#fff;padding:30px;border-radius:15px}
        .edit-form h2{color:#2c3e50;margin-bottom:25px;font-size:1.8em;text-align:center;border-bottom:2px solid #667eea;padding-bottom:15px}
        .edit-actions{display:flex;gap:15px;justify-content:center;margin-top:30px;padding-top:20px;border-top:1px solid #eee}
        .current-image-preview{max-width:150px;max-height:150px;border-radius:8px;margin:10px 0;border:2px solid #ddd}

        @media print{
            @page{size:A4 portrait;margin:10mm}
            *{-webkit-print-color-adjust:exact !important;color-adjust:exact !important;print-color-adjust:exact !important}
            body{background:#fff !important}
            .container,.header,.stats-row,.main-content,.orders-list,.modal-content>div:last-child{display:none !important}
            /* Esconder completamente o modal de gr√°fica durante impress√£o de OP */
            #graficaModal,#graficaModal *{display:none !important;visibility:hidden !important}
            /* Mostrar apenas o modal de impress√£o individual */
            #printModal{display:block !important;position:static !important;background:#fff !important;width:100% !important;height:auto !important}
            #printModal .modal-content{margin:0 !important;padding:0 !important;width:100% !important;max-width:100% !important;max-height:none !important;background:#fff !important;box-shadow:none !important;border-radius:0 !important}
            #printModal .print-preview{display:block !important;visibility:visible !important;padding:10px !important;margin:0 !important;background:#fff !important;box-shadow:none !important;border-radius:0 !important}
            .print-header h1,.print-header h2,.print-header p{color:#000 !important;margin:4px 0 !important}
            #printModal .print-preview,#printModal .print-preview *{break-inside:avoid-page !important;page-break-inside:avoid !important}
            #printModal .print-preview{font-size:13px !important;line-height:1.35 !important}
            #printModal .print-images img{max-height:220px !important}
            #printModal .print-images{gap:10px !important;margin:10px 0 !important}
            .close{display:none !important}
            #printModal .print-preview table{border-collapse:collapse !important;width:100% !important}
            #printModal .print-preview td{border-bottom:1px solid #ddd !important;padding:6px 0 !important}
        }

        @media (max-width:768px){
            .main-content-new{padding:0 10px;}
            .form-tabs{flex-direction:column;}
            .tab-btn{text-align:center;}
            .action-buttons{justify-content:stretch;flex-direction:column;}
            .action-buttons .btn{flex:1;margin-bottom:8px;}
            .process-checkboxes{grid-template-columns:1fr;}
            .form-row{grid-template-columns:1fr}
            .order-details{grid-template-columns:1fr}
            .order-images{grid-template-columns:1fr}
            .print-images{grid-template-columns:1fr}
            .stats-row{grid-template-columns:repeat(2,1fr)}
            .filter-controls{justify-content:center}
            .edit-actions{flex-direction:column;align-items:center}
            .product-list{grid-template-columns:1fr}
            .template-actions{justify-content:center}
        }

        .notification{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;color:#fff;font-weight:600;z-index:2000;transform:translateX(400px);transition:transform .3s ease}
        .notification.show{transform:translateX(0)}
        .notification.success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
        .notification.error{background:linear-gradient(135deg,#fd79a8 0%,#e84393 100%)}
        .notification.info{background:linear-gradient(135deg,#74b9ff 0%,#0984e3 100%)}
    
        /* === Bot√£o Flutuante (Topo/Ordens) === */
        :root{ --safe-bottom: env(safe-area-inset-bottom); }
        .fab{
            position:fixed; right:20px; bottom:calc(20px + var(--safe-bottom));
            width:56px; height:56px; border-radius:50%; border:none;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:#fff; font-size:22px; font-weight:700;
            display:flex; align-items:center; justify-content:center;
            box-shadow:0 12px 30px rgba(0,0,0,.25);
            cursor:pointer; z-index:2500;
            transition:transform .2s ease, box-shadow .2s ease, opacity .25s ease;
        }
        .fab:focus{outline:none; box-shadow:0 0 0 4px rgba(102,126,234,.25), 0 12px 30px rgba(0,0,0,.25)}
        @media (hover:hover){
            .fab:hover{transform:translateY(-3px); box-shadow:0 16px 32px rgba(0,0,0,.3)}
        }
        .fab.hide{opacity:0; pointer-events:none; transform:translateY(20px)}
        /* Ajustes mobile extras */
        html,body{-webkit-text-size-adjust:100%}
        .btn{min-height:44px}
        @media (max-width:480px){
            .container{padding:12px}
            .header h1{font-size:1.8em}
            .header p{font-size:1em}
            .btn{width:100%}
            .view-toggle{width:100%; justify-content:center}
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Sistema de Ordem de Produ√ß√£o</h1>
            <p>Gest√£o Completa de Embalagens em Papel Cart√£o</p>
        </div>

        <!-- Estat√≠sticas -->
        <div class="stats-row">
            <div class="stat-card"><div class="stat-number" style="color:#667eea;" id="totalOrders">0</div><div class="stat-label">Total de Ordens</div></div>
            <div class="stat-card"><div class="stat-number" style="color:#f39c12;" id="inProgressOrders">0</div><div class="stat-label">Em Andamento</div></div>
            <div class="stat-card"><div class="stat-number" style="color:#27ae60;" id="completedOrders">0</div><div class="stat-label">Finalizadas</div></div>
            <div class="stat-card"><div class="stat-number" style="color:#e74c3c;" id="totalProducts">0</div><div class="stat-label">Produtos √önicos</div></div>
        </div>

        <!-- Bot√µes de A√ß√£o R√°pida no Topo -->
        <div class="top-actions">
            <div class="action-buttons">
                <button class="btn btn-info" onclick="exportData()">üìÖ Exportar Dados</button>
                <button class="btn btn-warning" onclick="importData()">üìÖ Importar Dados</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpar Tudo</button>
                <button class="btn btn-secondary" onclick="manageTemplates()">üóä Gerenciar Modelos</button>
                <button class="btn btn-primary" onclick="testFirebaseConnection()">üî• Testar Firebase</button>
                <button class="btn btn-success" onclick="forceMigration()">üîÑ Migrar para Firebase</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
        </div>

        <div class="main-content-new">
            <div class="card form-card">
                <h2>üìù Nova Ordem de Produ√ß√£o</h2>

                <!-- Abas do Formul√°rio -->
                <div class="form-tabs">
                    <button class="tab-btn active" onclick="switchTab('basico')" type="button">1. üìÑ Informa√ß√µes B√°sicas</button>
                    <button class="tab-btn" onclick="switchTab('especificacoes')" type="button">2. üìÄ Especifica√ß√µes</button>
                    <button class="tab-btn" onclick="switchTab('producao')" type="button">3. üè≠ Produ√ß√£o</button>
                    <button class="tab-btn" onclick="switchTab('imagens')" type="button">4. üó∫ Imagens & Descri√ß√µes</button>
                </div>

                <form id="orderForm">
                    <!-- Aba 1: Informa√ß√µes B√°sicas -->
                    <div id="tab-basico" class="tab-content active">
                        <div class="product-selector">
                            <h3>üóÇÔ∏è Produtos Anteriores</h3>
                            <div class="template-actions">
                                <button type="button" class="btn btn-info btn-small" onclick="showProductHistory()">üìã Ver Hist√≥rico</button>
                                <button type="button" class="btn btn-warning btn-small" onclick="clearForm()">üóëÔ∏è Limpar Formul√°rio</button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="saveAsTemplate()">üíæ Salvar como Modelo</button>
                            </div>
                            <div id="productList" class="product-list" style="display:none;"></div>
                            <button type="button" id="clearSelectionBtn" class="clear-selection" onclick="clearSelection()" style="display:none;">‚ùå Limpar Sele√ß√£o</button>
                        </div>

                        <div class="form-group">
                            <label for="nomeTemplate">Nome do Produto (para hist√≥rico)</label>
                            <input type="text" id="nomeTemplate" placeholder="Ex: Caixa Pizza Grande, Sacola Kraft, etc." required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="medidasFolha">Medidas da Folha de Impress√£o</label>
                                <input type="text" id="medidasFolha" placeholder="Ex: 70x100cm" required>
                            </div>
                            <div class="form-group">
                                <label for="quantidade">Quantidade de Impress√£o</label>
                                <input type="number" id="quantidade" placeholder="1000" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" required>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Finalizado">Finalizado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="prioridade">Prioridade</label>
                                <select id="prioridade" required>
                                    <option value="M√©dia">M√©dia</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Aba 2: Especifica√ß√µes -->
                    <div id="tab-especificacoes" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formato">FORMATO</label>
                                <input type="text" id="formato" placeholder="">
                            </div>
                            <div class="form-group">
                                <label for="codigoFaca">C√≥digo da Faca</label>
                                <input type="text" id="codigoFaca" placeholder="Ex: FAC-1234">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tipoPapel">Tipo de Papel</label>
                                <input list="tipoPapelOptions" id="tipoPapel" placeholder="Digite ou selecione o tipo de papel" required>
                                <datalist id="tipoPapelOptions">
                                    <option value="Papel Kraft 66x96">
                                    <option value="Papel Kraft 77x113">
                                    <option value="papel duplex 66x96">
                                    <option value="papel duplex 77x113">
                                    <option value="papel triplex 66x96">
                                    <option value="papel triplex 77x113">
                                    <option value="Papel Couche 66x96">
                                    <option value="Papel Couche 77x113">
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label for="gramatura">Gramatura do Papel</label>
                                <input list="gramaturaOptions" id="gramatura" placeholder="Digite ou selecione a gramatura" required>
                                <datalist id="gramaturaOptions">
                                    <option value="70g">
                                    <option value="90g">
                                    <option value="170g">
                                    <option value="190g">
                                    <option value="210g">
                                    <option value="220g">
                                    <option value="225g">
                                    <option value="240g">
                                    <option value="250g">
                                    <option value="270g">
                                    <option value="300g">
                                    <option value="350g">
                                </datalist>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="impressao">Tipo de Impress√£o</label>
                                <select id="impressao" required>
                                    <option value="Frente 4x0">Frente 4x0</option>
                                    <option value="Frente e Verso 4x4">Frente e Verso 4x4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fornecedor">GR√ÅFICA</label>
                                <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                            </div>
                        </div>
                    </div>

                    <!-- Aba 3: Produ√ß√£o -->
                    <div id="tab-producao" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="folhasResma">Quantidade de folhas</label>
                                <input type="text" id="folhasResma" placeholder="Ex: 500 folhas (2 remas com 250)">
                            </div>
                            <div class="form-group">
                                <label for="resmasUsadas">Resmas utilizadas nesta ordem</label>
                                <input type="number" id="resmasUsadas" placeholder="Ex: 2" min="0" step="0.01">
                            </div>
                        </div>

                        <!-- Status de Produ√ß√£o -->
                        <div class="production-status">
                            <h4>üîÑ Status da Produ√ß√£o</h4>
                            <div class="process-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enviadoFaca">
                                    <span>Enviado para produ√ß√£o da faca</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enviadoChapa">
                                    <span>Enviado para gravar chapa</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enviadoImpressao">
                                    <span>Enviado para impress√£o</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Aba 4: Imagens & Descri√ß√µes -->
                    <div id="tab-imagens" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Imagem da Faca</label>
                                <div class="image-upload" onclick="document.getElementById('imagemFaca').click()">
                                    <input type="file" id="imagemFaca" accept="image/*" style="display:none;">
                                    <p>üìÅ Clique para selecionar a imagem da faca</p>
                                    <img id="previewFaca" class="image-preview" style="display:none;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Imagem da Montagem da Arte</label>
                                <div class="image-upload" onclick="document.getElementById('imagemArte').click()">
                                    <input type="file" id="imagemArte" accept="image/*" style="display:none;">
                                    <p>üé® Clique para selecionar a imagem da arte</p>
                                    <img id="previewArte" class="image-preview" style="display:none;">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="acabamento">Acabamento</label>
                            <textarea id="acabamento" placeholder="Descreva os acabamentos (quebras de linha ser√£o preservadas no PDF)" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="descricaoEmbalagens">Observa√ß√£o</label>
                            <textarea id="descricaoEmbalagens" placeholder="Observa√ß√µes gerais sobre a ordem de produ√ß√£o (formata√ß√£o preservada no PDF)" required></textarea>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-create">‚úÖ Criar Ordem de Produ√ß√£o</button>
                </form>
            </div>
        </div>

        <!-- Espa√ßamento entre se√ß√µes -->
        <div style="margin: 40px 0;"></div>

        <div class="card orders-list">>
            <div class="list-header">
                <h2>üìã Ordens de Produ√ß√£o</h2>
                <div class="view-toggle">
                    <button class="btn btn-secondary btn-small" id="btnLista" onclick="setViewMode('list')">Modo Lista</button>
                    <button class="btn btn-secondary btn-small" id="btnDetalhado" onclick="setViewMode('detailed')">Modo Detalhado</button>
                </div>
            <div class="template-actions">
                <button class="btn btn-info btn-small" onclick="openSendToGraficaModal()">üì¶ Enviar √† Gr√°fica</button>
                <button class="btn btn-secondary btn-small" onclick="toggleSelectAll()">‚òëÔ∏è Selecionar Todos</button>
            </div>
        
                <div class="filter-controls">
                    <select id="filterStatus" onchange="filterOrders()">
                        <option value="">Todos os Status</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Finalizado">Finalizado</option>
                    </select>
                    <select id="filterPriority" onchange="filterOrders()">
                        <option value="">Todas as Prioridades</option>
                        <option value="Alta">Alta</option>
                        <option value="M√©dia">M√©dia</option>
                        <option value="Baixa">Baixa</option>
                    </select>
                    <select id="filterGrafica" onchange="filterOrders()">
                        <option value="">Todas as Gr√°ficas</option>
                        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                    </select>
                    <input type="text" id="searchOrders" placeholder="Buscar por OP, produto, gr√°fica..." onkeyup="filterOrders()">
                </div>
            </div>
            <div id="ordersList"></div>
        </div>
    </div>

    <!-- Modal para impress√£o -->
    <div id="printModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePrintModal()">&times;</span>
            <div id="printContent" class="print-preview"></div>
            <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #ddd;">
                <button class="btn btn-primary" onclick="printOrder()">üñ®Ô∏è Imprimir Ordem</button>
                <button class="btn btn-warning" onclick="closePrintModal()">‚ùå Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para edi√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content large">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <div class="edit-form">
                <h2>‚úèÔ∏è Editar Ordem de Produ√ß√£o</h2>
                <form id="editForm">
                    <input type="hidden" id="editOrderId">

                    <div class="form-group">
                        <label for="editNomeTemplate">Nome do Produto</label>
                        <input type="text" id="editNomeTemplate" placeholder="Nome do produto" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editMedidasFolha">Medidas da Folha de Impress√£o</label>
                            <input type="text" id="editMedidasFolha" placeholder="Ex: 70x100cm" required>
                        </div>
                        <div class="form-group">
                            <label for="editQuantidade">Quantidade de Impress√£o</label>
                            <input type="number" id="editQuantidade" placeholder="1000" required>
                        </div>
                    </div>
        <div class="form-row">
            <div class="form-group">
                <label for="editFormato">FORMATO</label>
                <input type="text" id="editFormato" placeholder="Ex: Tampa e Base, Gaveta, Sacola, etc.">
            </div>
            <div class="form-group">
                <label for="editCodigoFaca">C√≥digo da Faca</label>
                <input type="text" id="editCodigoFaca" placeholder="Ex: FAC-1234">
            </div>
        </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column:1 / -1;">
                            <label for="editFolhasResma">Quantidade de folhas/resma</label>
                            <input type="text" id="editFolhasResma" placeholder="Ex: 500 folhas (2 remas com 250)">
                        </div>
                    </div>
        <div class="form-row">
            <div class="form-group" style="grid-column:1 / -1;">
                <label for="editResmasUsadas">Resmas utilizadas nesta ordem</label>
                <input type="number" id="editResmasUsadas" placeholder="Ex: 2" min="0" step="0.01">
            </div>
        </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFornecedor">Fornecedor (Terceiriza√ß√£o)</label>
                            <input type="text" id="editFornecedor" placeholder="Nome do fornecedor">
                        </div>
                        <div class="form-group">
                            <label for="editStatus">Status</label>
                            <select id="editStatus" required>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Finalizado">Finalizado</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTipoPapel">Tipo de Papel</label>
                            <input list="editTipoPapelOptions" id="editTipoPapel" placeholder="Digite ou selecione o tipo de papel" required>
                            <datalist id="editTipoPapelOptions">
                                <option value="Papel Kraft 66x96">
                                <option value="Papel Kraft 77x113">
                                <option value="papel duplex 66x96">
                                <option value="papel duplex 77x113">
                                <option value="papel triplex 66x96">
                                <option value="papel triplex 77x113">
                                <option value="Papel Couche 66x96">
                                <option value="Papel Couche 77x113">
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label for="editGramatura">Gramatura do Papel</label>
                            <input list="editGramaturaOptions" id="editGramatura" placeholder="Digite ou selecione a gramatura" required>
                            <datalist id="editGramaturaOptions">
                                <option value="70g">
                                <option value="90g">
                                <option value="170g">
                                <option value="190g">
                                <option value="210g">
                                <option value="220g">
                                <option value="225g">
                                <option value="240g">
                                <option value="250g">
                                <option value="270g">
                                <option value="300g">
                                <option value="350g">
                            </datalist>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editImpressao">Tipo de Impress√£o</label>
                            <select id="editImpressao" required>
                                <option value="Frente 4x0">Frente 4x0</option>
                                <option value="Frente e Verso 4x4">Frente e Verso 4x4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editPrioridade">Prioridade</label>
                            <select id="editPrioridade" required>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Alta">Alta</option>
                                <option value="Baixa">Baixa</option>
                            </select>
                        </div>
                    </div>

                    <!-- Pr√©-produ√ß√£o (edi√ß√£o) -->
                    <div class="form-row">
                        <div class="form-group">
                            <label><input type="checkbox" id="editEnviadoFaca"> Enviado para produ√ß√£o da faca</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="editEnviadoChapa"> Enviado para gravar chapa</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="grid-column:1 / -1;">
                            <label><input type="checkbox" id="editEnviadoImpressao"> Enviado para impress√£o</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editAcabamento">Acabamento</label>
                        <textarea id="editAcabamento" placeholder="Descreva os acabamentos necess√°rios" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editDescricaoEmbalagens">Observa√ß√£o</label>
                        <textarea id="editDescricaoEmbalagens" placeholder="Observa√ß√µes gerais sobre a ordem de produ√ß√£o" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Imagem da Faca</label>
                            <div id="currentImageFaca" style="text-align:center;margin:10px 0;"></div>
                            <div class="image-upload" onclick="document.getElementById('editImagemFaca').click()">
                                <input type="file" id="editImagemFaca" accept="image/*" style="display:none;">
                                <p>üìÅ Clique para alterar a imagem da faca</p>
                                <img id="editPreviewFaca" class="image-preview" style="display:none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Imagem da Montagem da Arte</label>
                            <div id="currentImageArte" style="text-align:center;margin:10px 0;"></div>
                            <div class="image-upload" onclick="document.getElementById('editImagemArte').click()">
                                <input type="file" id="editImagemArte" accept="image/*" style="display:none;">
                                <p>üé® Clique para alterar a imagem da arte</p>
                                <img id="editPreviewArte" class="image-preview" style="display:none;">
                            </div>
                        </div>
                    </div>

                    <div class="edit-actions">
                        <button type="submit" class="btn btn-success">üíæ Salvar Altera√ß√µes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para gerenciar modelos -->
    <div id="templatesModal" class="modal">
        <div class="modal-content large">
            <span class="close" onclick="closeTemplatesModal()">&times;</span>
            <div style="padding:20px;">
                <h2 style="text-align:center;margin-bottom:30px;">üóÇÔ∏è Gerenciar Modelos de Produtos</h2>
                <div id="templatesContent"></div>
                <div style="text-align:center;margin-top:20px;">
                    <button class="btn btn-warning" onclick="closeTemplatesModal()">‚ùå Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifica√ß√µes -->
    <div id="notification" class="notification"></div>

    <!-- Firebase Integration -->
    <script type="module">
        // Firebase SDKs (vers√£o modular via CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

        // Config do seu projeto Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBy0RGYoK3oFdFVnoVhG3dNva3BKbvCeUs",
            authDomain: "sistema-de-ordem-de-producao.firebaseapp.com",
            projectId: "sistema-de-ordem-de-producao",
            storageBucket: "sistema-de-ordem-de-producao.firebasestorage.app",
            messagingSenderId: "681409177091",
            appId: "1:681409177091:web:84fda4b78d4e4893dd9036"
        };

        document.addEventListener('alpine:init', () => {
            Alpine.data('orderSystem', () => ({
                // Configura√ß√£o do Firebase
                firebaseApp: null,
                firestore: null,
                auth: null,

                // Estado da aplica√ß√£o
                productionOrders: [],
                productTemplates: [],
                orderIdCounter: 1,
                isLoading: true,
                isMigrating: false,
                isTestingConnection: false,
                firebaseTestResult: '',
                showOrderForm: false,
                currentOrder: null,
                editingOrderId: null,
                searchTerm: '',
                isModalOpen: false,
                modalContent: '',
                modalTitle: '',
                isTemplateModalOpen: false,
                templateSearchTerm: '',
                selectedTemplate: null,
                showDeleteConfirmation: false,
                orderToDeleteId: null,
                showResetConfirmation: false,
                showMigrationConfirmation: false,
                showCustomActionConfirmation: false,
                customActionCallback: null,
                customActionMessage: '',
                showToast: false,
                toastMessage: '',
                toastType: 'info', // 'info', 'success', 'error'
                isSaveAsTemplateModalOpen: false,
                newTemplateName: '',
                isFirebaseIntegrated: false, // Novo estado para controlar a integra√ß√£o

                // Inicializa√ß√£o da aplica√ß√£o
                init() {
                    this.initializeApp();
                },

                async initializeApp() {
                    console.log("üî• Inicializando a aplica√ß√£o...");
                    try {
                        // Inicializa o Firebase e o Auth
                        this.firebaseApp = initializeApp(firebaseConfig);
                        this.firestore = getFirestore(this.firebaseApp);
                        this.auth = getAuth(this.firebaseApp);

                        console.log('üî• Inicializando autentica√ß√£o an√¥nima Firebase...');
                        await this.signInAnonymously();

                        console.log('üî• Executando migra√ß√£o do localStorage...');
                        await this.migrateFromLocalStorage();
                        this.isFirebaseIntegrated = true; // Marca a integra√ß√£o como conclu√≠da
                        console.log('üî• Firebase completamente integrado!');


                        // Carrega os dados iniciais ap√≥s a autentica√ß√£o e migra√ß√£o
                        await this.loadInitialData();

                        this.$watch('productionOrders', (newValue) => {
                            // O salvamento agora √© feito diretamente nas fun√ß√µes que modificam os dados
                        });
                        this.$watch('productTemplates', (newValue) => {
                            // O salvamento agora √© feito diretamente nas fun√ß√µes que modificam os dados
                        });
                        this.$watch('orderIdCounter', (newValue) => {
                            // O salvamento agora √© feito diretamente nas fun√ß√µes que modificam os dados
                        });

                    } catch (error) {
                        console.error("‚ùå Erro na inicializa√ß√£o do Firebase:", error);
                        this.showToast('Erro na inicializa√ß√£o do Firebase. Verifique o console.', 'error');
                    } finally {
                        this.isLoading = false;
                        console.log('[App] Sistema pronto.');
                    }
                },

                // Autentica√ß√£o
                async signInAnonymously() {
                    try {
                        const userCredential = await signInAnonymously(this.auth);
                        console.log(`üîê Usu√°rio autenticado: ${userCredential.user.uid}`);
                    } catch (error) {
                        console.error("‚ùå Erro na autentica√ß√£o an√¥nima:", error);
                        this.showToast('Falha na autentica√ß√£o com o Firebase.', 'error');
                    }
                },

                // Verifica√ß√£o de prontid√£o do Firebase
                get isFirebaseReady() {
                    // A verifica√ß√£o agora depende do estado de autentica√ß√£o
                    return this.auth && this.auth.currentUser;
                },

                // Fun√ß√µes de persist√™ncia de dados (agora com Firebase)
                async setJSON(key, value) {
                    if (!this.isFirebaseReady) {
                        const error = new ReferenceError("auth is not defined");
                        console.error(`setJSON error for key ${key}:`, error);
                        this.showToast(`Erro de Firebase: N√£o autenticado ao salvar ${key}.`, 'error');
                        return;
                    }
                    try {
                        const docRef = doc(this.firestore, "userData", this.auth.currentUser.uid);
                        await setDoc(docRef, {
                            [key]: JSON.stringify(value)
                        }, {
                            merge: true
                        });
                        // console.log(`‚úÖ Firebase set successful for key: ${key}`);
                    } catch (error) {
                        console.error(`‚ùå Firebase set error for key ${key}:`, error);
                        this.showToast(`Erro ao salvar "${key}" no Firebase.`, 'error');
                    }
                },

                async getJSON(key) {
                    if (!this.isFirebaseReady) {
                        const error = new ReferenceError("auth is not defined");
                        console.error(`getJSON error for key ${key}:`, error);
                        this.showToast(`Erro de Firebase: N√£o autenticado ao carregar ${key}.`, 'error');
                        return null;
                    }
                    try {
                        const docRef = doc(this.firestore, "userData", this.auth.currentUser.uid);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists() && docSnap.data()[key]) {
                            console.log(`‚úÖ Firebase get successful for key: ${key}`);
                            return JSON.parse(docSnap.data()[key]);
                        } else {
                            // console.log(`[Firebase] No data for key: ${key}`);
                            return null;
                        }
                    } catch (error) {
                        console.error(`‚ùå Firebase get error for key ${key}:`, error);
                        this.showToast(`Erro ao carregar "${key}" do Firebase.`, 'error');
                        return null;
                    }
                },

                // Carregamento de dados iniciais
                async loadInitialData() {
                    this.isLoading = true;
                    const orders = await this.getJSON('productionOrders');
                    if (orders) this.productionOrders = orders;

                    const templates = await this.getJSON('productTemplates');
                    if (templates) this.productTemplates = templates;

                    const counter = await this.getJSON('orderIdCounter');
                    if (counter) this.orderIdCounter = counter;
                    this.isLoading = false;
                },

                // Migra√ß√£o de localStorage para Firebase
                async migrateFromLocalStorage() {
                    console.log('üîÑ Iniciando verifica√ß√£o de migra√ß√£o...');
                    const migrated = localStorage.getItem('firebase_migrated');
                    if (migrated) {
                        console.log('‚úÖ Migra√ß√£o j√° realizada anteriormente.');
                        return;
                    }

                    const keysToMigrate = ['productionOrders', 'orderIdCounter', 'productTemplates'];
                    let migratedKeysCount = 0;

                    for (const key of keysToMigrate) {
                        const localData = localStorage.getItem(key);
                        if (localData) {
                            try {
                                const parsedData = JSON.parse(localData);
                                await this.setJSON(key, parsedData);
                                console.log(`[Migra√ß√£o] Key migrada: ${key}`);
                                // Opcional: remover a chave do localStorage ap√≥s a migra√ß√£o bem-sucedida
                                // localStorage.removeItem(key);
                                migratedKeysCount++;
                            } catch (e) {
                                console.error(`‚ùå Erro ao migrar a key ${key}:`, e);
                            }
                        }
                    }

                    if (migratedKeysCount > 0) {
                        console.log(`[Migra√ß√£o] Conclu√≠da. ${migratedKeysCount} keys migradas.`);
                    } else {
                        console.log('[Migra√ß√£o] Nenhuma key encontrada no localStorage para migrar.');
                    }

                    localStorage.setItem('firebase_migrated', 'true');
                },

                // Fun√ß√£o para for√ßar a migra√ß√£o (para fins de teste/bot√£o)
                async forceMigration() {
                    this.showCustomActionConfirmation(
                        'Tem certeza que deseja for√ßar a migra√ß√£o do localStorage para o Firebase? Isso pode sobrescrever dados existentes na nuvem se houver dados locais.',
                        async () => {
                            this.isMigrating = true;
                            this.showToast('Iniciando migra√ß√£o for√ßada...', 'info');
                            try {
                                localStorage.removeItem('firebase_migrated'); // Permite que a migra√ß√£o rode novamente
                                await this.migrateFromLocalStorage();
                                await this.loadInitialData(); // Recarrega os dados ap√≥s a migra√ß√£o
                                this.showToast('Migra√ß√£o for√ßada conclu√≠da com sucesso!', 'success');
                            } catch (error) {
                                console.error('‚ùå Erro na migra√ß√£o:', error);
                                this.showToast('Erro durante a migra√ß√£o for√ßada.', 'error');
                            } finally {
                                this.isMigrating = false;
                            }
                        }
                    );
                },

                // Teste de Conectividade com o Firebase
                async testFirebaseConnection() {
                    this.isTestingConnection = true;
                    this.firebaseTestResult = 'Testando...';
                    console.log('üî• Iniciando teste de conectividade Firebase...');

                    if (!this.isFirebaseReady) {
                        this.firebaseTestResult = '‚ùå Falha: Usu√°rio n√£o autenticado. Verifique a inicializa√ß√£o.';
                        console.error('‚ùå Erro no teste Firebase: Usu√°rio n√£o autenticado.');
                        this.isTestingConnection = false;
                        return;
                    }

                    try {
                        const testKey = `test_${Date.now()}`;
                        const testData = {
                            timestamp: new Date().toISOString()
                        };

                        // Testa a escrita
                        await this.setJSON(testKey, testData);
                        console.log('‚úÖ Teste de escrita OK.');

                        // Testa a leitura
                        const readData = await this.getJSON(testKey);
                        if (JSON.stringify(readData) === JSON.stringify(testData)) {
                            console.log('‚úÖ Teste de leitura OK.');
                            this.firebaseTestResult = '‚úÖ Sucesso! A conex√£o com o Firebase est√° funcionando.';
                            // Limpa o dado de teste
                            const docRef = doc(this.firestore, "userData", this.auth.currentUser.uid);
                            await updateDoc(docRef, {
                                [testKey]: deleteField()
                            });
                            console.log('üßπ Dado de teste removido.');
                        } else {
                            throw new Error('Os dados lidos n√£o correspondem aos dados escritos.');
                        }
                    } catch (error) {
                        console.error('‚ùå Erro no teste Firebase:', error);
                        this.firebaseTestResult = `‚ùå Falha no teste: ${error.message}`;
                    } finally {
                        this.isTestingConnection = false;
                    }
                },

                // Fun√ß√µes do aplicativo (CRUD de ordens, etc.)
                get filteredOrders() {
                    if (!this.searchTerm) {
                        return this.productionOrders;
                    }
                    return this.productionOrders.filter(order =>
                        order.customerName.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        order.productDescription.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        String(order.id).includes(this.searchTerm)
                    );
                },

                async compactAndSaveOrders() {
                    // Esta fun√ß√£o pode ser chamada periodicamente ou manualmente se necess√°rio
                    console.log('Compactando e salvando ordens...');
                    await this.setJSON('productionOrders', this.productionOrders);
                    this.showToast('Ordens de produ√ß√£o salvas e compactadas.', 'success');
                },

                async migrateAndCompactOrdersIfNeeded() {
                    const orders = await this.getJSON('productionOrders');
                    if (orders) {
                        this.productionOrders = orders;
                        // Simplesmente salvar novamente ir√° "compactar"
                        await this.setJSON('productionOrders', this.productionOrders);
                        console.log('[Migra√ß√£o] Ordens de produ√ß√£o carregadas e salvas no formato compacto.');
                    }
                },

                // Fun√ß√µes de UI
                openModal(title, content) {
                    this.modalTitle = title;
                    this.modalContent = content;
                    this.isModalOpen = true;
                },
                closeModal() {
                    this.isModalOpen = false;
                    this.modalContent = '';
                    this.modalTitle = '';
                },

                // Manipula√ß√£o de Templates de Produto
                openTemplateModal() {
                    this.isTemplateModalOpen = true;
                    this.templateSearchTerm = '';
                },
                closeTemplateModal() {
                    this.isTemplateModalOpen = false;
                    this.selectedTemplate = null;
                },

                async saveOrderAsTemplate() {
                    if (!this.newTemplateName.trim()) {
                        this.showToast('Por favor, insira um nome para o gabarito.', 'error');
                        return;
                    }
                    const newTemplate = {
                        id: Date.now(),
                        name: this.newTemplateName,
                        productDescription: this.currentOrder.productDescription,
                        materials: this.currentOrder.materials.map(m => ({ ...m
                        }))
                    };
                    this.productTemplates.push(newTemplate);
                    await this.setJSON('productTemplates', this.productTemplates); // Salva no Firebase
                    this.showToast('Gabarito salvo com sucesso!', 'success');
                    this.isSaveAsTemplateModalOpen = false;
                    this.newTemplateName = '';
                },

                async deleteTemplate(templateId) {
                    this.productTemplates = this.productTemplates.filter(t => t.id !== templateId);
                    await this.setJSON('productTemplates', this.productTemplates); // Salva no Firebase
                    this.showToast('Gabarito exclu√≠do.', 'info');
                },

                // Fun√ß√µes de Confirma√ß√£o
                confirmDelete(orderId) {
                    this.orderToDeleteId = orderId;
                    this.showDeleteConfirmation = true;
                },
                cancelDelete() {
                    this.showDeleteConfirmation = false;
                    this.orderToDeleteId = null;
                },
                async deleteConfirmed() {
                    if (this.orderToDeleteId !== null) {
                        this.deleteOrder(this.orderToDeleteId);
                        this.orderToDeleteId = null;
                    }
                    this.showDeleteConfirmation = false;
                },

                confirmReset() {
                    this.showResetConfirmation = true;
                },
                cancelReset() {
                    this.showResetConfirmation = false;
                },
                async resetConfirmed() {
                    this.productionOrders = [];
                    this.orderIdCounter = 1;
                    await this.setJSON('productionOrders', []);
                    await this.setJSON('orderIdCounter', 1);
                    this.showToast('Todos os dados foram apagados.', 'success');
                    this.showResetConfirmation = false;
                },

                showCustomActionConfirmation(message, callback) {
                    this.customActionMessage = message;
                    this.customActionCallback = callback;
                    this.showCustomActionConfirmation = true;
                },
                async customActionConfirmed() {
                    if (typeof this.customActionCallback === 'function') {
                        await this.customActionCallback();
                    }
                    this.showCustomActionConfirmation = false;
                    this.customActionCallback = null;
                },

                // Fun√ß√µes de Toast
                showToast(message, type = 'info') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },

                // Fun√ß√µes de importa√ß√£o/exporta√ß√£o
                handleExport() {
                    const dataStr = JSON.stringify({
                        productionOrders: this.productionOrders,
                        productTemplates: this.productTemplates,
                        orderIdCounter: this.orderIdCounter
                    }, null, 2);
                    const dataBlob = new Blob([dataStr], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `backup_ordens_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    this.showToast('Backup exportado com sucesso!', 'success');
                },

                handleImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const r = new FileReader();
                    r.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.productionOrders) {
                                this.productionOrders = data.productionOrders;
                                await this.setJSON('productionOrders', this.productionOrders);
                            }
                            if (data.productTemplates) {
                                this.productTemplates = data.productTemplates;
                                await this.setJSON('productTemplates', this.productTemplates);
                            }
                            if (data.orderIdCounter) {
                                this.orderIdCounter = data.orderIdCounter;
                                await this.setJSON('orderIdCounter', this.orderIdCounter);
                            }
                            this.showToast('Backup importado e salvo com sucesso!', 'success');
                        } catch (err) {
                            this.showToast('Erro ao importar o arquivo. Verifique o formato.', 'error');
                            console.error(err);
                        }
                    };
                    r.readAsText(file);
                    event.target.value = ''; // Limpa o input para permitir re-importar o mesmo arquivo
                },

                // Fun√ß√µes CRUD para Ordens de Produ√ß√£o
                async addOrder(orderData) {
                    const newOrder = {
                        ...orderData,
                        id: this.orderIdCounter++,
                        status: 'Em Andamento',
                        createdAt: new Date().toISOString()
                    };
                    this.productionOrders.unshift(newOrder);
                    await this.setJSON('productionOrders', this.productionOrders);
                    await this.setJSON('orderIdCounter', this.orderIdCounter);
                    this.showToast('Ordem de produ√ß√£o criada com sucesso!', 'success');
                },

                async updateOrder(orderId, updatedData) {
                    const index = this.productionOrders.findIndex(o => o.id === orderId);
                    if (index !== -1) {
                        this.productionOrders[index] = { ...this.productionOrders[index], ...updatedData };
                        await this.setJSON('productionOrders', this.productionOrders);
                        this.showToast(`Ordem #${orderId} atualizada.`, 'success');
                    }
                },

                async deleteOrder(orderId) {
                    this.productionOrders = this.productionOrders.filter(o => o.id !== orderId);
                    await this.setJSON('productionOrders', this.productionOrders);
                    this.showToast(`Ordem #${orderId} exclu√≠da.`, 'info');
                },
            }));
        });

        // Fun√ß√µes globais que interagem com o Alpine.js
        function getAlpineComponent() {
            return document.querySelector('[x-data]').__x;
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const alpine = getAlpineComponent();
            // L√≥gica para coletar dados do formul√°rio e chamar alpine.addOrder(...)
            // Esta parte precisa ser implementada para coletar os dados dos inputs do formul√°rio principal
            alpine.showToast('Fun√ß√£o de criar ordem a ser implementada.', 'info');
        }

        function handleEditFormSubmit(event) {
            event.preventDefault();
            const alpine = getAlpineComponent();
            const orderId = parseInt(document.getElementById('editOrderId').value);
            // L√≥gica para coletar dados do formul√°rio de edi√ß√£o e chamar alpine.updateOrder(...)
            // Esta parte precisa ser implementada para coletar os dados dos inputs do formul√°rio de edi√ß√£o
            alpine.updateOrder(orderId, { /* ... dados atualizados ... */ });
            closeEditModal();
        }

        function openEditModal(orderId) {
            const alpine = getAlpineComponent();
            const order = alpine.productionOrders.find(o => o.id === orderId);
            if (order) {
                // Preenche o formul√°rio de edi√ß√£o
                document.getElementById('editOrderId').value = order.id;
                // ... preencher outros campos ...
                document.getElementById('editModal').style.display = 'block';
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function filterOrders() {
            const alpine = getAlpineComponent();
            alpine.searchTerm = document.getElementById('searchOrders').value;
            // Adicionar l√≥gica para filtros de status e prioridade se necess√°rio
        }

        function setViewMode(mode) {
            // L√≥gica para alternar a visualiza√ß√£o
            console.log(`Modo de visualiza√ß√£o: ${mode}`);
        }

        function openSendToGraficaModal() {
            getAlpineComponent().showToast('Fun√ß√£o "Enviar √† Gr√°fica" a ser implementada.', 'info');
        }

        function toggleSelectAll() {
            getAlpineComponent().showToast('Fun√ß√£o "Selecionar Todos" a ser implementada.', 'info');
        }

        function openPrintModal(orderId) {
            // L√≥gica para preparar o conte√∫do de impress√£o
            document.getElementById('printModal').style.display = 'block';
        }

        function closePrintModal() {
            document.getElementById('printModal').style.display = 'none';
        }

        function printOrder() {
            window.print();
        }

        function openTemplatesModal() {
            document.getElementById('templatesModal').style.display = 'block';
        }

        function closeTemplatesModal() {
            document.getElementById('templatesModal').style.display = 'none';
        }

        // A fun√ß√£o handleImport j√° est√° no componente Alpine, mas se for chamada globalmente, precisa de um wrapper
        function handleImport(event) {
            getAlpineComponent().handleImport(event);
        }

        function handleExport() {
            getAlpineComponent().handleExport();
        }

        function forceMigration() {
            getAlpineComponent().forceMigration();
        }

        function testFirebaseConnection() {
            getAlpineComponent().testFirebaseConnection();
        }

        function resetAllData() {
            getAlpineComponent().confirmReset();
        }
    </script>
</body>

</html>

<!--
‚úÖ FIREBASE CONFIGURADO COM AUTENTICA√á√ÉO AN√îNIMA!

Use estas regras no Console Firebase > Firestore Database > Rules:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/kv/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}

STATUS DA CONFIGURA√á√ÉO:
‚úÖ Authentication > Anonymous ATIVADO
‚úÖ UID do usu√°rio: CzMPNICV7pfc9s5TGt2tK99Y64l2

PR√ìXIMOS PASSOS:
1. Cole as regras acima no Firebase Console > Firestore Database > Rules
2. Clique em "Publicar"
3. Teste o bot√£o "üî• Testar Firebase"
4. Teste o bot√£o "üîÑ Migrar para Firebase"

ESTRUTURA DOS DADOS NO FIRESTORE:
users/CzMPNICV7pfc9s5TGt2tK99Y64l2/kv/productionOrders = array de ordens
users/CzMPNICV7pfc9s5TGt2tK99Y64l2/kv/productTemplates = array de templates  
users/CzMPNICV7pfc9s5TGt2tK99Y64l2/kv/orderIdCounter = n√∫mero
users/CzMPNICV7pfc9s5TGt2tK99Y64l2/kv/migrated_flag = boolean (controle interno)
-->
