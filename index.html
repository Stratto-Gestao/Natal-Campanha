    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
        <title>Sistema de Ordem de Produ√ß√£o - Embalagens</title>
    <style>
            *{margin:0;padding:0;box-sizing:border-box}
            body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
            .container{max-width:1400px;margin:0 auto;padding:20px}
            .header{background:rgba(255,255,255,.95);padding:20px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);text-align:center}
            .header h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;font-weight:700}
            .header p{color:#7f8c8d;font-size:1.2em}

            .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px}
            .stat-card{background:rgba(255,255,255,.9);padding:20px;border-radius:10px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.1)}
            .stat-number{font-size:2.5em;font-weight:bold;margin-bottom:5px}
            .stat-label{color:#6c757d;font-size:.9em;text-transform:uppercase}

            /* === Novos Estilos para Interface Reorganizada === */
            .top-actions{background:rgba(255,255,255,.95);padding:15px 20px;border-radius:12px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,.1);}
            .action-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
            .action-buttons .btn{padding:10px 18px;font-size:14px;}
            
            .main-content-new{max-width:1200px;margin:0 auto;}
            .form-card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
            
            /* Sistema de Abas */
            .form-tabs{display:flex;gap:0;margin-bottom:25px;background:#f1f3f4;border-radius:10px;padding:4px;overflow-x:auto;}
            .tab-btn{background:transparent;border:none;padding:12px 20px;border-radius:8px;font-weight:600;color:#6c757d;cursor:pointer;transition:all 0.3s ease;white-space:nowrap;flex:1;}
            .tab-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 12px rgba(102,126,234,.3);}
            .tab-btn:hover:not(.active){background:#e9ecef;color:#495057;}
            
            /* Conte√∫do das Abas */
            .tab-content{display:none;}
            .tab-content.active{display:block;animation:fadeIn 0.3s ease;}
            @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
            
            /* Status de Produ√ß√£o Compacto */
            .production-status{background:#f8f9ff;border:2px solid #e8f2ff;border-radius:10px;padding:15px;margin:15px 0;}
            .production-status h4{color:#2c3e50;margin-bottom:12px;font-size:16px;}
            .process-checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin-bottom:15px;}
            .checkbox-label{display:flex;align-items:center;gap:8px;color:#495057;font-weight:500;cursor:pointer;padding:8px;border-radius:6px;transition:background 0.3s;}
            .checkbox-label:hover{background:#e8f4fd;}
            .checkbox-label input[type="checkbox"]{transform:scale(1.2);}
            
            .process-flow-compact{display:flex;flex-wrap:wrap;gap:8px;}
            .process-flow-compact .process-step{padding:6px 12px;background:#e9ecef;border-radius:15px;font-size:12px;color:#495057;}
            
            /* Bot√£o de Criar Melhorado */
            .btn-create{width:100%;margin-top:25px;padding:15px;font-size:18px;font-weight:700;background:linear-gradient(135deg,#28a745 0%,#20c997 100%);border:none;border-radius:10px;color:white;box-shadow:0 8px 25px rgba(40,167,69,.3);transition:all 0.3s ease;}
            .btn-create:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(40,167,69,.4);}
            
            /* Layout Responsivo para Abas */
            @media (max-width:768px){
                .form-tabs{flex-direction:column;}
                .tab-btn{text-align:center;}
                .action-buttons{justify-content:stretch;}
                .action-buttons .btn{flex:1;}
                .process-checkboxes{grid-template-columns:1fr;}
            }
            .card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
            .card h2{color:#2c3e50;margin-bottom:20px;font-size:1.8em;display:flex;align-items:center;gap:10px}

            .form-group{margin-bottom:20px}
            .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
            .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#34495e}
            .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 15px;border:2px solid #e0e6ed;border-radius:8px;font-size:16px;transition:all .3s ease;background:#f8f9fa}
            .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
            .form-group textarea{height:100px;resize:vertical}

            .image-upload{border:3px dashed #ddd;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .3s ease;background:#f8f9fa}
            .image-upload:hover{border-color:#667eea;background:#f0f4ff}
            .image-upload.dragover{border-color:#667eea;background:#e8f2ff}
            .image-preview{max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}

            .product-selector{background:#e8f4fd;border:2px solid #74b9ff;border-radius:10px;padding:15px;margin-bottom:20px}
            .product-selector h3{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
            .product-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;max-height:200px;overflow-y:auto}
            .product-item{background:#fff;border:2px solid #e0e6ed;border-radius:8px;padding:12px;cursor:pointer;transition:all .3s ease}
            .product-item:hover{border-color:#667eea;background:#f8f9ff}
            .product-item.selected{border-color:#667eea;background:#e8f2ff}

            .template-actions{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
            .btn{padding:12px 25px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}
            .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
            .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.3)}
            .btn-success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff}
            .btn-warning{background:linear-gradient(135deg,#ffeaa7 0%,#fab1a0 100%);color:#2d3436}
            .btn-danger{background:linear-gradient(135deg,#fd79a8 0%,#e84393 100%);color:#fff}
            .btn-info{background:linear-gradient(135deg,#74b9ff 0%,#0984e3 100%);color:#fff}
            .btn-secondary{background:linear-gradient(135deg,#636e72 0%,#2d3436 100%);color:#fff}
            .btn-small{padding:8px 15px;font-size:14px}

            .orders-list{grid-column:1 / -1}
            .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
            .filter-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
            .filter-controls select,.filter-controls input{padding:8px 12px;border:2px solid #e0e6ed;border-radius:6px;font-size:14px}

            .view-toggle{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
            .view-toggle .btn{padding:8px 14px;font-size:14px;}
            .view-toggle .btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%) !important;color:white !important;}

            .order-item{background:#fff;padding:20px;margin-bottom:15px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.08);border-left:5px solid #667eea}
            .order-item.priority-high{border-left-color:#e74c3c}
            .order-item.priority-medium{border-left-color:#f39c12}
            .order-item.priority-low{border-left-color:#27ae60}
            .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
            .order-id{font-weight:bold;color:#2c3e50;font-size:1.2em}
            .status{padding:5px 15px;border-radius:20px;font-weight:600;text-transform:uppercase;font-size:12px}
            .status.em-andamento{background:#ffeaa7;color:#2d3436}
            .status.finalizado{background:#55efc4;color:#2d3436}
            .priority{padding:3px 8px;border-radius:15px;font-size:11px;font-weight:600;text-transform:uppercase}
            .priority.alta{background:#ffebee;color:#c62828}
            .priority.media{background:#fff8e1;color:#f57c00}
            .priority.baixa{background:#e8f5e8;color:#2e7d32}

            .process-flow{display:flex;gap:10px;margin:10px 0;flex-wrap:wrap}
            .process-step{padding:6px 12px;background:#f8f9fa;border-radius:20px;font-size:13px;border:2px solid #e9ecef}
            .process-step.completed{background:#d4edda;border-color:#c3e6cb;color:#155724}
            .process-step.current{background:#fff3cd;border-color:#ffeaa7;color:#856404}

            .order-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:15px 0}
            .detail-item{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
            .detail-label{font-weight:600;color:#6c757d;margin-right:2px}

            .order-images{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:15px 0}
            .order-image{text-align:center}
            .order-image img{max-width:100%;max-height:150px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.1)}

            .order-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
            .compact-item{padding:14px 16px;background:#fff;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.06);border-left:5px solid #667eea;margin-bottom:8px;transition:all 0.3s ease;position:relative;}
            .compact-item:hover{box-shadow:0 8px 25px rgba(0,0,0,.12);transform:translateY(-1px);}
            
            /* === SISTEMA DE CORES POR STATUS === */
            /* Status: Finalizado - VERDE */
            .compact-item.status-finalizado{border-left:5px solid #28a745;background:linear-gradient(135deg, rgba(40,167,69,0.05) 0%, rgba(32,201,151,0.08) 100%);}
            .compact-item.status-finalizado:hover{box-shadow:0 8px 25px rgba(40,167,69,.25);}
            
            /* Status: Em Andamento - LARANJA */
            .compact-item.status-em-andamento{border-left:5px solid #fd7e14;background:linear-gradient(135deg, rgba(253,126,20,0.05) 0%, rgba(255,193,7,0.08) 100%);}
            .compact-item.status-em-andamento:hover{box-shadow:0 8px 25px rgba(253,126,20,.25);}
            
            /* Selos de Status */
            .status-badge{position:absolute;top:10px;right:10px;padding:4px 12px;border-radius:15px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;z-index:10;}
            .status-badge.finalizado{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;box-shadow:0 3px 10px rgba(40,167,69,.3);}
            .status-badge.em-andamento{background:linear-gradient(135deg,#fd7e14 0%,#ffc107 100%);color:white;box-shadow:0 3px 10px rgba(253,126,20,.3);}
            
            /* Para cart√µes detalhados tamb√©m */
            .order-card.status-finalizado{border:2px solid #28a745;background:linear-gradient(135deg, rgba(40,167,69,0.03) 0%, rgba(32,201,151,0.05) 100%);}
            .order-card.status-em-andamento{border:2px solid #fd7e14;background:linear-gradient(135deg, rgba(253,126,20,0.03) 0%, rgba(255,193,7,0.05) 100%);}
            
            /* Status visual na meta-informa√ß√£o */
            .compact-meta .status-text.finalizado{color:#28a745;font-weight:700;}
            .compact-meta .status-text.em-andamento{color:#fd7e14;font-weight:700;}
            .compact-title{display:flex;gap:8px;align-items:center;font-weight:600;color:#2c3e50;}
            .compact-meta{font-size:12px;color:#6c757d;margin-top:4px;}
            .compact-expanded{margin-top:12px;border-top:1px dashed #e0e6ed;padding-top:12px;background:#f8f9ff;padding:15px;border-radius:8px;}
            
            /* Tags de Gr√°fica (Terceiriza√ß√£o) */
            .grafica-tag{background:#e8f4fd !important;color:#0984e3 !important;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px;margin-left:8px;box-shadow:0 2px 4px rgba(9,132,227,0.2);}
            .grafica-tag-detailed{background:#e8f4fd !important;color:#0984e3 !important;padding:4px 10px;border-radius:15px;font-size:12px;font-weight:bold;display:inline-flex;align-items:center;gap:4px;margin-left:8px;box-shadow:0 2px 6px rgba(9,132,227,0.3);}

            .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5)}
            .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:15px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
            .modal-content.large{max-width:900px}
            .modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:15px 15px 0 0;margin:-20px -20px 20px -20px;}
            .modal-header h2{margin:0;color:#fff;}
            .modal-header .close{color:#fff;}
            #bulkProductionStatusModal .modal-content{max-width:800px;}
            .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
            .close:hover{color:#000}

            .print-preview{background:#fff;padding:30px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.1)}
            .print-header{text-align:center;margin-bottom:20px;border-bottom:3px solid #667eea;padding-bottom:12px}
            .print-images{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin:18px 0}
            .print-image{text-align:center}
            .print-image img{max-width:100%;max-height:300px;border:2px solid #ddd;border-radius:10px}

            .edit-form{background:#fff;padding:30px;border-radius:15px}
            .edit-form h2{color:#2c3e50;margin-bottom:25px;font-size:1.8em;text-align:center;border-bottom:2px solid #667eea;padding-bottom:15px}
            .edit-actions{display:flex;gap:15px;justify-content:center;margin-top:30px;padding-top:20px;border-top:1px solid #eee}
            .current-image-preview{max-width:150px;max-height:150px;border-radius:8px;margin:10px 0;border:2px solid #ddd}

            @media print{
                @page{size:A4 portrait;margin:10mm}
                *{-webkit-print-color-adjust:exact !important;color-adjust:exact !important;print-color-adjust:exact !important}
                body{background:#fff !important}
                .container,.header,.stats-row,.main-content,.orders-list,.modal-content>div:last-child{display:none !important}
                /* Esconder completamente o modal de gr√°fica durante impress√£o de OP */
                #graficaModal,#graficaModal *{display:none !important;visibility:hidden !important}
                /* Mostrar apenas o modal de impress√£o individual */
                #printModal{display:block !important;position:static !important;background:#fff !important;width:100% !important;height:auto !important}
                #printModal .modal-content{margin:0 !important;padding:0 !important;width:100% !important;max-width:100% !important;max-height:none !important;background:#fff !important;box-shadow:none !important;border-radius:0 !important}
                #printModal .print-preview{display:block !important;visibility:visible !important;padding:10px !important;margin:0 !important;background:#fff !important;box-shadow:none !important;border-radius:0 !important}
                .print-header h1,.print-header h2,.print-header p{color:#000 !important;margin:4px 0 !important}
                #printModal .print-preview,#printModal .print-preview *{break-inside:avoid-page !important;page-break-inside:avoid !important}
                #printModal .print-preview{font-size:13px !important;line-height:1.35 !important}
                #printModal .print-images img{max-height:220px !important}
                #printModal .print-images{gap:10px !important;margin:10px 0 !important}
                .close{display:none !important}
                #printModal .print-preview table{border-collapse:collapse !important;width:100% !important}
                #printModal .print-preview td{border-bottom:1px solid #ddd !important;padding:6px 0 !important}
            }

            @media (max-width:768px){
                .main-content-new{padding:0 10px;}
                .form-tabs{flex-direction:column;}
                .tab-btn{text-align:center;}
                .action-buttons{justify-content:stretch;flex-direction:column;}
                .action-buttons .btn{flex:1;margin-bottom:8px;}
                .process-checkboxes{grid-template-columns:1fr;}
                .form-row{grid-template-columns:1fr}
                .order-details{grid-template-columns:1fr}
                .order-images{grid-template-columns:1fr}
                .print-images{grid-template-columns:1fr}
                .stats-row{grid-template-columns:repeat(2,1fr)}
                .filter-controls{justify-content:center}
                .edit-actions{flex-direction:column;align-items:center}
                .product-list{grid-template-columns:1fr}
                .template-actions{justify-content:center}
            }

            .notification{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;color:#fff;font-weight:600;z-index:2000;transform:translateX(400px);transition:transform .3s ease}
            .notification.show{transform:translateX(0)}
            .notification.success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
            .notification.error{background:linear-gradient(135deg,#fd79a8 0%,#e84393 100%)}
            .notification.info{background:linear-gradient(135deg,#74b9ff 0%,#0984e3 100%)}
        
            /* === Bot√£o Flutuante (Topo/Ordens) === */
            :root{ --safe-bottom: env(safe-area-inset-bottom); }
            .fab{
                position:fixed; right:20px; bottom:calc(20px + var(--safe-bottom));
                width:56px; height:56px; border-radius:50%; border:none;
                background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                color:#fff; font-size:22px; font-weight:700;
                display:flex; align-items:center; justify-content:center;
                box-shadow:0 12px 30px rgba(0,0,0,.25);
                cursor:pointer; z-index:2500;
                transition:transform .2s ease, box-shadow .2s ease, opacity .25s ease;
            }
            .fab:focus{outline:none; box-shadow:0 0 0 4px rgba(102,126,234,.25), 0 12px 30px rgba(0,0,0,.25)}
            @media (hover:hover){
                .fab:hover{transform:translateY(-3px); box-shadow:0 16px 32px rgba(0,0,0,.3)}
            }
            .fab.hide{opacity:0; pointer-events:none; transform:translateY(20px)}
            /* Ajustes mobile extras */
            html,body{-webkit-text-size-adjust:100%}
            .btn{min-height:44px}
            @media (max-width:480px){
                .container{padding:12px}
                .header h1{font-size:1.8em}
                .header p{font-size:1em}
                .btn{width:100%}
                .view-toggle{width:100%; justify-content:center}
            }

        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üè≠ Sistema de Ordem de Produ√ß√£o</h1>
                <p>Gest√£o Completa de Embalagens em Papel Cart√£o</p>
            </div>

            <!-- Estat√≠sticas -->
            <div class="stats-row">
                <div class="stat-card"><div class="stat-number" style="color:#667eea;" id="totalOrders">0</div><div class="stat-label">Total de Ordens</div></div>
                <div class="stat-card"><div class="stat-number" style="color:#f39c12;" id="inProgressOrders">0</div><div class="stat-label">Em Andamento</div></div>
                <div class="stat-card"><div class="stat-number" style="color:#27ae60;" id="completedOrders">0</div><div class="stat-label">Finalizadas</div></div>
                <div class="stat-card"><div class="stat-number" style="color:#e74c3c;" id="totalProducts">0</div><div class="stat-label">Produtos √önicos</div></div>
            </div>

            <!-- Bot√µes de A√ß√£o R√°pida no Topo -->
            <div class="top-actions">
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="exportData()">üìÖ Exportar Dados</button>
                    <button class="btn btn-warning" onclick="importData()">üìÖ Importar Dados</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpar Tudo</button>
                    <button class="btn btn-secondary" onclick="manageTemplates()">üóä Gerenciar Modelos</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
            </div>

            <div class="main-content-new">
                <div class="card form-card">
                    <h2>üìù Nova Ordem de Produ√ß√£o</h2>

                    <!-- Abas do Formul√°rio -->
                    <div class="form-tabs">
                        <button class="tab-btn active" onclick="switchTab('basico')" type="button">1. üìÑ Informa√ß√µes B√°sicas</button>
                        <button class="tab-btn" onclick="switchTab('especificacoes')" type="button">2. üìÄ Especifica√ß√µes</button>
                        <button class="tab-btn" onclick="switchTab('producao')" type="button">3. üè≠ Produ√ß√£o</button>
                        <button class="tab-btn" onclick="switchTab('imagens')" type="button">4. üó∫ Imagens & Descri√ß√µes</button>
                    </div>

                    <form id="orderForm">
                        <!-- Aba 1: Informa√ß√µes B√°sicas -->
                        <div id="tab-basico" class="tab-content active">
                            <div class="product-selector">
                                <h3>üóÇÔ∏è Produtos Anteriores</h3>
                                <div class="template-actions">
                                    <button type="button" class="btn btn-info btn-small" onclick="showProductHistory()">üìã Ver Hist√≥rico</button>
                                    <button type="button" class="btn btn-warning btn-small" onclick="clearForm()">üóëÔ∏è Limpar Formul√°rio</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="saveAsTemplate()">üíæ Salvar como Modelo</button>
                                </div>
                                <div id="productList" class="product-list" style="display:none;"></div>
                                <button type="button" id="clearSelectionBtn" class="clear-selection" onclick="clearSelection()" style="display:none;">‚ùå Limpar Sele√ß√£o</button>
                            </div>

                            <div class="form-group">
                                <label for="nomeTemplate">Nome do Produto (para hist√≥rico)</label>
                                <input type="text" id="nomeTemplate" placeholder="Ex: Caixa Pizza Grande, Sacola Kraft, etc." required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="medidasFolha">Medidas da Folha de Impress√£o</label>
                                    <input type="text" id="medidasFolha" placeholder="Ex: 70x100cm" required>
                                </div>
                                <div class="form-group">
                                    <label for="quantidade">Quantidade de Impress√£o</label>
                                    <input type="number" id="quantidade" placeholder="1000" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" required>
                                        <option value="Em Andamento">Em Andamento</option>
                                        <option value="Finalizado">Finalizado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="prioridade">Prioridade</label>
                                    <select id="prioridade" required>
                                        <option value="M√©dia">M√©dia</option>
                                        <option value="Alta">Alta</option>
                                        <option value="Baixa">Baixa</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Aba 2: Especifica√ß√µes -->
                        <div id="tab-especificacoes" class="tab-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="formato">FORMATO</label>
                                    <input type="text" id="formato" placeholder="">
                                </div>
                                <div class="form-group">
                                    <label for="codigoFaca">C√≥digo da Faca</label>
                                    <input type="text" id="codigoFaca" placeholder="Ex: FAC-1234">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="tipoPapel">Tipo de Papel</label>
                                    <input list="tipoPapelOptions" id="tipoPapel" placeholder="Digite ou selecione o tipo de papel" required>
                                    <datalist id="tipoPapelOptions">
                                        <option value="Papel Kraft 66x96">
                                        <option value="Papel Kraft 77x113">
                                        <option value="papel duplex 66x96">
                                        <option value="papel duplex 77x113">
                                        <option value="papel triplex 66x96">
                                        <option value="papel triplex 77x113">
                                        <option value="Papel Couche 66x96">
                                        <option value="Papel Couche 77x113">
                                    </datalist>
                                </div>
                                <div class="form-group">
                                    <label for="gramatura">Gramatura do Papel</label>
                                    <input list="gramaturaOptions" id="gramatura" placeholder="Digite ou selecione a gramatura" required>
                                    <datalist id="gramaturaOptions">
                                        <option value="70g">
                                        <option value="90g">
                                        <option value="170g">
                                        <option value="190g">
                                        <option value="210g">
                                        <option value="220g">
                                        <option value="225g">
                                        <option value="240g">
                                        <option value="250g">
                                        <option value="270g">
                                        <option value="300g">
                                        <option value="350g">
                                    </datalist>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="impressao">Tipo de Impress√£o</label>
                                    <select id="impressao" required>
                                        <option value="Frente 4x0">Frente 4x0</option>
                                        <option value="Frente e Verso 4x4">Frente e Verso 4x4</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="fornecedor">GR√ÅFICA</label>
                                    <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                                </div>
                            </div>
                        </div>

                        <!-- Aba 3: Produ√ß√£o -->
                        <div id="tab-producao" class="tab-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="folhasResma">Quantidade de folhas</label>
                                    <input type="text" id="folhasResma" placeholder="Ex: 500 folhas (2 remas com 250)">
                                </div>
                                <div class="form-group">
                                    <label for="resmasUsadas">Resmas utilizadas nesta ordem</label>
                                    <input type="number" id="resmasUsadas" placeholder="Ex: 2" min="0" step="0.01">
                                </div>
                            </div>

                            <!-- Status de Produ√ß√£o -->
                            <div class="production-status">
                                <h4>üîÑ Status da Produ√ß√£o</h4>
                                <div class="process-checkboxes">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enviadoFaca">
                                        <span>Enviado para produ√ß√£o da faca</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enviadoChapa">
                                        <span>Enviado para gravar chapa</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enviadoImpressao">
                                        <span>Enviado para impress√£o</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Aba 4: Imagens & Descri√ß√µes -->
                        <div id="tab-imagens" class="tab-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Imagem da Faca</label>
                                    <div class="image-upload" onclick="document.getElementById('imagemFaca').click()">
                                        <input type="file" id="imagemFaca" accept="image/*" style="display:none;">
                                        <p>üìÅ Clique para selecionar a imagem da faca</p>
                                        <img id="previewFaca" class="image-preview" style="display:none;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Imagem da Montagem da Arte</label>
                                    <div class="image-upload" onclick="document.getElementById('imagemArte').click()">
                                        <input type="file" id="imagemArte" accept="image/*" style="display:none;">
                                        <p>üé® Clique para selecionar a imagem da arte</p>
                                        <img id="previewArte" class="image-preview" style="display:none;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="acabamento">Acabamento</label>
                                <textarea id="acabamento" placeholder="Descreva os acabamentos (quebras de linha ser√£o preservadas no PDF)" required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="descricaoEmbalagens">Observa√ß√£o</label>
                                <textarea id="descricaoEmbalagens" placeholder="Observa√ß√µes gerais sobre a ordem de produ√ß√£o (formata√ß√£o preservada no PDF)" required></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-create">‚úÖ Criar Ordem de Produ√ß√£o</button>
                    </form>
                </div>
            </div>

            <!-- Espa√ßamento entre se√ß√µes -->
            <div style="margin: 40px 0;"></div>

            <div class="card orders-list">>
                <div class="list-header">
                    <h2>üìã Ordens de Produ√ß√£o</h2>
                    <div class="view-toggle">
                        <button class="btn btn-secondary btn-small" id="btnLista" onclick="setViewMode('list')">Modo Lista</button>
                        <button class="btn btn-secondary btn-small" id="btnDetalhado" onclick="setViewMode('detailed')">Modo Detalhado</button>
                    </div>
                <div class="template-actions">
                    <button class="btn btn-info btn-small" onclick="openSendToGraficaModal()">üì¶ Enviar √† Gr√°fica</button>
                    <button class="btn btn-warning btn-small" onclick="openBulkProductionStatusModal()">üîÑ Status da Produ√ß√£o</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleSelectAll()">‚òëÔ∏è Selecionar Todos</button>
                </div>
            
                    <div class="filter-controls">
                        <select id="filterStatus" onchange="filterOrders()">
                            <option value="">Todos os Status</option>
                            <option value="Em Andamento">Em Andamento</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                        <select id="filterPriority" onchange="filterOrders()">
                            <option value="">Todas as Prioridades</option>
                            <option value="Alta">Alta</option>
                            <option value="M√©dia">M√©dia</option>
                            <option value="Baixa">Baixa</option>
                        </select>
                        <select id="filterGrafica" onchange="filterOrders()">
                            <option value="">Todas as Gr√°ficas</option>
                            <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                        </select>
                        <input type="text" id="searchOrders" placeholder="Buscar por OP, produto, gr√°fica..." onkeyup="filterOrders()">
                    </div>
                </div>
                <div id="ordersList"></div>
            </div>
        </div>

        <!-- Modal para impress√£o -->
        <div id="printModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePrintModal()">&times;</span>
                <div id="printContent" class="print-preview"></div>
                <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #ddd;">
                    <button class="btn btn-primary" onclick="printOrder()">üñ®Ô∏è Imprimir Ordem</button>
                    <button class="btn btn-warning" onclick="closePrintModal()">‚ùå Fechar</button>
                </div>
            </div>
        </div>

        <!-- Modal para edi√ß√£o -->
        <div id="editModal" class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <div class="edit-form">
                    <h2>‚úèÔ∏è Editar Ordem de Produ√ß√£o</h2>
                    <form id="editForm">
                        <input type="hidden" id="editOrderId">

                        <div class="form-group">
                            <label for="editNomeTemplate">Nome do Produto</label>
                            <input type="text" id="editNomeTemplate" placeholder="Nome do produto" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMedidasFolha">Medidas da Folha de Impress√£o</label>
                                <input type="text" id="editMedidasFolha" placeholder="Ex: 70x100cm" required>
                            </div>
                            <div class="form-group">
                                <label for="editQuantidade">Quantidade de Impress√£o</label>
                                <input type="number" id="editQuantidade" placeholder="1000" required>
                            </div>
                        </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editFormato">FORMATO</label>
                    <input type="text" id="editFormato" placeholder="Ex: Tampa e Base, Gaveta, Sacola, etc.">
                </div>
                <div class="form-group">
                    <label for="editCodigoFaca">C√≥digo da Faca</label>
                    <input type="text" id="editCodigoFaca" placeholder="Ex: FAC-1234">
                </div>
            </div>

                        <div class="form-row">
                            <div class="form-group" style="grid-column:1 / -1;">
                                <label for="editFolhasResma">Quantidade de folhas/resma</label>
                                <input type="text" id="editFolhasResma" placeholder="Ex: 500 folhas (2 remas com 250)">
                            </div>
                        </div>
            <div class="form-row">
                <div class="form-group" style="grid-column:1 / -1;">
                    <label for="editResmasUsadas">Resmas utilizadas nesta ordem</label>
                    <input type="number" id="editResmasUsadas" placeholder="Ex: 2" min="0" step="0.01">
                </div>
            </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editFornecedor">Fornecedor (Terceiriza√ß√£o)</label>
                                <input type="text" id="editFornecedor" placeholder="Nome do fornecedor">
                            </div>
                            <div class="form-group">
                                <label for="editStatus">Status</label>
                                <select id="editStatus" required>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Finalizado">Finalizado</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTipoPapel">Tipo de Papel</label>
                                <input list="editTipoPapelOptions" id="editTipoPapel" placeholder="Digite ou selecione o tipo de papel" required>
                                <datalist id="editTipoPapelOptions">
                                    <option value="Papel Kraft 66x96">
                                    <option value="Papel Kraft 77x113">
                                    <option value="papel duplex 66x96">
                                    <option value="papel duplex 77x113">
                                    <option value="papel triplex 66x96">
                                    <option value="papel triplex 77x113">
                                    <option value="Papel Couche 66x96">
                                    <option value="Papel Couche 77x113">
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label for="editGramatura">Gramatura do Papel</label>
                                <input list="editGramaturaOptions" id="editGramatura" placeholder="Digite ou selecione a gramatura" required>
                                <datalist id="editGramaturaOptions">
                                    <option value="70g">
                                    <option value="90g">
                                    <option value="170g">
                                    <option value="190g">
                                    <option value="210g">
                                    <option value="220g">
                                    <option value="225g">
                                    <option value="240g">
                                    <option value="250g">
                                    <option value="270g">
                                    <option value="300g">
                                    <option value="350g">
                                </datalist>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editImpressao">Tipo de Impress√£o</label>
                                <select id="editImpressao" required>
                                    <option value="Frente 4x0">Frente 4x0</option>
                                    <option value="Frente e Verso 4x4">Frente e Verso 4x4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editPrioridade">Prioridade</label>
                                <select id="editPrioridade" required>
                                    <option value="M√©dia">M√©dia</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </div>
                        </div>

                        <!-- Pr√©-produ√ß√£o (edi√ß√£o) -->
                        <div class="form-row">
                            <div class="form-group">
                                <label><input type="checkbox" id="editEnviadoFaca"> Enviado para produ√ß√£o da faca</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="editEnviadoChapa"> Enviado para gravar chapa</label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="grid-column:1 / -1;">
                                <label><input type="checkbox" id="editEnviadoImpressao"> Enviado para impress√£o</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editAcabamento">Acabamento</label>
                            <textarea id="editAcabamento" placeholder="Descreva os acabamentos necess√°rios" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="editDescricaoEmbalagens">Observa√ß√£o</label>
                            <textarea id="editDescricaoEmbalagens" placeholder="Observa√ß√µes gerais sobre a ordem de produ√ß√£o" required></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Imagem da Faca</label>
                                <div id="currentImageFaca" style="text-align:center;margin:10px 0;"></div>
                                <div class="image-upload" onclick="document.getElementById('editImagemFaca').click()">
                                    <input type="file" id="editImagemFaca" accept="image/*" style="display:none;">
                                    <p>üìÅ Clique para alterar a imagem da faca</p>
                                    <img id="editPreviewFaca" class="image-preview" style="display:none;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Imagem da Montagem da Arte</label>
                                <div id="currentImageArte" style="text-align:center;margin:10px 0;"></div>
                                <div class="image-upload" onclick="document.getElementById('editImagemArte').click()">
                                    <input type="file" id="editImagemArte" accept="image/*" style="display:none;">
                                    <p>üé® Clique para alterar a imagem da arte</p>
                                    <img id="editPreviewArte" class="image-preview" style="display:none;">
                                </div>
                            </div>
                        </div>

                        <div class="edit-actions">
                            <button type="submit" class="btn btn-success">üíæ Salvar Altera√ß√µes</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para gerenciar modelos -->
        <div id="templatesModal" class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeTemplatesModal()">&times;</span>
                <div style="padding:20px;">
                    <h2 style="text-align:center;margin-bottom:30px;">üóÇÔ∏è Gerenciar Modelos de Produtos</h2>
                    <div id="templatesContent"></div>
                    <div style="text-align:center;margin-top:20px;">
                        <button class="btn btn-warning" onclick="closeTemplatesModal()">‚ùå Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para edi√ß√£o em lote do Status da Produ√ß√£o -->
        <div id="bulkProductionStatusModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close" onclick="closeBulkProductionStatusModal()">&times;</span>
                    <h2>üîÑ Status da Produ√ß√£o - Edi√ß√£o em Lote</h2>
                </div>
                <div style="padding:20px;">
                    <div id="bulkStatusMeta" style="text-align:center;margin-bottom:20px;color:#6c757d;"></div>
                    
                    <div style="background:#f8f9ff;border:2px solid #e8f2ff;border-radius:10px;padding:20px;margin-bottom:20px;">
                        <h3 style="color:#2c3e50;margin-bottom:15px;">Atualizar Status para OPs Selecionadas:</h3>
                        <div class="process-checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" id="bulkEnviadoFaca">
                                <span>Enviado para produ√ß√£o da faca</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="bulkEnviadoChapa">
                                <span>Enviado para gravar chapa</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="bulkEnviadoImpressao">
                                <span>Enviado para impress√£o</span>
                            </label>
                        </div>
                    </div>

                    <div id="bulkStatusOrders" style="max-height:300px;overflow-y:auto;border:1px solid #e0e6ed;border-radius:8px;padding:15px;background:#f8f9fa;"></div>
                    
                    <div style="text-align:center;margin-top:20px;">
                        <button class="btn btn-success" onclick="applyBulkProductionStatus()">‚úÖ Aplicar Mudan√ßas</button>
                        <button class="btn btn-secondary" onclick="closeBulkProductionStatusModal()">‚ùå Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifica√ß√µes -->
        <div id="notification" class="notification"></div>

        <script>
            
    // Storage simples com localStorage apenas
    const storage = (function(){
        // Testa localStorage tradicional
        const localStorageWorks = (function(){
            try {
                const testKey = '__t__';
                localStorage.setItem(testKey, '1');
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                return false;
            }
        })();

        // Fallback em mem√≥ria se localStorage n√£o funcionar
        const memStorage = {};
        const fallbackStorage = {
            getItem: (k) => (k in memStorage ? memStorage[k] : null),
            setItem: (k, v) => { memStorage[k] = String(v); },
            removeItem: (k) => { delete memStorage[k]; }
        };

        return {
            getItem: async (key) => {
                // Usa localStorage se dispon√≠vel
                if (localStorageWorks) {
                    const value = localStorage.getItem(key);
                    console.log(`üì± LocalStorage get for key: ${key}, found: ${value !== null}`);
                    return value;
                }
                const value = fallbackStorage.getItem(key);
                console.log(`üíæ Memory storage get for key: ${key}, found: ${value !== null}`);
                return value;
            },
            
            setItem: async (key, value) => {
                // Usa localStorage se dispon√≠vel
                if (localStorageWorks) {
                    try {
                        localStorage.setItem(key, value);
                        console.log(`üì± LocalStorage save successful for key: ${key}`);
                    } catch (e) {
                        console.warn("localStorage.setItem failed:", e);
                    }
                } else {
                    fallbackStorage.setItem(key, value);
                    console.log(`üíæ Memory storage save for key: ${key}`);
                }
            },
            
            removeItem: async (key) => {
                if (localStorageWorks) {
                    localStorage.removeItem(key);
                } else {
                    fallbackStorage.removeItem(key);
                }
            }
        };
    })();

    async function getJSON(key, fallback){
        try {
            console.log(`üîç getJSON called for key: ${key}`);
            const v = await storage.getItem(key);
            return v ? JSON.parse(v) : fallback;
        } catch(e){
            console.warn(`getJSON error for key ${key}:`, e);
            return fallback;
        }
    }

    async function setJSON(key, value){
        try { 
            console.log(`üîÑ setJSON called for key: ${key}`);
            await storage.setItem(key, JSON.stringify(value)); 
        } catch(e){
            console.error("setJSON error:", e);
        }
    }

    // Vari√°veis globais - carregadas do localStorage
    let orders = [];
    let orderIdCounter = 1;
    let productTemplates = [];

    // Fun√ß√£o para carregar dados iniciais
    async function loadInitialData() {
        try {
            // Carrega do localStorage
            orders = await getJSON('productionOrders', []);
            orderIdCounter = parseInt((await storage.getItem('orderIdCounter')) || '1');
            productTemplates = await getJSON('productTemplates', []);
            
            console.log(`üì¶ Carregadas ${orders.length} ordens do localStorage`);
        } catch (e) {
            console.error("Erro carregando dados:", e);
            orders = [];
            orderIdCounter = 1;
            productTemplates = [];
        }
    }
    // === Sele√ß√£o de OPs para Envio √† Gr√°fica ===
    let selectedOrderIds = new Set();
    function toggleSelectOrder(orderId, checked){
        if(checked){ selectedOrderIds.add(orderId); } else { selectedOrderIds.delete(orderId); }
    }
    function isSelected(orderId){ return selectedOrderIds.has(orderId); }
    function toggleSelectAll(){
        const list = document.querySelectorAll('input.select-order');
        const anyUnchecked = Array.from(list).some(cb => !cb.checked);
        Array.from(list).forEach(cb=>{
            cb.checked = anyUnchecked;
            const id = cb.getAttribute('data-order-id');
            toggleSelectOrder(id, anyUnchecked);
        });
        showNotification(anyUnchecked ? 'Todas as OPs vis√≠veis selecionadas.' : 'Sele√ß√£o limpa.', 'info');
    }
    function openSendToGraficaModal(){
        if(selectedOrderIds.size===0){ showNotification('Selecione pelo menos uma OP.', 'error'); return; }
        const selected = orders.filter(o => selectedOrderIds.has(o.id));
        document.getElementById('graficaMeta').textContent = `Total de ordens selecionadas: ${selected.length}`;
        const rows = selected.map(o=>{
        const resmas = parseFloat(o.resmasUsadas||0)||0;
        const forn = (o.fornecedor||'').trim();
        return `<tr>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.id}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.nomeTemplate||''}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${forn}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.tipoPapel||''}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.gramatura||''}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;text-align:right;">${resmas.toLocaleString('pt-BR')}</td>
        </tr>`;
    }).join('');
        document.getElementById('graficaOrders').innerHTML = `
            <h3 style="margin:10px 0;color:#2c3e50;">üìã Ordens Selecionadas</h3>
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">OP</th>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Produto</th>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Fornecedor</th><th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Papel</th>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Gramatura</th>
                    <th style="text-align:right;border-bottom:2px solid #333;padding:6px;">Resmas</th>
                </tr></thead>
                <tbody>${rows || '<tr><td colspan="5" style="padding:8px;">(sem dados)</td></tr>'}</tbody>
            </table>
        `;
        const mapa = {};
    for(const o of selected){
        const forn = (o.fornecedor||'').trim();
        const key = `${forn} | ${(o.tipoPapel||'').trim()} | ${(o.gramatura||'').trim()}`;
            const val = parseFloat(o.resmasUsadas||0)||0;
            mapa[key] = (mapa[key]||0) + val;
        }
        const totalRows = Object.entries(mapa).map(([k,v])=>`
            <tr>
                <td style="padding:6px;border-bottom:1px solid #eee;">${k}</td>
                <td style="padding:6px;border-bottom:1px solid #eee;text-align:right;">${v.toLocaleString('pt-BR')}</td>
            </tr>`).join('');
        const totalConsolidado = Object.values(mapa).reduce((a,b)=>a+b,0);
        document.getElementById('graficaTotais').innerHTML = `
            <h3 style="margin:16px 0;color:#2c3e50;">üßÆ Totais Consolidados</h3>
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Fornecedor | Papel | Gramatura</th>
                    <th style="text-align:right;border-bottom:2px solid #333;padding:6px;">Resmas</th>
                </tr></thead>
                <tbody>
                    ${totalRows || '<tr><td colspan="2" style="padding:8px;">(sem dados)</td></tr>'}
                    <tr>
                        <td style="padding:8px;font-weight:700;border-top:2px solid #333;">TOTAL GERAL</td>
                        <td style="padding:8px;font-weight:700;text-align:right;border-top:2px solid #333;">${totalConsolidado.toLocaleString('pt-BR')}</td>
                    </tr>
                </tbody>
            </table>
        `;
        document.getElementById('graficaModal').style.display='block';
    }
    function closeGraficaModal(){ document.getElementById('graficaModal').style.display='none'; }
    function printGraficaReport(){
        const m = document.getElementById('graficaModal');
        if(!m) return;
        const w = window.open('', 'PRINT', 'height=800,width=1000');
        const content = m.querySelector('.print-preview').outerHTML;
        w.document.write('<html><head><title>Relat√≥rio de Envio √† Gr√°fica</title><meta charset="utf-8"></head><body>');
        w.document.write('<style>body{font-family:Segoe UI,Tahoma,Arial,sans-serif;padding:20px;} table{width:100%;border-collapse:collapse;} th,td{font-size:12px;} .print-header{text-align:center;margin-bottom:10px;border-bottom:2px solid #667eea;padding-bottom:8px;}</style>');
        w.document.write(content);
        w.document.write('</body></html>');
        w.document.close(); w.focus(); w.print(); w.close();
    }

    // === Fun√ß√µes para Status de Produ√ß√£o em Lote ===
    function openBulkProductionStatusModal(){
        if(selectedOrderIds.size===0){ showNotification('Selecione pelo menos uma OP.', 'error'); return; }
        const selected = orders.filter(o => selectedOrderIds.has(o.id));
        document.getElementById('bulkStatusMeta').textContent = `Total de ordens selecionadas: ${selected.length}`;
        
        // Limpar checkboxes
        document.getElementById('bulkEnviadoFaca').checked = false;
        document.getElementById('bulkEnviadoChapa').checked = false;
        document.getElementById('bulkEnviadoImpressao').checked = false;
        
        // Listar ordens selecionadas
        const ordersList = selected.map(o => {
            const statusAtual = [
                {ok: o.enviadoFaca, label:'Faca'},
                {ok: o.enviadoChapa, label:'Chapa'},
                {ok: o.enviadoImpressao, label:'Impress√£o'}
            ];
            const statusText = statusAtual.map(s => s.ok ? `‚úÖ ${s.label}` : `‚≠ï ${s.label}`).join(' | ');
            
            return `
                <div style="padding:8px;margin:4px 0;background:#fff;border-radius:6px;border-left:4px solid #667eea;">
                    <div style="font-weight:600;color:#2c3e50;">${o.id} ${o.nomeTemplate ? `- ${o.nomeTemplate}` : ''}</div>
                    <div style="font-size:12px;color:#6c757d;margin-top:2px;">Status atual: ${statusText}</div>
                </div>
            `;
        }).join('');
        
        document.getElementById('bulkStatusOrders').innerHTML = ordersList;
        document.getElementById('bulkProductionStatusModal').style.display='block';
    }

    function closeBulkProductionStatusModal(){ 
        document.getElementById('bulkProductionStatusModal').style.display='none'; 
    }

    async function applyBulkProductionStatus(){
        if(selectedOrderIds.size===0){ showNotification('Nenhuma OP selecionada.', 'error'); return; }
        
        const enviadoFaca = document.getElementById('bulkEnviadoFaca').checked;
        const enviadoChapa = document.getElementById('bulkEnviadoChapa').checked;
        const enviadoImpressao = document.getElementById('bulkEnviadoImpressao').checked;
        
        let updateCount = 0;
        for(const orderId of selectedOrderIds){
            const order = orders.find(o => o.id === orderId);
            if(order){
                if(enviadoFaca) order.enviadoFaca = true;
                if(enviadoChapa) order.enviadoChapa = true;
                if(enviadoImpressao) order.enviadoImpressao = true;
                updateCount++;
            }
        }
        
        if(updateCount > 0){
            await setJSON('productionOrders', orders);
            displayOrders();
            showNotification(`Status de produ√ß√£o atualizado para ${updateCount} OP(s)!`, 'success');
        }
        
        closeBulkProductionStatusModal();
    }


    // ===== Utils: Quota-safe storage & image compression =====
    function estimateBytesFromDataURL(dataURL){
        try{
            const base64 = dataURL.split(',')[1] || '';
            // 4/3 base64 expansion; approximate
            return Math.ceil((base64.length * 3) / 4);
        }catch(e){ return 0; }
    }

    function compressFileToDataURL(file, maxDim=1280, quality=0.8){
        return new Promise((resolve,reject)=>{
            try{
                const img = new Image();
                const reader = new FileReader();
                reader.onload = ev => {
                    img.onload = ()=>{
                        try{
                            const canvas = document.createElement('canvas');
                            let {width, height} = img;
                            const scale = Math.min(1, maxDim/Math.max(width, height));
                            width = Math.round(width*scale); height = Math.round(height*scale);
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            // Prefer JPEG to reduce size
                            let out = canvas.toDataURL('image/jpeg', quality);
                            resolve(out);
                        }catch(err){ reject(err); }
                    };
                    img.onerror = reject;
                    img.src = ev.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }catch(err){ reject(err); }
        });
    }

    function compressDataURL(dataURL, maxDim=1280, quality=0.8){
        return new Promise((resolve,reject)=>{
            try{
                const img = new Image();
                img.onload = ()=>{
                    try{
                        const canvas = document.createElement('canvas');
                        let {width, height} = img;
                        const scale = Math.min(1, maxDim/Math.max(width, height));
                        width = Math.round(width*scale); height = Math.round(height*scale);
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const out = canvas.toDataURL('image/jpeg', quality);
                        resolve(out);
                    }catch(err){ reject(err); }
                };
                img.onerror = reject;
                img.src = dataURL;
            }catch(err){ reject(err); }
        });
    }

    // setJSON com retry ao atingir cota: tenta reduzir qualidade de imagens grandes
    async function setJSONRetry(key, value, onQuota){
        try{
            await setJSON(key, value);
            return true;
        }catch(e){
            // Alguns navegadores lan√ßam QuotaExceededError sem permitir catch aqui; ent√£o usamos try interno do setJSON.
            return true;
        }
    }

    // Migra√ß√£o: comprime imagens existentes muito grandes (executa na inicializa√ß√£o, sem alterar fluxo do usu√°rio)
    async function migrateAndCompactOrdersIfNeeded(maxTotalBytes=4.5*1024*1024){
        try{
            let changed = false;
            const ordersLocal = await getJSON('productionOrders', []);
            // Estima tamanho atual da string JSON + imagens
            let approx = JSON.stringify(ordersLocal).length;
            if(approx < maxTotalBytes) return; // r√°pido
            for (let i=0; i<ordersLocal.length; i++){
                const o = ordersLocal[i];
                for (const k of ['imagemFaca','imagemArte']){
                    if(o && o[k] && estimateBytesFromDataURL(o[k]) > 500*1024){
                        // comprime de forma agressiva
                        try{
                            o[k] = await compressDataURL(o[k], 1024, 0.7);
                            changed = true;
                        }catch(_){/* ignore */}
                    }
                }
                approx = JSON.stringify(ordersLocal).length;
                if(approx < maxTotalBytes) break;
            }
            if(changed){
                setJSON('productionOrders', ordersLocal);
            }
        }catch(_){/* ignore */}
    }


            let isEditing = false;
            let selectedTemplate = null;
            let viewMode = localStorage.getItem('ordersViewMode') || 'detailed';
            window.viewMode = viewMode; // 'list' | 'detailed'
            
            // Fun√ß√£o para trocar abas
            function switchTab(tabName) {
                try {
                    // Remove active de todas as abas e conte√∫dos
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Ativa a aba clicada
                    if(event && event.target) {
                        event.target.classList.add('active');
                    }
                    
                    // Ativa o conte√∫do da aba
                    const tabContent = document.getElementById('tab-' + tabName);
                    if(tabContent) {
                        tabContent.classList.add('active');
                    } else {
                        console.error('Tab content not found:', 'tab-' + tabName);
                        return;
                    }
                    
                    // Feedback para o usu√°rio
                    const tabNames = {
                        'basico': 'Informa√ß√µes B√°sicas',
                        'especificacoes': 'Especifica√ß√µes',
                        'producao': 'Produ√ß√£o',
                        'imagens': 'Imagens & Descri√ß√µes'
                    };
                    showNotification(`Aba: ${tabNames[tabName]}`, 'info');
                } catch(error) {
                    console.error('Erro na fun√ß√£o switchTab:', error);
                    showNotification('Erro ao trocar aba. Tente novamente.', 'error');
                }
            }

            function setViewMode(mode){
                try {
                    window.viewMode = mode;
                    localStorage.setItem('ordersViewMode', mode);
                    
                    const bList = document.getElementById('btnLista');
                    const bDet = document.getElementById('btnDetalhado');
                    
                    if(bList) {
                        bList.className = 'btn btn-secondary btn-small';
                        if(mode === 'list') bList.classList.add('active');
                    }
                    if(bDet) {
                        bDet.className = 'btn btn-secondary btn-small';
                        if(mode === 'detailed') bDet.classList.add('active');
                    }
                    
                    // Feedback para o usu√°rio
                    const modeText = mode === 'list' ? 'Lista Compacta' : 'Detalhado Completo';
                    showNotification(`Modo de visualiza√ß√£o: ${modeText}`, 'info');
                    
                } catch(e) { 
                    console && console.warn && console.warn('setViewMode warn:', e); 
                }
                try { 
                    displayOrders(); 
                } catch(e) { 
                    console && console.error && console.error('displayOrders err:', e); 
                }
            }


            function updateGraficaFilter() {
                // Extrair todas as gr√°ficas √∫nicas das ordens existentes (campo fornecedor = terceiriza√ß√£o)
                const graficasUnicas = [...new Set(orders
                    .map(order => order.fornecedor)
                    .filter(grafica => grafica && grafica.trim() !== '')
                )].sort();
                
                const filterGrafica = document.getElementById('filterGrafica');
                if (!filterGrafica) return;
                
                // Salvar valor selecionado atual
                const currentValue = filterGrafica.value;
                
                // Limpar op√ß√µes existentes (exceto "Todas as Gr√°ficas")
                filterGrafica.innerHTML = '<option value="">Todas as Gr√°ficas</option>';
                
                // Adicionar gr√°ficas encontradas
                graficasUnicas.forEach(grafica => {
                    const option = document.createElement('option');
                    option.value = grafica;
                    option.textContent = grafica;
                    filterGrafica.appendChild(option);
                });
                
                // Restaurar valor selecionado se ainda existir
                if (currentValue && graficasUnicas.includes(currentValue)) {
                    filterGrafica.value = currentValue;
                }
            }

            function showNotification(message,type='success'){const n=document.getElementById('notification');n.textContent=message;n.className=`notification ${type}`;n.classList.add('show');setTimeout(()=>n.classList.remove('show'),3000);}
            async function generateOrderId(){const id=orderIdCounter;orderIdCounter++;await storage.setItem('orderIdCounter', orderIdCounter.toString());return `OP-${String(id).padStart(4,'0')}`;}
            function updateStats(){const total=orders.length;const emAndamento=orders.filter(o=>o.status==='Em Andamento').length;const finalizadas=orders.filter(o=>o.status==='Finalizado').length;const unicos=new Set(orders.map(o=>o.nomeTemplate)).size;document.getElementById('totalOrders').textContent=total;document.getElementById('inProgressOrders').textContent=emAndamento;document.getElementById('completedOrders').textContent=finalizadas;document.getElementById('totalProducts').textContent=unicos;}

            function showProductHistory(){
                const list=document.getElementById('productList');
                if(productTemplates.length===0){showNotification('Nenhum produto salvo no hist√≥rico ainda.','info');return;}
                list.innerHTML=productTemplates.map((t,i)=>`
                    <div class="product-item" onclick="selectTemplate(${i})">
                        <div class="product-name">${t.nomeTemplate}</div>
                        <div class="product-details">${t.tipoPapel} | ${t.gramatura} | ${t.impressao}</div>
                    </div>`).join('');
                list.style.display='grid';document.getElementById('clearSelectionBtn').style.display='block';
            }
            function selectTemplate(i){selectedTemplate=productTemplates[i];document.querySelectorAll('.product-item').forEach(it=>it.classList.remove('selected'));document.querySelectorAll('.product-item')[i].classList.add('selected');fillFormWithTemplate(selectedTemplate);showNotification(`Produto "${selectedTemplate.nomeTemplate}" carregado!`,'success');}
            function fillFormWithTemplate(t){
                const setValueSafely = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value || '';
                    } else {
                        console.warn(`Element ${id} not found`);
                    }
                };
                
                setValueSafely('medidasFolha', t.medidasFolha);
                setValueSafely('fornecedor', t.fornecedor);
                setValueSafely('tipoPapel', t.tipoPapel);
                setValueSafely('gramatura', t.gramatura);
                setValueSafely('impressao', t.impressao || 'Frente 4x0');
                setValueSafely('prioridade', t.prioridade || 'M√©dia');
                setValueSafely('nomeTemplate', t.nomeTemplate);
                setValueSafely('folhasResma', t.folhasResma);
                setValueSafely('acabamento', t.acabamento);
                setValueSafely('descricaoEmbalagens', t.descricaoEmbalagens);
                setValueSafely('formato', t.formato);
                setValueSafely('codigoFaca', t.codigoFaca);
                setValueSafely('resmasUsadas', t.resmasUsadas);
                if(t.imagemFaca){const p=document.getElementById('previewFaca');p.src=t.imagemFaca;p.style.display='block';}
                if(t.imagemArte){const p=document.getElementById('previewArte');p.src=t.imagemArte;p.style.display='block';}
            }
            function clearSelection(){selectedTemplate=null;document.querySelectorAll('.product-item').forEach(it=>it.classList.remove('selected'));document.getElementById('productList').style.display='none';document.getElementById('clearSelectionBtn').style.display='none';}
            function clearForm(){document.getElementById('orderForm').reset();document.getElementById('previewFaca').style.display='none';document.getElementById('previewArte').style.display='none';clearSelection();showNotification('Formul√°rio limpo!','info');}

            async function saveAsTemplate(){
                const nomeElement = document.getElementById('nomeTemplate');
                if (!nomeElement) {
                    showNotification('Erro: Elemento nome do template n√£o encontrado!', 'error');
                    return;
                }
                const nome = nomeElement.value.trim();
                if(!nome){showNotification('Digite o nome do produto antes de salvar como modelo.','error');return;}
                
                const getTemplateValueSafely = (id, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        return element.value || defaultValue;
                    } else {
                        console.warn(`Template element ${id} not found`);
                        return defaultValue;
                    }
                };
                
                const t={
                    nomeTemplate:nome,
                    medidasFolha:getTemplateValueSafely('medidasFolha'),
                    fornecedor:getTemplateValueSafely('fornecedor'),
                    tipoPapel:getTemplateValueSafely('tipoPapel'),
                    gramatura:getTemplateValueSafely('gramatura'),
                    impressao:getTemplateValueSafely('impressao'),
                    prioridade:getTemplateValueSafely('prioridade'),
                    folhasResma:getTemplateValueSafely('folhasResma'),
                    acabamento:getTemplateValueSafely('acabamento'),
                    descricaoEmbalagens:getTemplateValueSafely('descricaoEmbalagens'),
                    formato:getTemplateValueSafely('formato'),
                    codigoFaca:getTemplateValueSafely('codigoFaca'),
                    resmasUsadas:getTemplateValueSafely('resmasUsadas'),
                    imagemFaca:document.getElementById('previewFaca')?.src||null,
                    imagemArte:document.getElementById('previewArte')?.src||null,
                    dataCriacao:new Date().toLocaleDateString('pt-BR'),
                    vezesCriado:1
                };
                const idx=productTemplates.findIndex(x=>x.nomeTemplate===nome);
                if(idx!==-1){if(confirm(`J√° existe um modelo com o nome "${nome}". Deseja atualizar?`)){productTemplates[idx]={...t,vezesCriado:productTemplates[idx].vezesCriado+1};showNotification(`Modelo "${nome}" atualizado!`,'success');}}
                else{productTemplates.push(t);showNotification(`Modelo "${nome}" salvo no hist√≥rico!`,'success');}
                await setJSON('productTemplates', productTemplates);
            }

            function manageTemplates(){
                const el=document.getElementById('templatesContent');
                if(productTemplates.length===0){el.innerHTML='<p style="text-align:center;padding:40px;color:#6c757d;">Nenhum modelo salvo ainda.</p>';}
                else{
                    el.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;">${
                        productTemplates.map((t,i)=>`
                            <div style="background:#f8f9fa;border:2px solid #e9ecef;border-radius:10px;padding:15px;">
                                <h4 style="color:#2c3e50;margin-bottom:10px;">${t.nomeTemplate}</h4>
                                <p style="font-size:14px;color:#6c757d;margin-bottom:10px;">
                                    <strong>Papel:</strong> ${t.tipoPapel}<br>
                                    <strong>Gramatura:</strong> ${t.gramatura}<br>
                                    <strong>Impress√£o:</strong> ${t.impressao}<br>
                                    ${t.folhasResma?`<strong>Folhas/Resma:</strong> ${t.folhasResma}<br>`:''}
                                    <strong>Criado:</strong> ${t.dataCriacao}<br>
                                    <strong>Usado:</strong> ${t.vezesCriado} vez(es)
                                </p>
                                <div style="display:flex;gap:5px;flex-wrap:wrap;">
                                    <button class="btn btn-info btn-small" onclick="useTemplate(${i})">üîÑ Usar</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteTemplate(${i})">üóëÔ∏è Excluir</button>
                                </div>
                            </div>`).join('')
                    }</div>`;
                }
                document.getElementById('templatesModal').style.display='block';
            }
            function useTemplate(i){fillFormWithTemplate(productTemplates[i]);closeTemplatesModal();showNotification(`Modelo "${productTemplates[i].nomeTemplate}" carregado!`,'success');}
            async function deleteTemplate(i){const t=productTemplates[i];if(confirm(`Tem certeza que deseja excluir o modelo "${t.nomeTemplate}"?`)){productTemplates.splice(i,1);await setJSON('productTemplates', productTemplates);manageTemplates();showNotification(`Modelo "${t.nomeTemplate}" exclu√≠do!`,'info');}}
            function closeTemplatesModal(){document.getElementById('templatesModal').style.display='none';}

            function imageToBase64(file,cb){const r=new FileReader();r.onload=e=>cb(e.target.result);r.readAsDataURL(file);}
            document.getElementById('imagemFaca').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('previewFaca');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});
            document.getElementById('imagemArte').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('previewArte');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});
            document.getElementById('editImagemFaca').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('editPreviewFaca');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});
            document.getElementById('editImagemArte').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('editPreviewArte');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});

            document.querySelectorAll('.image-upload').forEach(u=>{
                u.addEventListener('dragover',e=>{e.preventDefault();u.classList.add('dragover');});
                u.addEventListener('dragleave',e=>{e.preventDefault();u.classList.remove('dragover');});
                u.addEventListener('drop',e=>{e.preventDefault();u.classList.remove('dragover');const files=e.dataTransfer.files;if(files.length>0){const input=u.querySelector('input[type="file"]');input.files=files;input.dispatchEvent(new Event('change'));}});
            });

            // Criar nova OP
            document.getElementById('orderForm').addEventListener('submit', async function(e){
                e.preventDefault();
                const imgF=document.getElementById('imagemFaca').files[0];
                const imgA=document.getElementById('imagemArte').files[0];
                let imgFData=null, imgAData=null;
                if(imgF){ try{ imgFData = await compressFileToDataURL(imgF, 1280, 0.8);}catch(_){ /* fallback handled below */ } }
                if(imgA){ try{ imgAData = await compressFileToDataURL(imgA, 1280, 0.8);}catch(_){ /* fallback handled below */ } }
                const getValueSafely = (id, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        return element.value || defaultValue;
                    } else {
                        console.warn(`Element ${id} not found for order creation`);
                        return defaultValue;
                    }
                };
                
                const order={
                    id:await generateOrderId(),
                    medidasFolha:getValueSafely('medidasFolha'),
                    quantidade:getValueSafely('quantidade'),
                    folhasResma:getValueSafely('folhasResma'),
                    fornecedor:getValueSafely('fornecedor'),
                    status:getValueSafely('status'),
                    tipoPapel:getValueSafely('tipoPapel'),
                    gramatura:getValueSafely('gramatura'),
                    impressao:getValueSafely('impressao'),
                    prioridade:getValueSafely('prioridade'),
                    nomeTemplate:getValueSafely('nomeTemplate'),
                    
                    formato:getValueSafely('formato'),
                    codigoFaca:getValueSafely('codigoFaca'),
                    resmasUsadas:getValueSafely('resmasUsadas'),
                    enviadoFaca:document.getElementById('enviadoFaca')?.checked || false,
                    enviadoChapa:document.getElementById('enviadoChapa')?.checked || false,
                    enviadoImpressao:document.getElementById('enviadoImpressao')?.checked || false,
                    acabamento:getValueSafely('acabamento'),
                    descricaoEmbalagens:getValueSafely('descricaoEmbalagens'),
                    dataCreated:new Date().toLocaleDateString('pt-BR'),
                    timeCreated:new Date().toLocaleTimeString('pt-BR'),
                    currentStep:0,
                    imagemFaca:imgFData,
                    imagemArte:imgAData
                };
                
                // Nova l√≥gica: salvar ordem individual
                async function saveOrder() {
                    try {
                        // Salva no localStorage
                        orders.push(order);
                        await setJSON('productionOrders', orders);
                        
                        await saveAsTemplate();
                        displayOrders();
                        updateStats();
                        updateGraficaFilter();
                        document.getElementById('orderForm').reset();
                        document.getElementById('previewFaca').style.display='none';
                        document.getElementById('previewArte').style.display='none';
                        clearSelection();
                        showNotification('‚úÖ Ordem de produ√ß√£o criada com sucesso!','success');
                    } catch (error) {
                        console.error('Erro ao salvar ordem:', error);
                        showNotification('‚ùå Erro ao salvar ordem: ' + error.message, 'error');
                    }
                }
                
                let processed=0;const total=(imgF?1:0)+(imgA?1:0);
                if(total===0){await saveOrder();return;}
                if(imgF){imageToBase64(imgF,async b64=>{order.imagemFaca=b64;processed++;if(processed===total)await saveOrder();});}
                if(imgA){imageToBase64(imgA,async b64=>{order.imagemArte=b64;processed++;if(processed===total)await saveOrder();});}
            });

            // Editar OP
            document.getElementById('editForm').addEventListener('submit', async function(e){
                e.preventDefault();
                const editOrderIdElement = document.getElementById('editOrderId');
                if (!editOrderIdElement) {
                    showNotification('Erro: Formul√°rio de edi√ß√£o n√£o encontrado!', 'error');
                    return;
                }
                const id = editOrderIdElement.value;
                const idx=orders.findIndex(o=>o.id===id);
                if(idx===-1){showNotification('Erro: Ordem n√£o encontrada!','error');return;}
                const order=orders[idx];
                const editImgFInput=document.getElementById('editImagemFaca'); const imgF=(editImgFInput && editImgFInput.files && editImgFInput.files[0])||null;
                const editImgAInput=document.getElementById('editImagemArte'); const imgA=(editImgAInput && editImgAInput.files && editImgAInput.files[0])||null;

                const getEditValueSafely = (id, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            return element.checked;
                        }
                        return element.value || defaultValue;
                    } else {
                        console.warn(`Edit element ${id} not found`);
                        return defaultValue;
                    }
                };

                order.medidasFolha=getEditValueSafely('editMedidasFolha');
                order.quantidade=getEditValueSafely('editQuantidade');
                order.folhasResma=getEditValueSafely('editFolhasResma');
                order.fornecedor=getEditValueSafely('editFornecedor');
                order.status=getEditValueSafely('editStatus');
                order.tipoPapel=getEditValueSafely('editTipoPapel');
                order.gramatura=getEditValueSafely('editGramatura');
                order.impressao=getEditValueSafely('editImpressao');
                order.prioridade=getEditValueSafely('editPrioridade');
                order.nomeTemplate=getEditValueSafely('editNomeTemplate');
                order.enviadoFaca=getEditValueSafely('editEnviadoFaca', false);
                order.enviadoChapa=getEditValueSafely('editEnviadoChapa', false);
                order.enviadoImpressao=getEditValueSafely('editEnviadoImpressao', false);
                order.acabamento=getEditValueSafely('editAcabamento');
                order.descricaoEmbalagens=getEditValueSafely('editDescricaoEmbalagens');
                order.formato=getEditValueSafely('editFormato');
                order.codigoFaca=getEditValueSafely('editCodigoFaca');
                order.resmasUsadas=getEditValueSafely('editResmasUsadas');
                order.lastModified=new Date().toLocaleDateString('pt-BR')+' √†s '+new Date().toLocaleTimeString('pt-BR');

                let processed=0;const total=(imgF?1:0)+(imgA?1:0);
                
                async function finish(){
                    try {
                        // Atualiza no localStorage
                        orders[idx]=order;
                        await setJSON('productionOrders', orders);
                        
                        displayOrders();updateStats();updateGraficaFilter();closeEditModal();
                        showNotification(`‚úÖ Ordem ${id} atualizada com sucesso!`,'success');
                    } catch (error) {
                        console.error('Erro ao atualizar ordem:', error);
                        showNotification('‚ùå Erro ao atualizar ordem: ' + error.message, 'error');
                    }
                }
                
                if(total===0){await finish();return;}
                if(imgF){imageToBase64(imgF,async b64=>{order.imagemFaca=b64;processed++;if(processed===total)await finish();});}
                if(imgA){imageToBase64(imgA,async b64=>{order.imagemArte=b64;processed++;if(processed===total)await finish();});}
            });

            function editOrder(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(!order){showNotification('Erro: Ordem n√£o encontrada!','error');return;}
                isEditing=true;
                
                const setValueSafely = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = !!value;
                        } else {
                            element.value = value || '';
                        }
                    } else {
                        console.warn(`Edit element ${id} not found`);
                    }
                };
                
                setValueSafely('editOrderId', order.id);
                setValueSafely('editMedidasFolha', order.medidasFolha);
                setValueSafely('editQuantidade', order.quantidade);
                setValueSafely('editFornecedor', order.fornecedor);
                setValueSafely('editStatus', order.status);
                setValueSafely('editTipoPapel', order.tipoPapel);
                setValueSafely('editGramatura', order.gramatura);
                setValueSafely('editImpressao', order.impressao);
                setValueSafely('editPrioridade', order.prioridade || 'M√©dia');
                setValueSafely('editNomeTemplate', order.nomeTemplate);
                setValueSafely('editAcabamento', order.acabamento);
                setValueSafely('editDescricaoEmbalagens', order.descricaoEmbalagens);
                setValueSafely('editFormato', order.formato);
                setValueSafely('editCodigoFaca', order.codigoFaca);
                setValueSafely('editResmasUsadas', order.resmasUsadas);
                setValueSafely('editFolhasResma', order.folhasResma);
                setValueSafely('editEnviadoFaca', order.enviadoFaca);
                setValueSafely('editEnviadoChapa', order.enviadoChapa);
                setValueSafely('editEnviadoImpressao', order.enviadoImpressao);

                const ciF=document.getElementById('currentImageFaca');
                const ciA=document.getElementById('currentImageArte');
                ciF.innerHTML=order.imagemFaca?`<p><strong>Imagem Atual da Faca:</strong></p><img src="${order.imagemFaca}" alt="Faca Atual" class="current-image-preview">`:'<p style="color:#999;">Nenhuma imagem da faca cadastrada</p>';
                ciA.innerHTML=order.imagemArte?`<p><strong>Imagem Atual da Arte:</strong></p><img src="${order.imagemArte}" alt="Arte Atual" class="current-image-preview">`:'<p style="color:#999;">Nenhuma imagem da arte cadastrada</p>';

                document.getElementById('editPreviewFaca').style.display='none';
                document.getElementById('editPreviewArte').style.display='none';
                document.getElementById('editImagemFaca').value='';
                document.getElementById('editImagemArte').value='';
                document.getElementById('editModal').style.display='block';
                showNotification(`Editando ordem ${orderId}`,'info');
            }
            function closeEditModal(){document.getElementById('editModal').style.display='none';isEditing=false;}

            function filterOrders(){
                const st=document.getElementById('filterStatus').value;
                const pr=document.getElementById('filterPriority').value;
                const gr=document.getElementById('filterGrafica').value;
                const q=document.getElementById('searchOrders').value.toLowerCase();
                let filtered=orders.filter(order=>{
                    const sOK=!st||order.status===st;
                    const pOK=!pr||order.prioridade===pr;
                    const gOK=!gr||order.fornecedor===gr;
                    const qOK=!q||order.id.toLowerCase().includes(q)||order.tipoPapel.toLowerCase().includes(q)||order.acabamento.toLowerCase().includes(q)||order.descricaoEmbalagens.toLowerCase().includes(q)||(order.nomeTemplate&&order.nomeTemplate.toLowerCase().includes(q))||(order.fornecedor&&order.fornecedor.toLowerCase().includes(q));
                    return sOK&&pOK&&gOK&&qOK;
                });
                displayOrdersList(filtered);
            }

            /* === Renderizadores === */
            function buildPreProducaoChips(order){
                const chips = [
                    {ok: order.enviadoFaca, label:'Enviado p/ produ√ß√£o da faca'},
                    {ok: order.enviadoChapa, label:'Enviado p/ gravar chapa'},
                    {ok: order.enviadoImpressao, label:'Enviado p/ impress√£o'}
                ];
                return `<div class="process-flow">${chips.map(c=>`<div class="process-step ${c.ok?'completed':''}">${c.label}${c.ok?' ‚úÖ':''}</div>`).join('')}</div>`;
            }

            function buildDetailedCard(order){
                const processSteps=['Corte e Vinco','Desmolde','Acabamento','Selagem','Prateleira'];
                const pClass=order.prioridade?order.prioridade.toLowerCase():'media';
                
                // Definir classes CSS baseadas no status
                const statusClass = order.status === 'Finalizado' ? 'status-finalizado' : 'status-em-andamento';
                const badgeClass = order.status === 'Finalizado' ? 'finalizado' : 'em-andamento';
                const statusIcon = order.status === 'Finalizado' ? '‚úÖ' : 'üîÑ';
                const statusBadgeText = order.status === 'Finalizado' ? '‚úÖ Finalizado' : 'üîÑ Em Andamento';
                
                return `
                <div class="order-item order-card ${statusClass} priority-${pClass==='m√©dia'?'medium':pClass==='alta'?'high':'low'}" style="position:relative;">
                    <div class="status-badge ${badgeClass}" style="position:absolute;top:15px;right:15px;">${statusBadgeText}</div>
                    <div class="order-header">
                        <input type="checkbox" class="select-order" data-order-id="${order.id}" onchange="event.stopPropagation();toggleSelectOrder('${order.id}', this.checked)" ${isSelected(order.id)?'checked':''} style="margin-right:8px;"> <span class="order-id">${order.id}</span>
                        ${order.nomeTemplate?`<span style="background:#e8f4fd;color:#2c3e50;padding:3px 8px;border-radius:12px;font-size:12px;margin-left:10px;">üì¶ ${order.nomeTemplate}</span>`:''}
                        ${order.fornecedor?`<span class="grafica-tag-detailed">üè¢ ${order.fornecedor}</span>`:''}
                        <span class="priority ${pClass}">${order.prioridade||'M√©dia'}</span>
                        <span style="margin-left:15px;color:#6c757d;">${order.dataCreated} ${order.timeCreated?'√†s '+order.timeCreated:''}</span>
                        ${order.lastModified?`<span style="margin-left:10px;color:#e67e22;font-size:12px;">(Editado: ${order.lastModified})</span>`:''}
                        <span class="status ${order.status.toLowerCase().replace(' ','-')}" style="font-weight:700;">${statusIcon} ${order.status}</span>
                    </div>

                    <div>
                        <div class="preprod-label">Pr√©-produ√ß√£o</div>
                        ${buildPreProducaoChips(order)}
                    </div>

                    <div class="process-flow">
                        ${processSteps.map((s,i)=>`<div class="process-step ${i<order.currentStep?'completed':i===order.currentStep?'current':''}">${i+1}. ${s}</div>`).join('')}
                    </div>

                    <div class="order-details">
                        ${order.formato?`<div class="detail-item"><span class="detail-label">Formato: </span><span>${order.formato}</span></div>`:""}
                        ${order.codigoFaca?`<div class="detail-item"><span class="detail-label">C√≥digo da Faca: </span><span>${order.codigoFaca}</span></div>`:""}
                        <div class="detail-item"><span class="detail-label">Medidas: </span><span>${order.medidasFolha}</span></div>
                        <div class="detail-item"><span class="detail-label">Quantidade: </span><span>${parseInt(order.quantidade).toLocaleString()}</span></div>
                        ${order.folhasResma?`<div class="detail-item"><span class="detail-label">Folhas/Resma: </span><span>${order.folhasResma}</span></div>`:''}
                        ${order.resmasUsadas?`<div class="detail-item"><span class="detail-label">Resmas: </span><span>${order.resmasUsadas}</span></div>`:""}
                        <div class="detail-item"><span class="detail-label">Papel: </span><span>${order.tipoPapel}</span></div>
                        <div class="detail-item"><span class="detail-label">Gramatura: </span><span>${order.gramatura}</span></div>
                        <div class="detail-item"><span class="detail-label">Impress√£o: </span><span>${order.impressao}</span></div>
                        ${order.fornecedor?`<div class="detail-item"><span class="detail-label">Gr√°fica (Terceiriza√ß√£o): </span><span>üè¢ ${order.fornecedor}</span></div>`:''}
                    </div>

                    ${order.imagemFaca||order.imagemArte?`
                    <div class="order-images">
                        ${order.imagemFaca?`<div class="order-image"><h4>Imagem da Faca</h4><img src="${order.imagemFaca}" alt="Faca"></div>`:''}
                        ${order.imagemArte?`<div class="order-image"><h4>Montagem da Arte</h4><img src="${order.imagemArte}" alt="Arte"></div>`:''}
                    </div>`:''}

                    <div style="margin:15px 0;">
                        <strong>Acabamento:</strong>
                        <p style="margin-top:5px;background:#f8f9fa;padding:10px;border-radius:5px;">${order.acabamento}</p>
                    </div>

                    <div style="margin:15px 0;">
                        <strong>Observa√ß√£o:</strong>
                        <p style="margin-top:5px;background:#f8f9fa;padding:10px;border-radius:5px;">${order.descricaoEmbalagens}</p>
                    </div>

                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="printOrderModal('${order.id}')">üñ®Ô∏è Imprimir</button>
                        <button class="btn btn-success" onclick="advanceStep('${order.id}')">‚û°Ô∏è Pr√≥xima Etapa</button>
                        <button class="btn btn-warning" onclick="editOrder('${order.id}')">‚úèÔ∏è Editar</button>
                        <button class="btn btn-info btn-small" onclick="duplicateOrder('${order.id}')">üìã Duplicar</button>
                        <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">üóëÔ∏è Excluir</button>
                    </div>
                </div>`;
            }

            
    function buildCompactItem(order){
                // Linha resumida sem prioridade conforme solicitado: OP-0001 üì¶ Caixa para 4 Doces 27/09/2025 √†s 03:43:59
                const resumeLine = `${order.id} ${order.nomeTemplate ? `üì¶ ${order.nomeTemplate}` : ''} ${order.dataCreated}${order.timeCreated ? ` √†s ${order.timeCreated}` : ''}`;
                const detailHtml = buildDetailedCard(order);
                const safeId = `exp_${order.id.replace(/[^a-zA-Z0-9_-]/g,'')}`;
                
                // Definir classes CSS baseadas no status
                const statusClass = order.status === 'Finalizado' ? 'status-finalizado' : 'status-em-andamento';
                const badgeClass = order.status === 'Finalizado' ? 'finalizado' : 'em-andamento';
                const statusTextClass = order.status === 'Finalizado' ? 'finalizado' : 'em-andamento';
                
                // √çcone e texto do selo
                const statusIcon = order.status === 'Finalizado' ? '‚úÖ' : 'üîÑ';
                const statusBadgeText = order.status === 'Finalizado' ? '‚úÖ Finalizado' : 'üîÑ Em Andamento';
                
                // Tag da gr√°fica (usando campo fornecedor = terceiriza√ß√£o)
                const graficaTag = order.fornecedor ? `<span class="grafica-tag">üè¢ ${order.fornecedor}</span>` : '';
                
                // Status da Produ√ß√£o (pr√©-produ√ß√£o) - chips compactos
                const statusProducao = [
                    {ok: order.enviadoFaca, label:'Faca', icon:'üîß'},
                    {ok: order.enviadoChapa, label:'Chapa', icon:'üìã'},
                    {ok: order.enviadoImpressao, label:'Impress√£o', icon:'üñ®Ô∏è'}
                ];
                const statusChips = statusProducao.map(s => 
                    `<span style="display:inline-block;padding:2px 6px;margin:1px;border-radius:8px;font-size:10px;font-weight:bold;${s.ok ? 'background:#28a745;color:white;' : 'background:#e9ecef;color:#6c757d;'}">${s.icon} ${s.label}${s.ok ? ' ‚úÖ' : ''}</span>`
                ).join('');
                
                return `
                <div class="compact-item ${statusClass}" onclick="toggleExpand('${safeId}')" style="cursor:pointer;transition:all 0.3s ease;">
                    <div class="status-badge ${badgeClass}">${statusBadgeText}</div>
                    <div style="display:flex;align-items:center;">
                        <input type="checkbox" class="select-order" data-order-id="${order.id}" onchange="event.stopPropagation();toggleSelectOrder('${order.id}', this.checked)" ${isSelected(order.id)?'checked':''} style="margin-right:8px;">
                        <div class="compact-title" style="flex:1;font-weight:600;color:#2c3e50;">${resumeLine}</div>
                        <div data-hint style="margin-left:10px;color:#6c757d;font-size:12px;">üëÜ Clique para expandir</div>
                    </div>
                    <div class="compact-meta" style="font-size:12px;margin-top:4px;margin-left:24px;">Status: <span class="status-text ${statusTextClass}">${statusIcon} ${order.status}</span>${graficaTag}</div>
                    <div class="compact-production-status" style="font-size:11px;margin-top:6px;margin-left:24px;">
                        <span style="color:#495057;font-weight:600;">üîÑ Status da Produ√ß√£o:</span> ${statusChips}
                    </div>
                    
                    <div id="${safeId}" class="compact-expanded" style="display:none;margin-top:15px;border-top:1px dashed #e0e6ed;padding-top:15px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h4 style="color:#2c3e50;margin:0;">üìã Detalhes Completos da ${order.id}</h4>
                            <button class="btn btn-info btn-small" onclick="event.stopPropagation();scrollToAndHighlight('${safeId}')">üëÅÔ∏è Ver OP Completa</button>
                        </div>
                        ${detailHtml}
                    </div>
                </div>`;
            }
            function toggleExpand(id){
                const el = document.getElementById(id);
                if(!el) return;
                
                const isExpanded = el.style.display === 'block';
                const parentCard = el.closest('.compact-item');
                
                if(isExpanded) {
                    // Fechando
                    el.style.display = 'none';
                    if(parentCard) {
                        parentCard.style.backgroundColor = '';
                        const hint = parentCard.querySelector('[data-hint]');
                        if(hint) hint.textContent = 'üëÜ Clique para expandir';
                    }
                } else {
                    // Abrindo
                    el.style.display = 'block';
                    if(parentCard) {
                        parentCard.style.backgroundColor = '#f8f9ff';
                        const hint = parentCard.querySelector('[data-hint]');
                        if(hint) hint.textContent = 'üëÜ Clique para recolher';
                    }
                    // Scroll suave para a OP expandida
                    setTimeout(() => {
                        el.scrollIntoView({behavior:'smooth', block:'nearest'});
                    }, 100);
                }
            }
            function scrollToAndHighlight(id){
                const el=document.getElementById(id);
                if(!el) return;
                el.style.display='block';
                el.scrollIntoView({behavior:'smooth',block:'center'});
            }

            function displayOrders(){
                updateGraficaFilter(); // Atualizar op√ß√µes de gr√°ficas
                displayOrdersList(orders);
            }
            function displayOrdersList(list=orders){
                const el=document.getElementById('ordersList');
                if(list.length===0){
                    el.innerHTML='<div style="text-align:center;color:#6c757d;padding:40px;background:#f8f9fa;border-radius:10px;border:2px dashed #ddd;"><h3 style="margin-bottom:10px;">üìã Nenhuma ordem encontrada</h3><p>Crie sua primeira ordem de produ√ß√£o usando o formul√°rio acima.</p></div>';
                    return;
                }
                
                // NOVA REGRA: OPs Em Andamento sempre primeiro, depois Finalizadas
                const sortedList = [...list].sort((a, b) => {
                    // Se A √© Em Andamento e B √© Finalizado ‚Üí A vem primeiro (retorna -1)
                    if (a.status === 'Em Andamento' && b.status === 'Finalizado') {
                        return -1;
                    }
                    // Se A √© Finalizado e B √© Em Andamento ‚Üí B vem primeiro (retorna 1)
                    if (a.status === 'Finalizado' && b.status === 'Em Andamento') {
                        return 1;
                    }
                    
                    // Se ambos t√™m o mesmo status, ordenar por ID (mais recentes primeiro)
                    return b.id.localeCompare(a.id, undefined, {numeric: true, sensitivity: 'base'});
                });
                
                const modeDescription = window.viewMode === 'list' 
                    ? '<div style="text-align:center;margin-bottom:20px;padding:12px;background:#e8f4fd;border-radius:8px;border-left:4px solid #74b9ff;"><p style="color:#2c3e50;margin:0;">üí° <strong>Modo Lista:</strong> Clique em qualquer OP para expandir os detalhes completos<br><small style="color:#fd7e14;">üü† OPs Em Andamento aparecem primeiro | üü¢ OPs Finalizadas aparecem depois</small></p></div>'
                    : '<div style="text-align:center;margin-bottom:20px;padding:12px;background:#f0f8e8;border-radius:8px;border-left:4px solid #27ae60;"><p style="color:#2c3e50;margin:0;">üí° <strong>Modo Detalhado:</strong> Todas as informa√ß√µes vis√≠veis<br><small style="color:#fd7e14;">üü† OPs Em Andamento aparecem primeiro | üü¢ OPs Finalizadas aparecem depois</small></p></div>';
                
                if(window.viewMode==='list'){
                    el.innerHTML = modeDescription + sortedList.map(o=>buildCompactItem(o)).join('');
                }else{
                    el.innerHTML = modeDescription + sortedList.map(o=>buildDetailedCard(o)).join('');
                }
            }

            function duplicateOrder(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(!order){showNotification('Erro: Ordem n√£o encontrada!','error');return;}
                fillFormWithTemplate(order);
                document.getElementById('quantidade').value='';
                document.getElementById('status').value='Em Andamento';
                showNotification(`Dados da ordem ${orderId} carregados para nova ordem!`,'success');
                document.querySelector('.main-content-new').scrollIntoView({behavior:'smooth'});
            }

            async function advanceStep(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(order&&order.currentStep<4){
                    order.currentStep++;
                    if(order.currentStep===4){order.status='Finalizado';}
                    await setJSON('productionOrders', orders);
                    displayOrders();updateStats();
                    showNotification(`Ordem ${orderId} avan√ßou para a pr√≥xima etapa!`,'success');
                }
            }
            async function deleteOrder(orderId){
                if(confirm('Tem certeza que deseja excluir esta ordem de produ√ß√£o?')){
                    try {
                        // Remove do array local e localStorage
                        orders=orders.filter(o=>o.id!==orderId);
                        await setJSON('productionOrders', orders);
                        displayOrders();updateStats();updateGraficaFilter();
                        showNotification(`Ordem ${orderId} exclu√≠da com sucesso!`,'info');
                    } catch (error) {
                        console.error('Erro ao excluir ordem:', error);
                        showNotification('‚ùå Erro ao excluir ordem: ' + error.message, 'error');
                    }
                }
            }

            /* IMPRESS√ÉO ‚Äì preservando formata√ß√£o e sem bloco de ‚ÄúProcesso de Produ√ß√£o‚Äù */
            function printOrderModal(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(!order){showNotification('Ordem n√£o encontrada!','error');return;}

                const printHTML = `
                    <div class="print-header">
                        <h1 style="color:#2c3e50;font-size:22px;margin:0 0 6px 0;">ORDEM DE PRODU√á√ÉO</h1>
                        <h2 style="color:#667eea;font-size:18px;margin:0 0 6px 0;">${order.id}</h2>
                        ${order.nomeTemplate?`<h3 style="color:#2c3e50;font-size:16px;margin:0 0 6px 0;">üì¶ ${order.nomeTemplate}</h3>`:''}
                        <p style="color:#666;margin:2px 0;">Data: ${order.dataCreated} ${order.timeCreated?'√†s '+order.timeCreated:''}</p>
                        <p style="color:#666;margin:2px 0;">Status: ${order.status} | Prioridade: ${order.prioridade||'M√©dia'}</p>
                        ${order.fornecedor?`<p style="color:#666;margin:2px 0;">Gr√°fica: üè¢ ${order.fornecedor}</p>`:''}
                        ${order.lastModified?`<p style="color:#e67e22;margin:2px 0;font-size:12px;">√öltima edi√ß√£o: ${order.lastModified}</p>`:''}
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0;">
                        <div>
                            <h3 style="color:#2c3e50;margin-bottom:8px;font-size:14px;">üìè Especifica√ß√µes</h3>
                            <table style="width:100%;border-collapse:collapse;">
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Formato:</td><td style="padding:6px 0;color:#333;">${order.formato||'-'}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">C√≥digo da Faca:</td><td style="padding:6px 0;color:#333;">${order.codigoFaca||'-'}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Medidas da Folha Impressa:</td><td style="padding:6px 0;color:#333;">${order.medidasFolha}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Quantidade:</td><td style="padding:6px 0;color:#333;">${parseInt(order.quantidade).toLocaleString()}</td></tr>
                                ${order.folhasResma?`<tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Folhas/Resma:</td><td style="padding:6px 0;color:#333;">${order.folhasResma}</td></tr>`:''}
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Tipo de Papel:</td><td style="padding:6px 0;color:#333;">${order.tipoPapel}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Gramatura:</td><td style="padding:6px 0;color:#333;">${order.gramatura}</td></tr>
                                ${order.resmasUsadas?`<tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Resmas utilizadas:</td><td style="padding:6px 0;color:#333;">${order.resmasUsadas}</td></tr>`:''}
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Impress√£o:</td><td style="padding:6px 0;color:#333;">${order.impressao}</td></tr>
                                ${order.fornecedor?`<tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Gr√°fica:</td><td style="padding:6px 0;color:#333;">üè¢ ${order.fornecedor}</td></tr>`:''}
                                ${order.enviadoFaca||order.enviadoChapa||order.enviadoImpressao?`
                                    <tr style="border-bottom:1px solid #ddd;">
                                        <td style="padding:6px 0;font-weight:bold;color:#333;">Pr√©-produ√ß√£o:</td>
                                        <td style="padding:6px 0;color:#333;">
                                            ${order.enviadoFaca?'‚Ä¢ Enviado p/ faca&nbsp;&nbsp;':''}
                                            ${order.enviadoChapa?'‚Ä¢ Gravar chapa&nbsp;&nbsp;':''}
                                            ${order.enviadoImpressao?'‚Ä¢ Impress√£o':''}
                                        </td>
                                    </tr>
                                `:''}
                            </table>
                        </div>

                        ${order.imagemFaca||order.imagemArte?`
                        <div>
                            <h3 style="color:#2c3e50;margin-bottom:8px;font-size:14px;">üñºÔ∏è Imagens</h3>
                            <div class="print-images" style="grid-template-columns:1fr 1fr;gap:10px;margin:0;">
                                ${order.imagemFaca?`<div class="print-image" style="text-align:center;"><div style="font-size:12px;margin-bottom:4px;">üîß Faca</div><img src="${order.imagemFaca}" alt="Faca" style="max-height:220px;border:1px solid #ddd;border-radius:8px;"></div>`:''}
                                ${order.imagemArte?`<div class="print-image" style="text-align:center;"><div style="font-size:12px;margin-bottom:4px;">üé® Arte</div><img src="${order.imagemArte}" alt="Arte" style="max-height:220px;border:1px solid #ddd;border-radius:8px;"></div>`:''}
                            </div>
                        </div>`:`<div></div>`}
                    </div>

                    <div style="margin:8px 0;">
                        <h3 style="color:#2c3e50;margin-bottom:6px;font-size:14px;">üé® Acabamento</h3>
                        <div style="background:#f8f9fa;padding:10px;border-radius:8px;border-left:4px solid #667eea;">
                            <pre style="white-space:pre-wrap;margin:0;font-size:13px;line-height:1.45;color:#333;">${order.acabamento}</pre>
                        </div>
                    </div>

                    <div style="margin:8px 0;">
                        <h3 style="color:#2c3e50;margin-bottom:6px;font-size:14px;">  Observa√ß√£o</h3>
                        <div style="background:#f8f9fa;padding:10px;border-radius:8px;border-left:4px solid #667eea;">
                            <pre style="white-space:pre-wrap;margin:0;font-size:13px;line-height:1.45;color:#333;">${order.descricaoEmbalagens}</pre>
                        </div>
                    </div>
                `;
                document.getElementById('printContent').innerHTML=printHTML;
                document.getElementById('printModal').style.display='block';
                const modal=document.getElementById('printModal');const modalContent=document.getElementById('printContent');
                modal.style.visibility='visible';modalContent.style.visibility='visible';modalContent.style.display='block';
                showNotification('Preview da impress√£o carregado!','success');
            }

            function closePrintModal(){document.getElementById('printModal').style.display='none';}
            function printOrder(){
                const modal=document.getElementById('printModal');
                const content=document.getElementById('printContent');
                if(modal.style.display==='none'||!content.innerHTML.trim()){showNotification('Erro: Nenhum conte√∫do para imprimir!','error');return;}
                content.style.display='block';content.style.visibility='visible';
                setTimeout(()=>{try{window.print();showNotification('Enviando para impress√£o...','info');}catch(e){console.error(e);showNotification('Erro ao imprimir. Tente novamente.','error');}},300);
            }

            function exportData(){
                if(orders.length===0){showNotification('Nenhuma ordem para exportar.','info');return;}
                const dataStr=JSON.stringify({orders,productTemplates},null,2);
                const blob=new Blob([dataStr],{type:'application/json'});
                const url=URL.createObjectURL(blob);
                const a=document.createElement('a');a.href=url;a.download=`ordens_producao_completo_${new Date().toISOString().split('T')[0]}.json`;a.click();
                showNotification('Dados exportados com sucesso!','success');
            }
            function importData(){document.getElementById('importFile').click();}
            


            async function handleImport(ev){
                const file=ev.target.files[0];if(!file)return;
                const r=new FileReader();
                r.onload=async e=>{
                    try{
                        const imported=JSON.parse(e.target.result);
                        if(imported.orders&&Array.isArray(imported.orders)){
                            orders=imported.orders;
                            if(imported.productTemplates&&Array.isArray(imported.productTemplates)){productTemplates=imported.productTemplates;await setJSON('productTemplates', productTemplates);}
                            
                            await setJSON('productionOrders', orders);displayOrders();updateStats();updateGraficaFilter();showNotification('Dados importados com sucesso!','success');
                        }else if(Array.isArray(imported)){
                            orders=imported;
                            
                            await setJSON('productionOrders', orders);displayOrders();updateStats();updateGraficaFilter();showNotification('Dados importados com sucesso!','success');
                        }else{throw new Error('Formato inv√°lido');}
                    }catch(err){showNotification('Erro ao importar dados. Verifique o formato do arquivo.','error');}
                };
                r.readAsText(file);
            }

            async function clearAllData(){
                if(confirm('ATEN√á√ÉO: Isso ir√° excluir TODAS as ordens de produ√ß√£o E modelos salvos. Esta a√ß√£o n√£o pode ser desfeita. Deseja continuar?')){
                    orders=[];productTemplates=[];orderIdCounter=1;
                    
                    // Limpa localStorage
                    localStorage.removeItem('productionOrders');localStorage.removeItem('productTemplates');localStorage.removeItem('orderIdCounter');
                    
                    displayOrders();updateStats();updateGraficaFilter();showNotification('Todos os dados foram removidos.','info');
                }
            }

            // Inicializa√ß√£o principal da aplica√ß√£o
            async function initializeApp() {
                try {
                    await loadInitialData();
                    setViewMode(viewMode);
                    displayOrders();
                    updateStats();
                    updateGraficaFilter(); // Atualizar filtro de gr√°ficas
                    await migrateAndCompactOrdersIfNeeded();
                    
                    showNotification('‚úÖ Sistema carregado com localStorage!', 'success');
                } catch (e) {
                    console.error('Erro na inicializa√ß√£o:', e);
                    showNotification('Erro ao carregar dados.', 'warning');
                }
            }

            // Inicializa√ß√£o quando o DOM estiver pronto
            document.addEventListener('DOMContentLoaded', initializeApp);

            // Fechar modais ao clicar fora
            window.onclick=function(e){
                const pm=document.getElementById('printModal');
                const em=document.getElementById('editModal');
                const tm=document.getElementById('templatesModal');
                if(e.target===pm)closePrintModal();
                if(e.target===em)closeEditModal();
                if(e.target===tm)closeTemplatesModal();
            }

        // Auto-salvar ass√≠ncrono
            setInterval(async ()=>{
                try{
                    if(orders.length>0) await setJSON('productionOrders', orders);
                    if(productTemplates.length>0) await setJSON('productTemplates', productTemplates);
                } catch(e) {
                    console.warn('Auto-save error:', e);
                }
            }, 30000);

            // Listeners de impress√£o
            window.addEventListener('beforeprint',function(){const pc=document.getElementById('printContent');if(pc){pc.style.display='block !important';pc.style.visibility='visible !important';}});
            window.addEventListener('afterprint',function(){showNotification('Impress√£o enviada!','success');});
        
            /* ===== Scroll FAB (Topo <-> Ordens) ===== */
    document.addEventListener('DOMContentLoaded', function(){
        let initialized = false;
        function initFab(){
            if(initialized) return;
            const fab = document.getElementById('scrollFab');
            const ordersSection = document.querySelector('.orders-list');
            if(!fab) return;
            initialized = true;

            function atTop(){ return (window.scrollY || document.documentElement.scrollTop || 0) < 150; }
            function updateFab(){
                if(atTop()){
                    fab.textContent = 'üìã';
                    fab.setAttribute('aria-label','Ir para Ordens');
                    fab.title = 'Ir para Ordens';
                }else{
                    fab.textContent = '‚¨ÜÔ∏è';
                    fab.setAttribute('aria-label','Voltar ao topo');
                    fab.title = 'Voltar ao topo';
                }
            }
            fab.addEventListener('click', function(){
                if(atTop()){
                    if(ordersSection){ ordersSection.scrollIntoView({behavior:'smooth', block:'start'}); }
                }else{
                    window.scrollTo({top:0, behavior:'smooth'});
                }
            });
            window.addEventListener('scroll', updateFab, {passive:true});
            updateFab();
        }
        initFab();
        window.addEventListener('load', initFab, {once:true});
    });
    /* ===== Compatibilidade Mobile (evitar zoom em inputs no iOS) ===== */
            (function(){
                try{
                    const set16 = el => el && (el.style.fontSize = '16px');
                    document.querySelectorAll('input, select, textarea, button').forEach(set16);
                }catch(e){/* no-op */}
            })();
    window.addEventListener('error', function(e){ try{ if(typeof showNotification==='function'){ showNotification('‚ö†Ô∏è Erro de script detectado. Verifique os dados/a√ß√µes recentes.', 'warning'); } }catch(_){} });
    </script>

        <!-- Bot√£o Flutuante: Topo / Ir para Ordens -->
        <button id="scrollFab" class="fab" aria-label="Ir para Ordens" title="Ir para Ordens">üìã</button>


        <!-- Modal Envio √† Gr√°fica -->
        <div id="graficaModal" class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeGraficaModal()">&times;</span>
                <div class="print-preview">
                    <div class="print-header">
                        <h1>üì¶ Relat√≥rio de Envio √† Gr√°fica</h1>
                        <p id="graficaMeta"></p>
                    </div>
                    <div id="graficaOrders"></div>
                    <div id="graficaTotais" style="margin-top:15px;"></div>
                </div>
                <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #ddd;">
                    <button class="btn btn-primary" onclick="printGraficaReport()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                    <button class="btn btn-warning" onclick="closeGraficaModal()">‚ùå Fechar</button>
                </div>
            </div>
        </div>
        
    </body>
    </html>
