    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
        <title>Sistema de Ordem de Produção - Embalagens</title>
    <style>
            *{margin:0;padding:0;box-sizing:border-box}
            body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
            .container{max-width:1400px;margin:0 auto;padding:20px}
            .header{background:rgba(255,255,255,.95);padding:20px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);text-align:center}
            .header h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;font-weight:700}
            .header p{color:#7f8c8d;font-size:1.2em}

            .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px}
            .stat-card{background:rgba(255,255,255,.9);padding:20px;border-radius:10px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.1)}
            .stat-number{font-size:2.5em;font-weight:bold;margin-bottom:5px}
            .stat-label{color:#6c757d;font-size:.9em;text-transform:uppercase}

            /* === Novos Estilos para Interface Reorganizada === */
            .top-actions{background:rgba(255,255,255,.95);padding:15px 20px;border-radius:12px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,.1);}
            .action-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
            .action-buttons .btn{padding:10px 18px;font-size:14px;}
            
            .main-content-new{max-width:1200px;margin:0 auto;}
            .form-card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
            
            /* Sistema de Abas */
            .form-tabs{display:flex;gap:0;margin-bottom:25px;background:#f1f3f4;border-radius:10px;padding:4px;overflow-x:auto;}
            .tab-btn{background:transparent;border:none;padding:12px 20px;border-radius:8px;font-weight:600;color:#6c757d;cursor:pointer;transition:all 0.3s ease;white-space:nowrap;flex:1;}
            .tab-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 12px rgba(102,126,234,.3);}
            .tab-btn:hover:not(.active){background:#e9ecef;color:#495057;}
            
            /* Conteúdo das Abas */
            .tab-content{display:none;}
            .tab-content.active{display:block;animation:fadeIn 0.3s ease;}
            @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
            
            /* Status de Produção Compacto */
            .production-status{background:#f8f9ff;border:2px solid #e8f2ff;border-radius:10px;padding:15px;margin:15px 0;}
            .production-status h4{color:#2c3e50;margin-bottom:12px;font-size:16px;}
            .process-checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin-bottom:15px;}
            .checkbox-label{display:flex;align-items:center;gap:8px;color:#495057;font-weight:500;cursor:pointer;padding:8px;border-radius:6px;transition:background 0.3s;}
            .checkbox-label:hover{background:#e8f4fd;}
            .checkbox-label input[type="checkbox"]{transform:scale(1.2);}
            
            .process-flow-compact{display:flex;flex-wrap:wrap;gap:8px;}
            .process-flow-compact .process-step{padding:6px 12px;background:#e9ecef;border-radius:15px;font-size:12px;color:#495057;}
            
            /* Botão de Criar Melhorado */
            .btn-create{width:100%;margin-top:25px;padding:15px;font-size:18px;font-weight:700;background:linear-gradient(135deg,#28a745 0%,#20c997 100%);border:none;border-radius:10px;color:white;box-shadow:0 8px 25px rgba(40,167,69,.3);transition:all 0.3s ease;}
            .btn-create:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(40,167,69,.4);}
            
            /* Layout Responsivo para Abas */
            @media (max-width:768px){
                .form-tabs{flex-direction:column;}
                .tab-btn{text-align:center;}
                .action-buttons{justify-content:stretch;}
                .action-buttons .btn{flex:1;}
                .process-checkboxes{grid-template-columns:1fr;}
            }

            /* === Estilos da Barra de Navegação === */
            .topbar{background:rgba(255,255,255,.95);padding:15px 20px;box-shadow:0 5px 20px rgba(0,0,0,.1);display:flex;gap:15px;justify-content:center;margin-bottom:20px;}
            .topbar button{padding:12px 25px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px;}
            #go-op{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;}
            #go-ficha{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;}
            #btnGoOrcamentos{background:linear-gradient(135deg,#fd79a8 0%,#e84393 100%);color:#fff;}
            .topbar button:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.3);}

            /* === Estilos da Ficha Técnica === */
            .ft .container{max-width:1400px;margin:0 auto;padding:20px}
            .ft .header{background:rgba(255,255,255,.95);padding:20px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);text-align:center}
            .ft .header h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;font-weight:700}
            .ft .header p{color:#7f8c8d;font-size:1.2em}
            .ft .form-card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
            .ft .section{margin-bottom:30px;border-bottom:2px solid #f1f3f4;padding-bottom:25px}
            .ft .section:last-child{border-bottom:none;margin-bottom:0}
            .ft .section h2{color:#2c3e50;margin-bottom:20px;font-size:1.8em;display:flex;align-items:center;gap:10px}
            .ft .form-group{margin-bottom:20px}
            .ft .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
            .ft .form-row.three-col{grid-template-columns:1fr 1fr 1fr}
            .ft .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#34495e}
            .ft .form-group input,.ft .form-group textarea{width:100%;padding:12px 15px;border:2px solid #e0e6ed;border-radius:8px;font-size:16px;transition:all .3s ease;background:#f8f9fa}
            .ft .form-group input:focus,.ft .form-group textarea:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
            .ft .form-group textarea{height:100px;resize:vertical}
            .ft .image-upload{border:3px dashed #ddd;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .3s ease;background:#f8f9fa}
            .ft .image-upload:hover{border-color:#667eea;background:#f0f4ff}
            .ft .image-upload.dragover{border-color:#667eea;background:#e8f2ff}
            .ft .image-preview{max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
            .ft .form-actions{display:flex;gap:15px;justify-content:center;margin-top:30px;padding-top:20px;border-top:2px solid #f1f3f4}
            .ft .btn{padding:12px 25px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}
            .ft .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
            .ft .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.3)}
            .ft .btn-success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff}
            .ft .btn-secondary{background:linear-gradient(135deg,#636e72 0%,#2d3436 100%);color:#fff}

            @media (max-width:768px){
                .ft .form-row{grid-template-columns:1fr}
                .ft .form-row.three-col{grid-template-columns:1fr}
                .ft .form-actions{flex-direction:column}
                .topbar{flex-direction:column;gap:10px}
            }
            .card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
            .card h2{color:#2c3e50;margin-bottom:20px;font-size:1.8em;display:flex;align-items:center;gap:10px}

            .form-group{margin-bottom:20px}
            .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
            .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#34495e}
            .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 15px;border:2px solid #e0e6ed;border-radius:8px;font-size:16px;transition:all .3s ease;background:#f8f9fa}
            .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
            .form-group textarea{height:100px;resize:vertical}

            .image-upload{border:3px dashed #ddd;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .3s ease;background:#f8f9fa}
            .image-upload:hover{border-color:#667eea;background:#f0f4ff}
            .image-upload.dragover{border-color:#667eea;background:#e8f2ff}
            .image-preview{max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}

            .product-selector{background:#e8f4fd;border:2px solid #74b9ff;border-radius:10px;padding:15px;margin-bottom:20px}
            .product-selector h3{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
            .product-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;max-height:200px;overflow-y:auto}
            .product-item{background:#fff;border:2px solid #e0e6ed;border-radius:8px;padding:12px;cursor:pointer;transition:all .3s ease}
            .product-item:hover{border-color:#667eea;background:#f8f9ff}
            .product-item.selected{border-color:#667eea;background:#e8f2ff}

            .template-actions{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
            .btn{padding:12px 25px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}
            .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
            .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.3)}
            .btn-success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff}
            .btn-warning{background:linear-gradient(135deg,#ffeaa7 0%,#fab1a0 100%);color:#2d3436}
            .btn-danger{background:linear-gradient(135deg,#fd79a8 0%,#e84393 100%);color:#fff}
            .btn-info{background:linear-gradient(135deg,#74b9ff 0%,#0984e3 100%);color:#fff}
            .btn-secondary{background:linear-gradient(135deg,#636e72 0%,#2d3436 100%);color:#fff}
            .btn-small{padding:8px 15px;font-size:14px}

            .orders-list{grid-column:1 / -1}
            .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
            .filter-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
            .filter-controls select,.filter-controls input{padding:8px 12px;border:2px solid #e0e6ed;border-radius:6px;font-size:14px}

            .view-toggle{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
            .view-toggle .btn{padding:8px 14px;font-size:14px;}
            .view-toggle .btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%) !important;color:white !important;}

            .order-item{background:#fff;padding:20px;margin-bottom:15px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.08);border-left:5px solid #667eea}
            .order-item.priority-high{border-left-color:#e74c3c}
            .order-item.priority-medium{border-left-color:#f39c12}
            .order-item.priority-low{border-left-color:#27ae60}
            
            /* Compact item styling */
            .compact-item{background:#fff;padding:15px;margin-bottom:10px;border-radius:8px;box-shadow:0 3px 15px rgba(0,0,0,.08);border-left:4px solid #667eea;transition:all 0.3s ease;}
            .compact-item:hover{box-shadow:0 5px 20px rgba(0,0,0,.12);}
            
            /* Indicadores visuais para status de produção */
            .order-item.production-complete{border-left-color:#28a745 !important;background:#f8fff8 !important;}
            .order-item.production-pending{border-left-color:#dc3545 !important;background:#fff8f8 !important;}
            .compact-item.production-complete{border-left-color:#28a745 !important;background:#f8fff8 !important;}
            .compact-item.production-pending{border-left-color:#dc3545 !important;background:#fff8f8 !important;}
            
            .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
            .order-id{font-weight:bold;color:#2c3e50;font-size:1.2em}
            .status{padding:5px 15px;border-radius:20px;font-weight:600;text-transform:uppercase;font-size:12px}
            .status.em-andamento{background:#ffeaa7;color:#2d3436}
            .status.finalizado{background:#55efc4;color:#2d3436}
            .priority{padding:3px 8px;border-radius:15px;font-size:11px;font-weight:600;text-transform:uppercase}
            .priority.alta{background:#ffebee;color:#c62828}
            .priority.media{background:#fff8e1;color:#f57c00}
            .priority.baixa{background:#e8f5e8;color:#2e7d32}

            .process-flow{display:flex;gap:10px;margin:10px 0;flex-wrap:wrap}
            .process-step{padding:6px 12px;background:#f8f9fa;border-radius:20px;font-size:13px;border:2px solid #e9ecef}
            .process-step.completed{background:#d4edda;border-color:#c3e6cb;color:#155724}
            .process-step.current{background:#fff3cd;border-color:#ffeaa7;color:#856404}

            .order-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:15px 0}
            .detail-item{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
            .detail-label{font-weight:600;color:#6c757d;margin-right:2px}

            .order-images{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:15px 0}
            .order-image{text-align:center}
            .order-image img{max-width:100%;max-height:150px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.1)}

            .order-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
            .compact-item{padding:14px 16px;background:#fff;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.06);border-left:5px solid #667eea;margin-bottom:8px;transition:all 0.3s ease;position:relative;}
            .compact-item:hover{box-shadow:0 8px 25px rgba(0,0,0,.12);transform:translateY(-1px);}
            
            /* === SISTEMA DE CORES POR STATUS === */
            /* Status: Finalizado - VERDE */
            .compact-item.status-finalizado{border-left:5px solid #28a745;background:linear-gradient(135deg, rgba(40,167,69,0.05) 0%, rgba(32,201,151,0.08) 100%);}
            .compact-item.status-finalizado:hover{box-shadow:0 8px 25px rgba(40,167,69,.25);}
            
            /* Status: Em Andamento - LARANJA */
            .compact-item.status-em-andamento{border-left:5px solid #fd7e14;background:linear-gradient(135deg, rgba(253,126,20,0.05) 0%, rgba(255,193,7,0.08) 100%);}
            .compact-item.status-em-andamento:hover{box-shadow:0 8px 25px rgba(253,126,20,.25);}
            
            /* Selos de Status */
            .status-badge{position:absolute;top:10px;right:10px;padding:4px 12px;border-radius:15px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;z-index:10;}
            .status-badge.finalizado{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;box-shadow:0 3px 10px rgba(40,167,69,.3);}
            .status-badge.em-andamento{background:linear-gradient(135deg,#fd7e14 0%,#ffc107 100%);color:white;box-shadow:0 3px 10px rgba(253,126,20,.3);}
            
            /* Para cartões detalhados também */
            .order-card.status-finalizado{border:2px solid #28a745;background:linear-gradient(135deg, rgba(40,167,69,0.03) 0%, rgba(32,201,151,0.05) 100%);}
            .order-card.status-em-andamento{border:2px solid #fd7e14;background:linear-gradient(135deg, rgba(253,126,20,0.03) 0%, rgba(255,193,7,0.05) 100%);}
            
            /* Status visual na meta-informação */
            .compact-meta .status-text.finalizado{color:#28a745;font-weight:700;}
            .compact-meta .status-text.em-andamento{color:#fd7e14;font-weight:700;}
            .compact-title{display:flex;gap:8px;align-items:center;font-weight:600;color:#2c3e50;}
            .compact-meta{font-size:12px;color:#6c757d;margin-top:4px;}
            .compact-expanded{margin-top:12px;border-top:1px dashed #e0e6ed;padding-top:12px;background:#f8f9ff;padding:15px;border-radius:8px;}
            
            /* Tags de Gráfica (Terceirização) */
            .grafica-tag{background:#e8f4fd !important;color:#0984e3 !important;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px;margin-left:8px;box-shadow:0 2px 4px rgba(9,132,227,0.2);}
            .grafica-tag-detailed{background:#e8f4fd !important;color:#0984e3 !important;padding:4px 10px;border-radius:15px;font-size:12px;font-weight:bold;display:inline-flex;align-items:center;gap:4px;margin-left:8px;box-shadow:0 2px 6px rgba(9,132,227,0.3);}

            .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5)}
            .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:15px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
            .modal-content.large{max-width:900px}
            .modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:15px 15px 0 0;margin:-20px -20px 20px -20px;}
            .modal-header h2{margin:0;color:#fff;}
            .modal-header .close{color:#fff;}
            #bulkProductionStatusModal .modal-content{max-width:800px;}
            .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
            .close:hover{color:#000}

            .print-preview{background:#fff;padding:30px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.1)}
            .print-header{text-align:center;margin-bottom:20px;border-bottom:3px solid #667eea;padding-bottom:12px}
            .print-images{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin:18px 0}
            .print-image{text-align:center}
            .print-image img{max-width:100%;max-height:300px;border:2px solid #ddd;border-radius:10px}

            .edit-form{background:#fff;padding:30px;border-radius:15px}
            .edit-form h2{color:#2c3e50;margin-bottom:25px;font-size:1.8em;text-align:center;border-bottom:2px solid #667eea;padding-bottom:15px}
            .edit-actions{display:flex;gap:15px;justify-content:center;margin-top:30px;padding-top:20px;border-top:1px solid #eee}
            .current-image-preview{max-width:150px;max-height:150px;border-radius:8px;margin:10px 0;border:2px solid #ddd}

            @media print{
                @page{size:A4 portrait;margin:8mm}
                *{-webkit-print-color-adjust:exact !important;color-adjust:exact !important;print-color-adjust:exact !important}
                body{background:#fff !important}
                .container,.header,.stats-row,.main-content,.orders-list,.modal-content>div:last-child{display:none !important}
                /* Esconder completamente o modal de gráfica durante impressão de OP */
                #graficaModal,#graficaModal *{display:none !important;visibility:hidden !important}
                /* Estilos para navegação e páginas */
                #topnav{display:none !important}
                #page-op[hidden], #page-ficha[hidden]{display:none !important}
                /* Mostrar apenas o modal de impressão individual */
                #printModal{display:block !important;position:static !important;background:#fff !important;width:100% !important;height:auto !important}
                #printModal .modal-content{margin:0 !important;padding:0 !important;width:100% !important;max-width:100% !important;max-height:none !important;background:#fff !important;box-shadow:none !important;border-radius:0 !important}
                #printModal .print-preview{display:block !important;visibility:visible !important;padding:5px !important;margin:0 !important;background:#fff !important;box-shadow:none !important;border-radius:0 !important}
                .print-header h1,.print-header h2,.print-header p{color:#000 !important;margin:3px 0 !important}
                #printModal .print-preview,#printModal .print-preview *{break-inside:avoid-page !important;page-break-inside:avoid !important}
                #printModal .print-preview{font-size:12px !important;line-height:1.3 !important}
                
                /* Layout adaptativo para impressão */
                .print-layout-adaptive{display:block !important;}
                
                /* Imagens na parte inferior por padrão */
                #printModal .print-images-bottom img{max-height:280px !important;max-width:100% !important}
                #printModal .print-images{gap:12px !important;margin:8px 0 !important}
                
                /* Se a página ficar muito cheia, usa layout lateral */
                @media print and (max-height: 280mm) {
                    .print-layout-adaptive{display:grid !important;grid-template-columns:1fr 1fr !important;gap:10px !important;}
                    .print-images-container{grid-column:1 / -1 !important;}
                    #printModal .print-images-bottom img{max-height:220px !important;}
                }
                
                /* Para páginas muito compactas, força layout lateral */
                @media print and (max-height: 250mm) {
                    .print-layout-adaptive{display:grid !important;grid-template-columns:1fr 1fr !important;gap:8px !important;}
                    .print-images-container{grid-column:2 !important;grid-row:1 / 3 !important;}
                    #printModal .print-images-bottom{grid-template-columns:1fr !important;}
                    #printModal .print-images-bottom img{max-height:180px !important;}
                }
                
                .close{display:none !important}
                #printModal .print-preview table{border-collapse:collapse !important;width:100% !important;max-width:600px !important;margin:0 auto !important}
                #printModal .print-preview td{border-bottom:1px solid #ddd !important;padding:4px 0 !important}
            }

            @media (max-width:768px){
                .main-content-new{padding:0 10px;}
                .form-tabs{flex-direction:column;}
                .tab-btn{text-align:center;}
                .action-buttons{justify-content:stretch;flex-direction:column;}
                .action-buttons .btn{flex:1;margin-bottom:8px;}
                .process-checkboxes{grid-template-columns:1fr;}
                .form-row{grid-template-columns:1fr}
                .order-details{grid-template-columns:1fr}
                .order-images{grid-template-columns:1fr}
                .print-images{grid-template-columns:1fr}
                .stats-row{grid-template-columns:repeat(2,1fr)}
                .filter-controls{justify-content:center}
                .edit-actions{flex-direction:column;align-items:center}
                .product-list{grid-template-columns:1fr}
                .template-actions{justify-content:center}
            }

            .notification{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;color:#fff;font-weight:600;z-index:2000;transform:translateX(400px);transition:transform .3s ease}
            .notification.show{transform:translateX(0)}
            .notification.success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
            .notification.error{background:linear-gradient(135deg,#fd79a8 0%,#e84393 100%)}
            .notification.info{background:linear-gradient(135deg,#74b9ff 0%,#0984e3 100%)}
        
            /* === Botão Flutuante (Topo/Ordens) === */
            :root{ --safe-bottom: env(safe-area-inset-bottom); }
            .fab{
                position:fixed; right:20px; bottom:calc(20px + var(--safe-bottom));
                width:56px; height:56px; border-radius:50%; border:none;
                background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                color:#fff; font-size:22px; font-weight:700;
                display:flex; align-items:center; justify-content:center;
                box-shadow:0 12px 30px rgba(0,0,0,.25);
                cursor:pointer; z-index:2500;
                transition:transform .2s ease, box-shadow .2s ease, opacity .25s ease;
            }
            .fab:focus{outline:none; box-shadow:0 0 0 4px rgba(102,126,234,.25), 0 12px 30px rgba(0,0,0,.25)}
            @media (hover:hover){
                .fab:hover{transform:translateY(-3px); box-shadow:0 16px 32px rgba(0,0,0,.3)}
            }
            .fab.hide{opacity:0; pointer-events:none; transform:translateY(20px)}
            /* Ajustes mobile extras */
            html,body{-webkit-text-size-adjust:100%}
            .btn{min-height:44px}
            @media (max-width:480px){
                .container{padding:12px}
                .header h1{font-size:1.8em}
                .header p{font-size:1em}
                .btn{width:100%}
                .view-toggle{width:100%; justify-content:center}
            }

        </style>
    </head>
    <body>
        <!-- Barra de Navegação -->
        <nav id="topnav" class="topbar">
            <button id="go-op" type="button">Ordem de Produção</button>
            <button id="go-ficha" type="button">Ficha Técnica do Produto</button>
            <button id="btnGoOrcamentos" type="button">Orçamentos</button>
        </nav>

        <!-- Página de Ordem de Produção -->
        <main id="page-op" aria-label="Ordem de Produção">
        <div class="container">
            <div class="header">
                <h1>🏭 Sistema de Ordem de Produção Gráfica</h1>
                <p>Gestão Completa de Embalagens em Papel Cartão</p>
            </div>

            <!-- Estatísticas -->
            <div class="stats-row">
                <div class="stat-card"><div class="stat-number" style="color:#667eea;" id="totalOrders">0</div><div class="stat-label">Total de Ordens</div></div>
                <div class="stat-card"><div class="stat-number" style="color:#f39c12;" id="inProgressOrders">0</div><div class="stat-label">Em Andamento</div></div>
                <div class="stat-card"><div class="stat-number" style="color:#27ae60;" id="completedOrders">0</div><div class="stat-label">Finalizadas</div></div>
                <div class="stat-card"><div class="stat-number" style="color:#e74c3c;" id="totalProducts">0</div><div class="stat-label">Produtos Únicos</div></div>
            </div>

            <!-- Botões de Ação Rápida no Topo -->
            <div class="top-actions">
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="exportData()">📅 Exportar Dados</button>
                    <button class="btn btn-warning" onclick="importData()">📅 Importar Dados</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Limpar Tudo</button>
                    <button class="btn btn-secondary" onclick="manageTemplates()">🗊 Gerenciar Modelos</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(event)">
            </div>

            <div class="main-content-new">
                <div class="card form-card">
                    <h2>📝 Nova Ordem de Produção</h2>

                    <!-- Abas do Formulário -->
                    <div class="form-tabs">
                        <button class="tab-btn active" onclick="switchTab('basico')" type="button">1. 📄 Informações Básicas</button>
                        <button class="tab-btn" onclick="switchTab('especificacoes')" type="button">2. 📀 Especificações</button>
                        <button class="tab-btn" onclick="switchTab('producao')" type="button">3. 🏭 Produção</button>
                        <button class="tab-btn" onclick="switchTab('imagens')" type="button">4. 🗺 Imagens & Descrições</button>
                    </div>

                    <form id="orderForm">
                        <!-- Aba 1: Informações Básicas -->
                        <div id="tab-basico" class="tab-content active">
                            <div class="product-selector">
                                <h3>🗂️ Produtos Anteriores</h3>
                                <div class="template-actions">
                                    <button type="button" class="btn btn-info btn-small" onclick="showProductHistory()">📋 Ver Histórico</button>
                                    <button type="button" class="btn btn-warning btn-small" onclick="clearForm()">🗑️ Limpar Formulário</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="saveAsTemplate()">💾 Salvar como Modelo</button>
                                </div>
                                <div id="productList" class="product-list" style="display:none;"></div>
                                <button type="button" id="clearSelectionBtn" class="clear-selection" onclick="clearSelection()" style="display:none;">❌ Limpar Seleção</button>
                            </div>

                            <div class="form-group">
                                <label for="nomeTemplate">Nome do Produto (para histórico)</label>
                                <input type="text" id="nomeTemplate" placeholder="Ex: Caixa Pizza Grande, Sacola Kraft, etc." required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="medidasFolha">Medidas da Folha de Impressão</label>
                                    <input type="text" id="medidasFolha" placeholder="Ex: 70x100cm" required>
                                </div>
                                <div class="form-group">
                                    <label for="quantidade">Quantidade de Impressão</label>
                                    <input type="number" id="quantidade" placeholder="1000" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" required>
                                        <option value="Em Andamento">Em Andamento</option>
                                        <option value="Finalizado">Finalizado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="prioridade">Prioridade</label>
                                    <select id="prioridade" required>
                                        <option value="Média">Média</option>
                                        <option value="Alta">Alta</option>
                                        <option value="Baixa">Baixa</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Aba 2: Especificações -->
                        <div id="tab-especificacoes" class="tab-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="formato">FORMATO</label>
                                    <input type="text" id="formato" placeholder="">
                                </div>
                                <div class="form-group">
                                    <label for="codigoFaca">Código da Faca</label>
                                    <input type="text" id="codigoFaca" placeholder="Ex: FAC-1234">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="tipoPapel">Tipo de Papel</label>
                                    <input list="tipoPapelOptions" id="tipoPapel" placeholder="Digite ou selecione o tipo de papel" required>
                                    <datalist id="tipoPapelOptions">
                                        <option value="Papel Kraft 66x96">
                                        <option value="Papel Kraft 77x113">
                                        <option value="papel duplex 66x96">
                                        <option value="papel duplex 77x113">
                                        <option value="papel triplex 66x96">
                                        <option value="papel triplex 77x113">
                                        <option value="Papel Couche 66x96">
                                        <option value="Papel Couche 77x113">
                                    </datalist>
                                </div>
                                <div class="form-group">
                                    <label for="gramatura">Gramatura do Papel</label>
                                    <input list="gramaturaOptions" id="gramatura" placeholder="Digite ou selecione a gramatura" required>
                                    <datalist id="gramaturaOptions">
                                        <option value="70g">
                                        <option value="90g">
                                        <option value="170g">
                                        <option value="190g">
                                        <option value="210g">
                                        <option value="220g">
                                        <option value="225g">
                                        <option value="240g">
                                        <option value="250g">
                                        <option value="270g">
                                        <option value="300g">
                                        <option value="350g">
                                    </datalist>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="impressao">Tipo de Impressão</label>
                                    <select id="impressao" required>
                                        <option value="Frente 4x0">Frente 4x0</option>
                                        <option value="Frente e Verso 4x4">Frente e Verso 4x4</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="fornecedor">GRÁFICA</label>
                                    <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                                </div>
                            </div>
                        </div>

                        <!-- Aba 3: Produção -->
                        <div id="tab-producao" class="tab-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="folhasResma">Quantidade de folhas</label>
                                    <input type="text" id="folhasResma" placeholder="Ex: 500 folhas (2 remas com 250)">
                                </div>
                                <div class="form-group">
                                    <label for="resmasUsadas">Resmas utilizadas nesta ordem</label>
                                    <input type="number" id="resmasUsadas" placeholder="Ex: 2" min="0" step="0.01">
                                </div>
                            </div>

                            <!-- Status de Produção -->
                            <div class="production-status">
                                <h4>🔄 Status da Produção</h4>
                                <div class="process-checkboxes">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enviadoFaca">
                                        <span>Enviado para produção da faca</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enviadoChapa">
                                        <span>Enviado para gravar chapa</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enviadoImpressao">
                                        <span>Enviado para impressão</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Aba 4: Imagens & Descrições -->
                        <div id="tab-imagens" class="tab-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Imagem da Faca</label>
                                    <div class="image-upload" onclick="document.getElementById('imagemFaca').click()">
                                        <input type="file" id="imagemFaca" accept="image/*" style="display:none;">
                                        <p>📁 Clique para selecionar a imagem da faca</p>
                                        <img id="previewFaca" class="image-preview" style="display:none;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Imagem da Montagem da Arte</label>
                                    <div class="image-upload" onclick="document.getElementById('imagemArte').click()">
                                        <input type="file" id="imagemArte" accept="image/*" style="display:none;">
                                        <p>🎨 Clique para selecionar a imagem da arte</p>
                                        <img id="previewArte" class="image-preview" style="display:none;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="acabamento">Acabamento</label>
                                <textarea id="acabamento" placeholder="Descreva os acabamentos (quebras de linha serão preservadas no PDF)" required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="descricaoEmbalagens">Observação</label>
                                <textarea id="descricaoEmbalagens" placeholder="Observações gerais sobre a ordem de produção (formatação preservada no PDF)" required></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-create">✅ Criar Ordem de Produção</button>
                    </form>
                </div>
            </div>

            <!-- Espaçamento entre seções -->
            <div style="margin: 40px 0;"></div>

            <div class="card orders-list">>
                <div class="list-header">
                    <h2>📋 Ordens de Produção</h2>
                    <div class="view-toggle">
                        <button class="btn btn-secondary btn-small" id="btnLista" onclick="setViewMode('list')">Modo Lista</button>
                        <button class="btn btn-secondary btn-small" id="btnDetalhado" onclick="setViewMode('detailed')">Modo Detalhado</button>
                    </div>
                <div class="template-actions">
                    <button class="btn btn-info btn-small" onclick="openSendToGraficaModal()">📦 Enviar à Gráfica</button>
                    <button class="btn btn-warning btn-small" onclick="openBulkProductionStatusModal()">🔄 Status da Produção</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleSelectAll()">☑️ Selecionar Todos</button>
                </div>
            
                    <div class="filter-controls">
                        <select id="filterStatus" onchange="filterOrders()">
                            <option value="">Todos os Status</option>
                            <option value="Em Andamento">Em Andamento</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                        <select id="filterPriority" onchange="filterOrders()">
                            <option value="">Todas as Prioridades</option>
                            <option value="Alta">Alta</option>
                            <option value="Média">Média</option>
                            <option value="Baixa">Baixa</option>
                        </select>
                        <select id="filterProductionStatus" onchange="filterOrders()">
                            <option value="">Status da Produção</option>
                            <option value="todas-completas">🟢 Todas Etapas Completas</option>
                            <option value="falta-faca">🔴 Falta Produção da Faca</option>
                            <option value="falta-chapa">🔴 Falta Gravar Chapa</option>
                            <option value="falta-impressao">🔴 Falta Impressão</option>
                            <option value="alguma-pendente">🟡 Alguma Etapa Pendente</option>
                        </select>
                        <select id="filterGrafica" onchange="filterOrders()">
                            <option value="">Todas as Gráficas</option>
                            <!-- Opções serão preenchidas dinamicamente -->
                        </select>
                        <input type="text" id="searchOrders" placeholder="Buscar por OP, produto, gráfica..." onkeyup="filterOrders()">
                    </div>
                </div>
                <div id="ordersList"></div>
            </div>
        </div>

        <!-- Modal para impressão -->
        <div id="printModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePrintModal()">&times;</span>
                <div id="printContent" class="print-preview"></div>
                <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #ddd;">
                    <button class="btn btn-primary" onclick="printOrder()">🖨️ Imprimir Ordem</button>
                    <button class="btn btn-warning" onclick="closePrintModal()">❌ Fechar</button>
                </div>
            </div>
        </div>

        <!-- Modal para edição -->
        <div id="editModal" class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <div class="edit-form">
                    <h2>✏️ Editar Ordem de Produção</h2>
                    <form id="editForm">
                        <input type="hidden" id="editOrderId">

                        <div class="form-group">
                            <label for="editNomeTemplate">Nome do Produto</label>
                            <input type="text" id="editNomeTemplate" placeholder="Nome do produto" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMedidasFolha">Medidas da Folha de Impressão</label>
                                <input type="text" id="editMedidasFolha" placeholder="Ex: 70x100cm" required>
                            </div>
                            <div class="form-group">
                                <label for="editQuantidade">Quantidade de Impressão</label>
                                <input type="number" id="editQuantidade" placeholder="1000" required>
                            </div>
                        </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editFormato">FORMATO</label>
                    <input type="text" id="editFormato" placeholder="Ex: Tampa e Base, Gaveta, Sacola, etc.">
                </div>
                <div class="form-group">
                    <label for="editCodigoFaca">Código da Faca</label>
                    <input type="text" id="editCodigoFaca" placeholder="Ex: FAC-1234">
                </div>
            </div>

                        <div class="form-row">
                            <div class="form-group" style="grid-column:1 / -1;">
                                <label for="editFolhasResma">Quantidade de folhas/resma</label>
                                <input type="text" id="editFolhasResma" placeholder="Ex: 500 folhas (2 remas com 250)">
                            </div>
                        </div>
            <div class="form-row">
                <div class="form-group" style="grid-column:1 / -1;">
                    <label for="editResmasUsadas">Resmas utilizadas nesta ordem</label>
                    <input type="number" id="editResmasUsadas" placeholder="Ex: 2" min="0" step="0.01">
                </div>
            </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editFornecedor">Fornecedor (Terceirização)</label>
                                <input type="text" id="editFornecedor" placeholder="Nome do fornecedor">
                            </div>
                            <div class="form-group">
                                <label for="editStatus">Status</label>
                                <select id="editStatus" required>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Finalizado">Finalizado</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTipoPapel">Tipo de Papel</label>
                                <input list="editTipoPapelOptions" id="editTipoPapel" placeholder="Digite ou selecione o tipo de papel" required>
                                <datalist id="editTipoPapelOptions">
                                    <option value="Papel Kraft 66x96">
                                    <option value="Papel Kraft 77x113">
                                    <option value="papel duplex 66x96">
                                    <option value="papel duplex 77x113">
                                    <option value="papel triplex 66x96">
                                    <option value="papel triplex 77x113">
                                    <option value="Papel Couche 66x96">
                                    <option value="Papel Couche 77x113">
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label for="editGramatura">Gramatura do Papel</label>
                                <input list="editGramaturaOptions" id="editGramatura" placeholder="Digite ou selecione a gramatura" required>
                                <datalist id="editGramaturaOptions">
                                    <option value="70g">
                                    <option value="90g">
                                    <option value="170g">
                                    <option value="190g">
                                    <option value="210g">
                                    <option value="220g">
                                    <option value="225g">
                                    <option value="240g">
                                    <option value="250g">
                                    <option value="270g">
                                    <option value="300g">
                                    <option value="350g">
                                </datalist>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editImpressao">Tipo de Impressão</label>
                                <select id="editImpressao" required>
                                    <option value="Frente 4x0">Frente 4x0</option>
                                    <option value="Frente e Verso 4x4">Frente e Verso 4x4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editPrioridade">Prioridade</label>
                                <select id="editPrioridade" required>
                                    <option value="Média">Média</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </div>
                        </div>

                        <!-- Pré-produção (edição) -->
                        <div class="form-row">
                            <div class="form-group">
                                <label><input type="checkbox" id="editEnviadoFaca"> Enviado para produção da faca</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="editEnviadoChapa"> Enviado para gravar chapa</label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="grid-column:1 / -1;">
                                <label><input type="checkbox" id="editEnviadoImpressao"> Enviado para impressão</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editAcabamento">Acabamento</label>
                            <textarea id="editAcabamento" placeholder="Descreva os acabamentos necessários" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="editDescricaoEmbalagens">Observação</label>
                            <textarea id="editDescricaoEmbalagens" placeholder="Observações gerais sobre a ordem de produção" required></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Imagem da Faca</label>
                                <div id="currentImageFaca" style="text-align:center;margin:10px 0;"></div>
                                <div class="image-upload" onclick="document.getElementById('editImagemFaca').click()">
                                    <input type="file" id="editImagemFaca" accept="image/*" style="display:none;">
                                    <p>📁 Clique para alterar a imagem da faca</p>
                                    <img id="editPreviewFaca" class="image-preview" style="display:none;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Imagem da Montagem da Arte</label>
                                <div id="currentImageArte" style="text-align:center;margin:10px 0;"></div>
                                <div class="image-upload" onclick="document.getElementById('editImagemArte').click()">
                                    <input type="file" id="editImagemArte" accept="image/*" style="display:none;">
                                    <p>🎨 Clique para alterar a imagem da arte</p>
                                    <img id="editPreviewArte" class="image-preview" style="display:none;">
                                </div>
                            </div>
                        </div>

                        <div class="edit-actions">
                            <button type="submit" class="btn btn-success">💾 Salvar Alterações</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">❌ Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para gerenciar modelos -->
        <div id="templatesModal" class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeTemplatesModal()">&times;</span>
                <div style="padding:20px;">
                    <h2 style="text-align:center;margin-bottom:30px;">🗂️ Gerenciar Modelos de Produtos</h2>
                    <div id="templatesContent"></div>
                    <div style="text-align:center;margin-top:20px;">
                        <button class="btn btn-warning" onclick="closeTemplatesModal()">❌ Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para edição em lote do Status da Produção -->
        <div id="bulkProductionStatusModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close" onclick="closeBulkProductionStatusModal()">&times;</span>
                    <h2>🔄 Status da Produção - Edição em Lote</h2>
                </div>
                <div style="padding:20px;">
                    <div id="bulkStatusMeta" style="text-align:center;margin-bottom:20px;color:#6c757d;"></div>
                    
                    <div style="background:#f8f9ff;border:2px solid #e8f2ff;border-radius:10px;padding:20px;margin-bottom:20px;">
                        <h3 style="color:#2c3e50;margin-bottom:15px;">Atualizar Status para OPs Selecionadas:</h3>
                        <div class="process-checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" id="bulkEnviadoFaca">
                                <span>Enviado para produção da faca</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="bulkEnviadoChapa">
                                <span>Enviado para gravar chapa</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="bulkEnviadoImpressao">
                                <span>Enviado para impressão</span>
                            </label>
                        </div>
                    </div>

                    <div id="bulkStatusOrders" style="max-height:300px;overflow-y:auto;border:1px solid #e0e6ed;border-radius:8px;padding:15px;background:#f8f9fa;"></div>
                    
                    <div style="text-align:center;margin-top:20px;">
                        <button class="btn btn-success" onclick="applyBulkProductionStatus()">✅ Aplicar Mudanças</button>
                        <button class="btn btn-secondary" onclick="closeBulkProductionStatusModal()">❌ Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notificações -->
        <div id="notification" class="notification"></div>

        <script>
            
    // Storage simples com localStorage apenas (versão única)
    const storage = window.appStorage || (window.appStorage = (function(){
        // Testa localStorage tradicional
        const localStorageWorks = (function(){
            try {
                const testKey = '__t__';
                localStorage.setItem(testKey, '1');
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                return false;
            }
        })();

        // Fallback em memória se localStorage não funcionar
        const memStorage = {};
        const fallbackStorage = {
            getItem: (k) => (k in memStorage ? memStorage[k] : null),
            setItem: (k, v) => { memStorage[k] = String(v); },
            removeItem: (k) => { delete memStorage[k]; }
        };

        return {
            getItem: async (key) => {
                // Usa localStorage se disponível
                if (localStorageWorks) {
                    const value = localStorage.getItem(key);
                    console.log(`📱 LocalStorage get for key: ${key}, found: ${value !== null}`);
                    return value;
                }
                const value = fallbackStorage.getItem(key);
                console.log(`💾 Memory storage get for key: ${key}, found: ${value !== null}`);
                return value;
            },
            
            setItem: async (key, value) => {
                // Usa localStorage se disponível
                if (localStorageWorks) {
                    try {
                        localStorage.setItem(key, value);
                        console.log(`📱 LocalStorage save successful for key: ${key}`);
                    } catch (e) {
                        console.warn("localStorage.setItem failed:", e);
                    }
                } else {
                    fallbackStorage.setItem(key, value);
                    console.log(`💾 Memory storage save for key: ${key}`);
                }
            },
            
            removeItem: async (key) => {
                if (localStorageWorks) {
                    localStorage.removeItem(key);
                } else {
                    fallbackStorage.removeItem(key);
                }
            }
        };
    })()) || storage;

    async function getJSON(key, fallback){
        try {
            console.log(`🔍 getJSON called for key: ${key}`);
            const v = await storage.getItem(key);
            return v ? JSON.parse(v) : fallback;
        } catch(e){
            console.warn(`getJSON error for key ${key}:`, e);
            return fallback;
        }
    }

    async function setJSON(key, value){
        try { 
            console.log(`🔄 setJSON called for key: ${key}`);
            await storage.setItem(key, JSON.stringify(value)); 
        } catch(e){
            console.error("setJSON error:", e);
        }
    }

    // Variáveis globais - carregadas do localStorage
    let orders = [];
    let orderIdCounter = 1;
    let productTemplates = [];

    // Função para carregar dados iniciais
    async function loadInitialData() {
        try {
            // Carrega do localStorage
            orders = await getJSON('productionOrders', []);
            orderIdCounter = parseInt((await storage.getItem('orderIdCounter')) || '1');
            productTemplates = await getJSON('productTemplates', []);
            
            console.log(`📦 Carregadas ${orders.length} ordens do localStorage`);
        } catch (e) {
            console.error("Erro carregando dados:", e);
            orders = [];
            orderIdCounter = 1;
            productTemplates = [];
        }
    }
    // === Seleção de OPs para Envio à Gráfica ===
    let selectedOrderIds = new Set();
    function toggleSelectOrder(orderId, checked){
        if(checked){ selectedOrderIds.add(orderId); } else { selectedOrderIds.delete(orderId); }
    }
    function isSelected(orderId){ return selectedOrderIds.has(orderId); }
    function toggleSelectAll(){
        const list = document.querySelectorAll('input.select-order');
        const anyUnchecked = Array.from(list).some(cb => !cb.checked);
        Array.from(list).forEach(cb=>{
            cb.checked = anyUnchecked;
            const id = cb.getAttribute('data-order-id');
            toggleSelectOrder(id, anyUnchecked);
        });
        showNotification(anyUnchecked ? 'Todas as OPs visíveis selecionadas.' : 'Seleção limpa.', 'info');
    }
    function openSendToGraficaModal(){
        if(selectedOrderIds.size===0){ showNotification('Selecione pelo menos uma OP.', 'error'); return; }
        const selected = orders.filter(o => selectedOrderIds.has(o.id));
        document.getElementById('graficaMeta').textContent = `Total de ordens selecionadas: ${selected.length}`;
        const rows = selected.map(o=>{
        const resmas = parseFloat(o.resmasUsadas||0)||0;
        const forn = (o.fornecedor||'').trim();
        return `<tr>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.id}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.nomeTemplate||''}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${forn}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.tipoPapel||''}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${o.gramatura||''}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;text-align:right;">${resmas.toLocaleString('pt-BR')}</td>
        </tr>`;
    }).join('');
        document.getElementById('graficaOrders').innerHTML = `
            <h3 style="margin:10px 0;color:#2c3e50;">📋 Ordens Selecionadas</h3>
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">OP</th>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Produto</th>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Fornecedor</th><th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Papel</th>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Gramatura</th>
                    <th style="text-align:right;border-bottom:2px solid #333;padding:6px;">Resmas</th>
                </tr></thead>
                <tbody>${rows || '<tr><td colspan="5" style="padding:8px;">(sem dados)</td></tr>'}</tbody>
            </table>
        `;
        const mapa = {};
    for(const o of selected){
        const forn = (o.fornecedor||'').trim();
        const key = `${forn} | ${(o.tipoPapel||'').trim()} | ${(o.gramatura||'').trim()}`;
            const val = parseFloat(o.resmasUsadas||0)||0;
            mapa[key] = (mapa[key]||0) + val;
        }
        const totalRows = Object.entries(mapa).map(([k,v])=>`
            <tr>
                <td style="padding:6px;border-bottom:1px solid #eee;">${k}</td>
                <td style="padding:6px;border-bottom:1px solid #eee;text-align:right;">${v.toLocaleString('pt-BR')}</td>
            </tr>`).join('');
        const totalConsolidado = Object.values(mapa).reduce((a,b)=>a+b,0);
        document.getElementById('graficaTotais').innerHTML = `
            <h3 style="margin:16px 0;color:#2c3e50;">🧮 Totais Consolidados</h3>
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr>
                    <th style="text-align:left;border-bottom:2px solid #333;padding:6px;">Fornecedor | Papel | Gramatura</th>
                    <th style="text-align:right;border-bottom:2px solid #333;padding:6px;">Resmas</th>
                </tr></thead>
                <tbody>
                    ${totalRows || '<tr><td colspan="2" style="padding:8px;">(sem dados)</td></tr>'}
                    <tr>
                        <td style="padding:8px;font-weight:700;border-top:2px solid #333;">TOTAL GERAL</td>
                        <td style="padding:8px;font-weight:700;text-align:right;border-top:2px solid #333;">${totalConsolidado.toLocaleString('pt-BR')}</td>
                    </tr>
                </tbody>
            </table>
        `;
        document.getElementById('graficaModal').style.display='block';
    }
    function closeGraficaModal(){ document.getElementById('graficaModal').style.display='none'; }
    function printGraficaReport(){
        const m = document.getElementById('graficaModal');
        if(!m) return;
        const w = window.open('', 'PRINT', 'height=800,width=1000');
        const content = m.querySelector('.print-preview').outerHTML;
        w.document.write('<html><head><title>Relatório de Envio à Gráfica</title><meta charset="utf-8"></head><body>');
        w.document.write('<style>body{font-family:Segoe UI,Tahoma,Arial,sans-serif;padding:20px;} table{width:100%;border-collapse:collapse;} th,td{font-size:12px;} .print-header{text-align:center;margin-bottom:10px;border-bottom:2px solid #667eea;padding-bottom:8px;}</style>');
        w.document.write(content);
        w.document.write('</body></html>');
        w.document.close(); w.focus(); w.print(); w.close();
    }

    // === Funções para Status de Produção em Lote ===
    function openBulkProductionStatusModal(){
        if(selectedOrderIds.size===0){ showNotification('Selecione pelo menos uma OP.', 'error'); return; }
        const selected = orders.filter(o => selectedOrderIds.has(o.id));
        document.getElementById('bulkStatusMeta').textContent = `Total de ordens selecionadas: ${selected.length}`;
        
        // Limpar checkboxes
        document.getElementById('bulkEnviadoFaca').checked = false;
        document.getElementById('bulkEnviadoChapa').checked = false;
        document.getElementById('bulkEnviadoImpressao').checked = false;
        
        // Listar ordens selecionadas
        const ordersList = selected.map(o => {
            const statusAtual = [
                {ok: o.enviadoFaca, label:'Faca'},
                {ok: o.enviadoChapa, label:'Chapa'},
                {ok: o.enviadoImpressao, label:'Impressão'}
            ];
            const statusText = statusAtual.map(s => s.ok ? `✅ ${s.label}` : `⭕ ${s.label}`).join(' | ');
            
            return `
                <div style="padding:8px;margin:4px 0;background:#fff;border-radius:6px;border-left:4px solid #667eea;">
                    <div style="font-weight:600;color:#2c3e50;">${o.id} ${o.nomeTemplate ? `- ${o.nomeTemplate}` : ''}</div>
                    <div style="font-size:12px;color:#6c757d;margin-top:2px;">Status atual: ${statusText}</div>
                </div>
            `;
        }).join('');
        
        document.getElementById('bulkStatusOrders').innerHTML = ordersList;
        document.getElementById('bulkProductionStatusModal').style.display='block';
    }

    function closeBulkProductionStatusModal(){ 
        document.getElementById('bulkProductionStatusModal').style.display='none'; 
    }

    async function applyBulkProductionStatus(){
        if(selectedOrderIds.size===0){ showNotification('Nenhuma OP selecionada.', 'error'); return; }
        
        const enviadoFaca = document.getElementById('bulkEnviadoFaca').checked;
        const enviadoChapa = document.getElementById('bulkEnviadoChapa').checked;
        const enviadoImpressao = document.getElementById('bulkEnviadoImpressao').checked;
        
        let updateCount = 0;
        for(const orderId of selectedOrderIds){
            const order = orders.find(o => o.id === orderId);
            if(order){
                if(enviadoFaca) order.enviadoFaca = true;
                if(enviadoChapa) order.enviadoChapa = true;
                if(enviadoImpressao) order.enviadoImpressao = true;
                updateCount++;
            }
        }
        
        if(updateCount > 0){
            await setJSON('productionOrders', orders);
            displayOrders();
            showNotification(`Status de produção atualizado para ${updateCount} OP(s)!`, 'success');
        }
        
        closeBulkProductionStatusModal();
    }


    // ===== Utils: Quota-safe storage & image compression =====
    function estimateBytesFromDataURL(dataURL){
        try{
            const base64 = dataURL.split(',')[1] || '';
            // 4/3 base64 expansion; approximate
            return Math.ceil((base64.length * 3) / 4);
        }catch(e){ return 0; }
    }

    function compressFileToDataURL(file, maxDim=1280, quality=0.8){
        return new Promise((resolve,reject)=>{
            try{
                const img = new Image();
                const reader = new FileReader();
                reader.onload = ev => {
                    img.onload = ()=>{
                        try{
                            const canvas = document.createElement('canvas');
                            let {width, height} = img;
                            const scale = Math.min(1, maxDim/Math.max(width, height));
                            width = Math.round(width*scale); height = Math.round(height*scale);
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            // Prefer JPEG to reduce size
                            let out = canvas.toDataURL('image/jpeg', quality);
                            resolve(out);
                        }catch(err){ reject(err); }
                    };
                    img.onerror = reject;
                    img.src = ev.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }catch(err){ reject(err); }
        });
    }

    function compressDataURL(dataURL, maxDim=1280, quality=0.8){
        return new Promise((resolve,reject)=>{
            try{
                const img = new Image();
                img.onload = ()=>{
                    try{
                        const canvas = document.createElement('canvas');
                        let {width, height} = img;
                        const scale = Math.min(1, maxDim/Math.max(width, height));
                        width = Math.round(width*scale); height = Math.round(height*scale);
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const out = canvas.toDataURL('image/jpeg', quality);
                        resolve(out);
                    }catch(err){ reject(err); }
                };
                img.onerror = reject;
                img.src = dataURL;
            }catch(err){ reject(err); }
        });
    }

    // setJSON com retry ao atingir cota: tenta reduzir qualidade de imagens grandes
    async function setJSONRetry(key, value, onQuota){
        try{
            await setJSON(key, value);
            return true;
        }catch(e){
            // Alguns navegadores lançam QuotaExceededError sem permitir catch aqui; então usamos try interno do setJSON.
            return true;
        }
    }

    // Migração: comprime imagens existentes muito grandes (executa na inicialização, sem alterar fluxo do usuário)
    async function migrateAndCompactOrdersIfNeeded(maxTotalBytes=4.5*1024*1024){
        try{
            let changed = false;
            const ordersLocal = await getJSON('productionOrders', []);
            // Estima tamanho atual da string JSON + imagens
            let approx = JSON.stringify(ordersLocal).length;
            if(approx < maxTotalBytes) return; // rápido
            for (let i=0; i<ordersLocal.length; i++){
                const o = ordersLocal[i];
                for (const k of ['imagemFaca','imagemArte']){
                    if(o && o[k] && estimateBytesFromDataURL(o[k]) > 500*1024){
                        // comprime de forma agressiva
                        try{
                            o[k] = await compressDataURL(o[k], 1024, 0.7);
                            changed = true;
                        }catch(_){/* ignore */}
                    }
                }
                approx = JSON.stringify(ordersLocal).length;
                if(approx < maxTotalBytes) break;
            }
            if(changed){
                setJSON('productionOrders', ordersLocal);
            }
        }catch(_){/* ignore */}
    }


            let isEditing = false;
            let selectedTemplate = null;
            let viewMode = localStorage.getItem('ordersViewMode') || 'detailed';
            window.viewMode = viewMode; // 'list' | 'detailed'
            
            // Função para trocar abas
            function switchTab(tabName) {
                try {
                    // Remove active de todas as abas e conteúdos
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Ativa a aba clicada
                    if(event && event.target) {
                        event.target.classList.add('active');
                    }
                    
                    // Ativa o conteúdo da aba
                    const tabContent = document.getElementById('tab-' + tabName);
                    if(tabContent) {
                        tabContent.classList.add('active');
                    } else {
                        console.error('Tab content not found:', 'tab-' + tabName);
                        return;
                    }
                    
                    // Feedback para o usuário
                    const tabNames = {
                        'basico': 'Informações Básicas',
                        'especificacoes': 'Especificações',
                        'producao': 'Produção',
                        'imagens': 'Imagens & Descrições'
                    };
                    showNotification(`Aba: ${tabNames[tabName]}`, 'info');
                } catch(error) {
                    console.error('Erro na função switchTab:', error);
                    showNotification('Erro ao trocar aba. Tente novamente.', 'error');
                }
            }

            function setViewMode(mode){
                try {
                    window.viewMode = mode;
                    localStorage.setItem('ordersViewMode', mode);
                    
                    const bList = document.getElementById('btnLista');
                    const bDet = document.getElementById('btnDetalhado');
                    
                    if(bList) {
                        bList.className = 'btn btn-secondary btn-small';
                        if(mode === 'list') bList.classList.add('active');
                    }
                    if(bDet) {
                        bDet.className = 'btn btn-secondary btn-small';
                        if(mode === 'detailed') bDet.classList.add('active');
                    }
                    
                    // Feedback para o usuário
                    const modeText = mode === 'list' ? 'Lista Compacta' : 'Detalhado Completo';
                    showNotification(`Modo de visualização: ${modeText}`, 'info');
                    
                } catch(e) { 
                    console && console.warn && console.warn('setViewMode warn:', e); 
                }
                try { 
                    displayOrders(); 
                } catch(e) { 
                    console && console.error && console.error('displayOrders err:', e); 
                }
            }


            function updateGraficaFilter() {
                // Extrair todas as gráficas únicas das ordens existentes (campo fornecedor = terceirização)
                const graficasUnicas = [...new Set(orders
                    .map(order => order.fornecedor)
                    .filter(grafica => grafica && grafica.trim() !== '')
                )].sort();
                
                const filterGrafica = document.getElementById('filterGrafica');
                if (!filterGrafica) return;
                
                // Salvar valor selecionado atual
                const currentValue = filterGrafica.value;
                
                // Limpar opções existentes (exceto "Todas as Gráficas")
                filterGrafica.innerHTML = '<option value="">Todas as Gráficas</option>';
                
                // Adicionar gráficas encontradas
                graficasUnicas.forEach(grafica => {
                    const option = document.createElement('option');
                    option.value = grafica;
                    option.textContent = grafica;
                    filterGrafica.appendChild(option);
                });
                
                // Restaurar valor selecionado se ainda existir
                if (currentValue && graficasUnicas.includes(currentValue)) {
                    filterGrafica.value = currentValue;
                }
            }

            function showNotification(message,type='success'){const n=document.getElementById('notification');n.textContent=message;n.className=`notification ${type}`;n.classList.add('show');setTimeout(()=>n.classList.remove('show'),3000);}
            async function generateOrderId(){const id=orderIdCounter;orderIdCounter++;await storage.setItem('orderIdCounter', orderIdCounter.toString());return `OP-${String(id).padStart(4,'0')}`;}
            function updateStats(){const total=orders.length;const emAndamento=orders.filter(o=>o.status==='Em Andamento').length;const finalizadas=orders.filter(o=>o.status==='Finalizado').length;const unicos=new Set(orders.map(o=>o.nomeTemplate)).size;document.getElementById('totalOrders').textContent=total;document.getElementById('inProgressOrders').textContent=emAndamento;document.getElementById('completedOrders').textContent=finalizadas;document.getElementById('totalProducts').textContent=unicos;}

            function showProductHistory(){
                const list=document.getElementById('productList');
                if(productTemplates.length===0){showNotification('Nenhum produto salvo no histórico ainda.','info');return;}
                list.innerHTML=productTemplates.map((t,i)=>`
                    <div class="product-item" onclick="selectTemplate(${i})">
                        <div class="product-name">${t.nomeTemplate}</div>
                        <div class="product-details">${t.tipoPapel} | ${t.gramatura} | ${t.impressao}</div>
                    </div>`).join('');
                list.style.display='grid';document.getElementById('clearSelectionBtn').style.display='block';
            }
            function selectTemplate(i){selectedTemplate=productTemplates[i];document.querySelectorAll('.product-item').forEach(it=>it.classList.remove('selected'));document.querySelectorAll('.product-item')[i].classList.add('selected');fillFormWithTemplate(selectedTemplate);showNotification(`Produto "${selectedTemplate.nomeTemplate}" carregado!`,'success');}
            function fillFormWithTemplate(t){
                const setValueSafely = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value || '';
                    } else {
                        console.warn(`Element ${id} not found`);
                    }
                };
                
                setValueSafely('medidasFolha', t.medidasFolha);
                setValueSafely('fornecedor', t.fornecedor);
                setValueSafely('tipoPapel', t.tipoPapel);
                setValueSafely('gramatura', t.gramatura);
                setValueSafely('impressao', t.impressao || 'Frente 4x0');
                setValueSafely('prioridade', t.prioridade || 'Média');
                setValueSafely('nomeTemplate', t.nomeTemplate);
                setValueSafely('folhasResma', t.folhasResma);
                setValueSafely('acabamento', t.acabamento);
                setValueSafely('descricaoEmbalagens', t.descricaoEmbalagens);
                setValueSafely('formato', t.formato);
                setValueSafely('codigoFaca', t.codigoFaca);
                setValueSafely('resmasUsadas', t.resmasUsadas);
                if(t.imagemFaca){const p=document.getElementById('previewFaca');p.src=t.imagemFaca;p.style.display='block';}
                if(t.imagemArte){const p=document.getElementById('previewArte');p.src=t.imagemArte;p.style.display='block';}
            }
            function clearSelection(){selectedTemplate=null;document.querySelectorAll('.product-item').forEach(it=>it.classList.remove('selected'));document.getElementById('productList').style.display='none';document.getElementById('clearSelectionBtn').style.display='none';}
            function clearForm(){document.getElementById('orderForm').reset();document.getElementById('previewFaca').style.display='none';document.getElementById('previewArte').style.display='none';clearSelection();showNotification('Formulário limpo!','info');}

            async function saveAsTemplate(){
                const nomeElement = document.getElementById('nomeTemplate');
                if (!nomeElement) {
                    showNotification('Erro: Elemento nome do template não encontrado!', 'error');
                    return;
                }
                const nome = nomeElement.value.trim();
                if(!nome){showNotification('Digite o nome do produto antes de salvar como modelo.','error');return;}
                
                const getTemplateValueSafely = (id, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        return element.value || defaultValue;
                    } else {
                        console.warn(`Template element ${id} not found`);
                        return defaultValue;
                    }
                };
                
                const t={
                    nomeTemplate:nome,
                    medidasFolha:getTemplateValueSafely('medidasFolha'),
                    fornecedor:getTemplateValueSafely('fornecedor'),
                    tipoPapel:getTemplateValueSafely('tipoPapel'),
                    gramatura:getTemplateValueSafely('gramatura'),
                    impressao:getTemplateValueSafely('impressao'),
                    prioridade:getTemplateValueSafely('prioridade'),
                    folhasResma:getTemplateValueSafely('folhasResma'),
                    acabamento:getTemplateValueSafely('acabamento'),
                    descricaoEmbalagens:getTemplateValueSafely('descricaoEmbalagens'),
                    formato:getTemplateValueSafely('formato'),
                    codigoFaca:getTemplateValueSafely('codigoFaca'),
                    resmasUsadas:getTemplateValueSafely('resmasUsadas'),
                    imagemFaca:document.getElementById('previewFaca')?.src||null,
                    imagemArte:document.getElementById('previewArte')?.src||null,
                    dataCriacao:new Date().toLocaleDateString('pt-BR'),
                    vezesCriado:1
                };
                const idx=productTemplates.findIndex(x=>x.nomeTemplate===nome);
                if(idx!==-1){if(confirm(`Já existe um modelo com o nome "${nome}". Deseja atualizar?`)){productTemplates[idx]={...t,vezesCriado:productTemplates[idx].vezesCriado+1};showNotification(`Modelo "${nome}" atualizado!`,'success');}}
                else{productTemplates.push(t);showNotification(`Modelo "${nome}" salvo no histórico!`,'success');}
                await setJSON('productTemplates', productTemplates);
            }

            function manageTemplates(){
                const el=document.getElementById('templatesContent');
                if(productTemplates.length===0){el.innerHTML='<p style="text-align:center;padding:40px;color:#6c757d;">Nenhum modelo salvo ainda.</p>';}
                else{
                    el.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;">${
                        productTemplates.map((t,i)=>`
                            <div style="background:#f8f9fa;border:2px solid #e9ecef;border-radius:10px;padding:15px;">
                                <h4 style="color:#2c3e50;margin-bottom:10px;">${t.nomeTemplate}</h4>
                                <p style="font-size:14px;color:#6c757d;margin-bottom:10px;">
                                    <strong>Papel:</strong> ${t.tipoPapel}<br>
                                    <strong>Gramatura:</strong> ${t.gramatura}<br>
                                    <strong>Impressão:</strong> ${t.impressao}<br>
                                    ${t.folhasResma?`<strong>Folhas/Resma:</strong> ${t.folhasResma}<br>`:''}
                                    <strong>Criado:</strong> ${t.dataCriacao}<br>
                                    <strong>Usado:</strong> ${t.vezesCriado} vez(es)
                                </p>
                                <div style="display:flex;gap:5px;flex-wrap:wrap;">
                                    <button class="btn btn-info btn-small" onclick="useTemplate(${i})">🔄 Usar</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteTemplate(${i})">🗑️ Excluir</button>
                                </div>
                            </div>`).join('')
                    }</div>`;
                }
                document.getElementById('templatesModal').style.display='block';
            }
            function useTemplate(i){fillFormWithTemplate(productTemplates[i]);closeTemplatesModal();showNotification(`Modelo "${productTemplates[i].nomeTemplate}" carregado!`,'success');}
            async function deleteTemplate(i){const t=productTemplates[i];if(confirm(`Tem certeza que deseja excluir o modelo "${t.nomeTemplate}"?`)){productTemplates.splice(i,1);await setJSON('productTemplates', productTemplates);manageTemplates();showNotification(`Modelo "${t.nomeTemplate}" excluído!`,'info');}}
            function closeTemplatesModal(){document.getElementById('templatesModal').style.display='none';}

            function imageToBase64(file,cb){const r=new FileReader();r.onload=e=>cb(e.target.result);r.readAsDataURL(file);}
            document.getElementById('imagemFaca').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('previewFaca');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});
            document.getElementById('imagemArte').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('previewArte');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});
            document.getElementById('editImagemFaca').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('editPreviewFaca');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});
            document.getElementById('editImagemArte').addEventListener('change',e=>{const f=e.target.files[0];const p=document.getElementById('editPreviewArte');if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}});

            document.querySelectorAll('.image-upload').forEach(u=>{
                u.addEventListener('dragover',e=>{e.preventDefault();u.classList.add('dragover');});
                u.addEventListener('dragleave',e=>{e.preventDefault();u.classList.remove('dragover');});
                u.addEventListener('drop',e=>{e.preventDefault();u.classList.remove('dragover');const files=e.dataTransfer.files;if(files.length>0){const input=u.querySelector('input[type="file"]');input.files=files;input.dispatchEvent(new Event('change'));}});
            });

            // Criar nova OP
            document.getElementById('orderForm').addEventListener('submit', async function(e){
                e.preventDefault();
                const imgF=document.getElementById('imagemFaca').files[0];
                const imgA=document.getElementById('imagemArte').files[0];
                let imgFData=null, imgAData=null;
                if(imgF){ try{ imgFData = await compressFileToDataURL(imgF, 1280, 0.8);}catch(_){ /* fallback handled below */ } }
                if(imgA){ try{ imgAData = await compressFileToDataURL(imgA, 1280, 0.8);}catch(_){ /* fallback handled below */ } }
                const getValueSafely = (id, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        return element.value || defaultValue;
                    } else {
                        console.warn(`Element ${id} not found for order creation`);
                        return defaultValue;
                    }
                };
                
                const order={
                    id:await generateOrderId(),
                    medidasFolha:getValueSafely('medidasFolha'),
                    quantidade:getValueSafely('quantidade'),
                    folhasResma:getValueSafely('folhasResma'),
                    fornecedor:getValueSafely('fornecedor'),
                    status:getValueSafely('status'),
                    tipoPapel:getValueSafely('tipoPapel'),
                    gramatura:getValueSafely('gramatura'),
                    impressao:getValueSafely('impressao'),
                    prioridade:getValueSafely('prioridade'),
                    nomeTemplate:getValueSafely('nomeTemplate'),
                    
                    formato:getValueSafely('formato'),
                    codigoFaca:getValueSafely('codigoFaca'),
                    resmasUsadas:getValueSafely('resmasUsadas'),
                    enviadoFaca:document.getElementById('enviadoFaca')?.checked || false,
                    enviadoChapa:document.getElementById('enviadoChapa')?.checked || false,
                    enviadoImpressao:document.getElementById('enviadoImpressao')?.checked || false,
                    acabamento:getValueSafely('acabamento'),
                    descricaoEmbalagens:getValueSafely('descricaoEmbalagens'),
                    dataCreated:new Date().toLocaleDateString('pt-BR'),
                    timeCreated:new Date().toLocaleTimeString('pt-BR'),
                    currentStep:0,
                    imagemFaca:imgFData,
                    imagemArte:imgAData
                };
                
                // Nova lógica: salvar ordem individual
                async function saveOrder() {
                    try {
                        // Salva no localStorage
                        orders.push(order);
                        await setJSON('productionOrders', orders);
                        
                        await saveAsTemplate();
                        displayOrders();
                        updateStats();
                        updateGraficaFilter();
                        document.getElementById('orderForm').reset();
                        document.getElementById('previewFaca').style.display='none';
                        document.getElementById('previewArte').style.display='none';
                        clearSelection();
                        showNotification('✅ Ordem de produção criada com sucesso!','success');
                    } catch (error) {
                        console.error('Erro ao salvar ordem:', error);
                        showNotification('❌ Erro ao salvar ordem: ' + error.message, 'error');
                    }
                }
                
                let processed=0;const total=(imgF?1:0)+(imgA?1:0);
                if(total===0){await saveOrder();return;}
                if(imgF){imageToBase64(imgF,async b64=>{order.imagemFaca=b64;processed++;if(processed===total)await saveOrder();});}
                if(imgA){imageToBase64(imgA,async b64=>{order.imagemArte=b64;processed++;if(processed===total)await saveOrder();});}
            });

            // Editar OP
            document.getElementById('editForm').addEventListener('submit', async function(e){
                e.preventDefault();
                const editOrderIdElement = document.getElementById('editOrderId');
                if (!editOrderIdElement) {
                    showNotification('Erro: Formulário de edição não encontrado!', 'error');
                    return;
                }
                const id = editOrderIdElement.value;
                const idx=orders.findIndex(o=>o.id===id);
                if(idx===-1){showNotification('Erro: Ordem não encontrada!','error');return;}
                const order=orders[idx];
                const editImgFInput=document.getElementById('editImagemFaca'); const imgF=(editImgFInput && editImgFInput.files && editImgFInput.files[0])||null;
                const editImgAInput=document.getElementById('editImagemArte'); const imgA=(editImgAInput && editImgAInput.files && editImgAInput.files[0])||null;

                const getEditValueSafely = (id, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            return element.checked;
                        }
                        return element.value || defaultValue;
                    } else {
                        console.warn(`Edit element ${id} not found`);
                        return defaultValue;
                    }
                };

                order.medidasFolha=getEditValueSafely('editMedidasFolha');
                order.quantidade=getEditValueSafely('editQuantidade');
                order.folhasResma=getEditValueSafely('editFolhasResma');
                order.fornecedor=getEditValueSafely('editFornecedor');
                order.status=getEditValueSafely('editStatus');
                order.tipoPapel=getEditValueSafely('editTipoPapel');
                order.gramatura=getEditValueSafely('editGramatura');
                order.impressao=getEditValueSafely('editImpressao');
                order.prioridade=getEditValueSafely('editPrioridade');
                order.nomeTemplate=getEditValueSafely('editNomeTemplate');
                order.enviadoFaca=getEditValueSafely('editEnviadoFaca', false);
                order.enviadoChapa=getEditValueSafely('editEnviadoChapa', false);
                order.enviadoImpressao=getEditValueSafely('editEnviadoImpressao', false);
                order.acabamento=getEditValueSafely('editAcabamento');
                order.descricaoEmbalagens=getEditValueSafely('editDescricaoEmbalagens');
                order.formato=getEditValueSafely('editFormato');
                order.codigoFaca=getEditValueSafely('editCodigoFaca');
                order.resmasUsadas=getEditValueSafely('editResmasUsadas');
                order.lastModified=new Date().toLocaleDateString('pt-BR')+' às '+new Date().toLocaleTimeString('pt-BR');

                let processed=0;const total=(imgF?1:0)+(imgA?1:0);
                
                async function finish(){
                    try {
                        // Atualiza no localStorage
                        orders[idx]=order;
                        await setJSON('productionOrders', orders);
                        
                        displayOrders();updateStats();updateGraficaFilter();closeEditModal();
                        showNotification(`✅ Ordem ${id} atualizada com sucesso!`,'success');
                    } catch (error) {
                        console.error('Erro ao atualizar ordem:', error);
                        showNotification('❌ Erro ao atualizar ordem: ' + error.message, 'error');
                    }
                }
                
                if(total===0){await finish();return;}
                if(imgF){imageToBase64(imgF,async b64=>{order.imagemFaca=b64;processed++;if(processed===total)await finish();});}
                if(imgA){imageToBase64(imgA,async b64=>{order.imagemArte=b64;processed++;if(processed===total)await finish();});}
            });

            function editOrder(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(!order){showNotification('Erro: Ordem não encontrada!','error');return;}
                isEditing=true;
                
                const setValueSafely = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = !!value;
                        } else {
                            element.value = value || '';
                        }
                    } else {
                        console.warn(`Edit element ${id} not found`);
                    }
                };
                
                setValueSafely('editOrderId', order.id);
                setValueSafely('editMedidasFolha', order.medidasFolha);
                setValueSafely('editQuantidade', order.quantidadeImpressao);
                setValueSafely('editFornecedor', order.fornecedor);
                setValueSafely('editStatus', order.status);
                setValueSafely('editTipoPapel', order.tipoPapel);
                setValueSafely('editGramatura', order.gramatura);
                setValueSafely('editImpressao', order.impressao);
                setValueSafely('editPrioridade', order.prioridade || 'Média');
                setValueSafely('editNomeTemplate', order.nomeTemplate);
                setValueSafely('editAcabamento', order.acabamento);
                setValueSafely('editDescricaoEmbalagens', order.descricaoEmbalagens);
                setValueSafely('editFormato', order.formato);
                setValueSafely('editCodigoFaca', order.codigoFaca);
                setValueSafely('editResmasUsadas', order.resmasUsadas);
                setValueSafely('editFolhasResma', order.folhasResma);
                setValueSafely('editEnviadoFaca', order.enviadoFaca);
                setValueSafely('editEnviadoChapa', order.enviadoChapa);
                setValueSafely('editEnviadoImpressao', order.enviadoImpressao);

                const ciF=document.getElementById('currentImageFaca');
                const ciA=document.getElementById('currentImageArte');
                ciF.innerHTML=order.imagemFaca?`<p><strong>Imagem Atual da Faca:</strong></p><img src="${order.imagemFaca}" alt="Faca Atual" class="current-image-preview">`:'<p style="color:#999;">Nenhuma imagem da faca cadastrada</p>';
                ciA.innerHTML=order.imagemArte?`<p><strong>Imagem Atual da Arte:</strong></p><img src="${order.imagemArte}" alt="Arte Atual" class="current-image-preview">`:'<p style="color:#999;">Nenhuma imagem da arte cadastrada</p>';

                document.getElementById('editPreviewFaca').style.display='none';
                document.getElementById('editPreviewArte').style.display='none';
                document.getElementById('editImagemFaca').value='';
                document.getElementById('editImagemArte').value='';
                document.getElementById('editModal').style.display='block';
                showNotification(`Editando ordem ${orderId}`,'info');
            }
            function closeEditModal(){document.getElementById('editModal').style.display='none';isEditing=false;}

            function filterOrders(){
                const st=document.getElementById('filterStatus').value;
                const pr=document.getElementById('filterPriority').value;
                const gr=document.getElementById('filterGrafica').value;
                const ps=document.getElementById('filterProductionStatus').value;
                const q=document.getElementById('searchOrders').value.toLowerCase();
                let filtered=orders.filter(order=>{
                    const sOK=!st||order.status===st;
                    const pOK=!pr||order.prioridade===pr;
                    const gOK=!gr||order.fornecedor===gr;
                    const qOK=!q||order.id.toLowerCase().includes(q)||order.tipoPapel.toLowerCase().includes(q)||order.acabamento.toLowerCase().includes(q)||order.descricaoEmbalagens.toLowerCase().includes(q)||(order.nomeTemplate&&order.nomeTemplate.toLowerCase().includes(q))||(order.fornecedor&&order.fornecedor.toLowerCase().includes(q));
                    
                    // Filtro por status de produção
                    let psOK = true;
                    if(ps){
                        const faca = order.enviadoFaca;
                        const chapa = order.enviadoChapa;
                        const impressao = order.enviadoImpressao;
                        const todasCompletas = faca && chapa && impressao;
                        
                        switch(ps){
                            case 'todas-completas':
                                psOK = todasCompletas;
                                break;
                            case 'falta-faca':
                                psOK = !faca;
                                break;
                            case 'falta-chapa':
                                psOK = !chapa;
                                break;
                            case 'falta-impressao':
                                psOK = !impressao;
                                break;
                            case 'alguma-pendente':
                                psOK = !todasCompletas;
                                break;
                        }
                    }
                    
                    return sOK&&pOK&&gOK&&qOK&&psOK;
                });
                displayOrdersList(filtered);
            }

            /* === Renderizadores === */
            function buildPreProducaoChips(order){
                const chips = [
                    {ok: order.enviadoFaca, label:'Enviado p/ produção da faca'},
                    {ok: order.enviadoChapa, label:'Enviado p/ gravar chapa'},
                    {ok: order.enviadoImpressao, label:'Enviado p/ impressão'}
                ];
                return `<div class="process-flow">${chips.map(c=>`<div class="process-step ${c.ok?'completed':''}">${c.label}${c.ok?' ✅':''}</div>`).join('')}</div>`;
            }

            function buildDetailedCard(order){
                const processSteps=['Corte e Vinco','Desmolde','Acabamento','Selagem','Prateleira'];
                const pClass=order.prioridade?order.prioridade.toLowerCase():'media';
                
                // Verificar status de produção
                const isProductionComplete = order.enviadoFaca && order.enviadoChapa && order.enviadoImpressao;
                const productionStatusClass = isProductionComplete ? 'production-complete' : 'production-pending';
                
                // Definir classes CSS baseadas no status
                const statusClass = order.status === 'Finalizado' ? 'status-finalizado' : 'status-em-andamento';
                const badgeClass = order.status === 'Finalizado' ? 'finalizado' : 'em-andamento';
                const statusIcon = order.status === 'Finalizado' ? '✅' : '🔄';
                const statusBadgeText = order.status === 'Finalizado' ? '✅ Finalizado' : '🔄 Em Andamento';
                
                return `
                <div class="order-item order-card ${statusClass} ${productionStatusClass} priority-${pClass==='média'?'medium':pClass==='alta'?'high':'low'}" style="position:relative;">
                    <div class="status-badge ${badgeClass}" style="position:absolute;top:15px;right:15px;">${statusBadgeText}</div>
                    <div class="order-header">
                        <div onclick="event.stopPropagation();" style="display:inline-block;cursor:default;margin-right:8px;">
                            <input type="checkbox" class="select-order" data-order-id="${order.id}" onchange="event.stopPropagation();toggleSelectOrder('${order.id}', this.checked)" onclick="event.stopPropagation();" ${isSelected(order.id)?'checked':''}>
                        </div>
                        <span class="order-id">${order.id}</span>
                        ${order.nomeTemplate?`<span style="background:#e8f4fd;color:#2c3e50;padding:3px 8px;border-radius:12px;font-size:12px;margin-left:10px;">📦 ${order.nomeTemplate}</span>`:''}
                        ${order.fornecedor?`<span class="grafica-tag-detailed">🏢 ${order.fornecedor}</span>`:''}
                        <span class="priority ${pClass}">${order.prioridade||'Média'}</span>
                        <span style="margin-left:15px;color:#6c757d;">${order.dataCreated} ${order.timeCreated?'às '+order.timeCreated:''}</span>
                        ${order.lastModified?`<span style="margin-left:10px;color:#e67e22;font-size:12px;">(Editado: ${order.lastModified})</span>`:''}
                        <span class="status ${order.status.toLowerCase().replace(' ','-')}" style="font-weight:700;">${statusIcon} ${order.status}</span>
                    </div>

                    <div>
                        <div class="preprod-label">Pré-produção</div>
                        ${buildPreProducaoChips(order)}
                    </div>

                    <div class="process-flow">
                        ${processSteps.map((s,i)=>`<div class="process-step ${i<order.currentStep?'completed':i===order.currentStep?'current':''}">${i+1}. ${s}</div>`).join('')}
                    </div>

                    <div class="order-details">
                        ${order.formato?`<div class="detail-item"><span class="detail-label">Formato: </span><span>${order.formato}</span></div>`:""}
                        ${order.codigoFaca?`<div class="detail-item"><span class="detail-label">Código da Faca: </span><span>${order.codigoFaca}</span></div>`:""}
                        <div class="detail-item"><span class="detail-label">Medidas: </span><span>${order.medidasFolha}</span></div>
                        <div class="detail-item"><span class="detail-label">Quantidade: </span><span>${parseInt(order.quantidade).toLocaleString()}</span></div>
                        ${order.folhasResma?`<div class="detail-item"><span class="detail-label">Folhas/Resma: </span><span>${order.folhasResma}</span></div>`:''}
                        ${order.resmasUsadas?`<div class="detail-item"><span class="detail-label">Resmas: </span><span>${order.resmasUsadas}</span></div>`:""}
                        <div class="detail-item"><span class="detail-label">Papel: </span><span>${order.tipoPapel}</span></div>
                        <div class="detail-item"><span class="detail-label">Gramatura: </span><span>${order.gramatura}</span></div>
                        <div class="detail-item"><span class="detail-label">Impressão: </span><span>${order.impressao}</span></div>
                        ${order.fornecedor?`<div class="detail-item"><span class="detail-label">Gráfica (Terceirização): </span><span>🏢 ${order.fornecedor}</span></div>`:''}
                    </div>

                    ${order.imagemFaca||order.imagemArte?`
                    <div class="order-images">
                        ${order.imagemFaca?`<div class="order-image"><h4>Imagem da Faca</h4><img src="${order.imagemFaca}" alt="Faca"></div>`:''}
                        ${order.imagemArte?`<div class="order-image"><h4>Montagem da Arte</h4><img src="${order.imagemArte}" alt="Arte"></div>`:''}
                    </div>`:''}

                    <div style="margin:15px 0;">
                        <strong>Acabamento:</strong>
                        <p style="margin-top:5px;background:#f8f9fa;padding:10px;border-radius:5px;">${order.acabamento}</p>
                    </div>

                    <div style="margin:15px 0;">
                        <strong>Observação:</strong>
                        <p style="margin-top:5px;background:#f8f9fa;padding:10px;border-radius:5px;">${order.descricaoEmbalagens}</p>
                    </div>

                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="printOrderModal('${order.id}')">🖨️ Imprimir</button>
                        <button class="btn btn-success" onclick="advanceStep('${order.id}')">➡️ Próxima Etapa</button>
                        <button class="btn btn-warning" onclick="editOrder('${order.id}')">✏️ Editar</button>
                        <button class="btn btn-info btn-small" onclick="duplicateOrder('${order.id}')">📋 Duplicar</button>
                        <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">🗑️ Excluir</button>
                    </div>
                </div>`;
            }

            
    function buildCompactItem(order){
                // Linha resumida sem prioridade conforme solicitado: OP-0001 📦 Caixa para 4 Doces 27/09/2025 às 03:43:59
                const resumeLine = `${order.id} ${order.nomeTemplate ? `📦 ${order.nomeTemplate}` : ''} ${order.dataCreated}${order.timeCreated ? ` às ${order.timeCreated}` : ''}`;
                const detailHtml = buildDetailedCard(order);
                const safeId = `exp_${order.id.replace(/[^a-zA-Z0-9_-]/g,'')}`;
                
                // Verificar status de produção
                const isProductionComplete = order.enviadoFaca && order.enviadoChapa && order.enviadoImpressao;
                const productionStatusClass = isProductionComplete ? 'production-complete' : 'production-pending';
                
                // Definir classes CSS baseadas no status
                const statusClass = order.status === 'Finalizado' ? 'status-finalizado' : 'status-em-andamento';
                const badgeClass = order.status === 'Finalizado' ? 'finalizado' : 'em-andamento';
                const statusTextClass = order.status === 'Finalizado' ? 'finalizado' : 'em-andamento';
                
                // Ícone e texto do selo
                const statusIcon = order.status === 'Finalizado' ? '✅' : '🔄';
                const statusBadgeText = order.status === 'Finalizado' ? '✅ Finalizado' : '🔄 Em Andamento';
                
                // Tag da gráfica (usando campo fornecedor = terceirização)
                const graficaTag = order.fornecedor ? `<span class="grafica-tag">🏢 ${order.fornecedor}</span>` : '';
                
                // Status da Produção (pré-produção) - chips compactos
                const statusProducao = [
                    {ok: order.enviadoFaca, label:'Faca', icon:'🔧'},
                    {ok: order.enviadoChapa, label:'Chapa', icon:'📋'},
                    {ok: order.enviadoImpressao, label:'Impressão', icon:'🖨️'}
                ];
                const statusChips = statusProducao.map(s => 
                    `<span style="display:inline-block;padding:2px 6px;margin:1px;border-radius:8px;font-size:10px;font-weight:bold;${s.ok ? 'background:#28a745;color:white;' : 'background:#e9ecef;color:#6c757d;'}">${s.icon} ${s.label}${s.ok ? ' ✅' : ''}</span>`
                ).join('');
                
                return `
                <div class="compact-item ${statusClass} ${productionStatusClass}" onclick="toggleExpand('${safeId}')" style="cursor:pointer;transition:all 0.3s ease;">
                    <div class="status-badge ${badgeClass}">${statusBadgeText}</div>
                    <div style="display:flex;align-items:center;">
                        <div onclick="event.stopPropagation();" style="cursor:default;margin-right:8px;">
                            <input type="checkbox" class="select-order" data-order-id="${order.id}" onchange="event.stopPropagation();toggleSelectOrder('${order.id}', this.checked)" onclick="event.stopPropagation();" ${isSelected(order.id)?'checked':''}>
                        </div>
                        <div class="compact-title" style="flex:1;font-weight:600;color:#2c3e50;" onclick="toggleExpand('${safeId}')">${resumeLine}</div>
                        <div data-hint style="margin-left:10px;color:#6c757d;font-size:12px;">👆 Clique para expandir</div>
                    </div>
                    <div class="compact-meta" style="font-size:12px;margin-top:4px;margin-left:24px;">Status: <span class="status-text ${statusTextClass}">${statusIcon} ${order.status}</span>${graficaTag}</div>
                    <div class="compact-production-status" style="font-size:11px;margin-top:6px;margin-left:24px;">
                        <span style="color:#495057;font-weight:600;">🔄 Status da Produção:</span> ${statusChips}
                    </div>
                    
                    <div id="${safeId}" class="compact-expanded" style="display:none;margin-top:15px;border-top:1px dashed #e0e6ed;padding-top:15px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h4 style="color:#2c3e50;margin:0;">📋 Detalhes Completos da ${order.id}</h4>
                            <button class="btn btn-info btn-small" onclick="event.stopPropagation();scrollToAndHighlight('${safeId}')">👁️ Ver OP Completa</button>
                        </div>
                        ${detailHtml}
                    </div>
                </div>`;
            }
            function toggleExpand(id){
                const el = document.getElementById(id);
                if(!el) return;
                
                const isExpanded = el.style.display === 'block';
                const parentCard = el.closest('.compact-item');
                
                if(isExpanded) {
                    // Fechando
                    el.style.display = 'none';
                    if(parentCard) {
                        parentCard.style.backgroundColor = '';
                        const hint = parentCard.querySelector('[data-hint]');
                        if(hint) hint.textContent = '👆 Clique para expandir';
                    }
                } else {
                    // Abrindo
                    el.style.display = 'block';
                    if(parentCard) {
                        parentCard.style.backgroundColor = '#f8f9ff';
                        const hint = parentCard.querySelector('[data-hint]');
                        if(hint) hint.textContent = '👆 Clique para recolher';
                    }
                    // Scroll suave para a OP expandida
                    setTimeout(() => {
                        el.scrollIntoView({behavior:'smooth', block:'nearest'});
                    }, 100);
                }
            }
            function scrollToAndHighlight(id){
                const el=document.getElementById(id);
                if(!el) return;
                el.style.display='block';
                el.scrollIntoView({behavior:'smooth',block:'center'});
            }

            function displayOrders(){
                updateGraficaFilter(); // Atualizar opções de gráficas
                displayOrdersList(orders);
            }
            function displayOrdersList(list=orders){
                const el=document.getElementById('ordersList');
                if(list.length===0){
                    el.innerHTML='<div style="text-align:center;color:#6c757d;padding:40px;background:#f8f9fa;border-radius:10px;border:2px dashed #ddd;"><h3 style="margin-bottom:10px;">📋 Nenhuma ordem encontrada</h3><p>Crie sua primeira ordem de produção usando o formulário acima.</p></div>';
                    return;
                }
                
                // NOVA REGRA: Ordenação por status de produção e status geral
                const sortedList = [...list].sort((a, b) => {
                    // Função para verificar se todas as etapas de produção estão completas
                    const isProductionComplete = (order) => {
                        return order.enviadoFaca && order.enviadoChapa && order.enviadoImpressao;
                    };
                    
                    const aComplete = isProductionComplete(a);
                    const bComplete = isProductionComplete(b);
                    
                    // 1. OPs com etapas pendentes vêm primeiro
                    if (!aComplete && bComplete) return -1;
                    if (aComplete && !bComplete) return 1;
                    
                    // 2. Entre OPs com mesmo status de produção, priorizar "Em Andamento"
                    if (a.status === 'Em Andamento' && b.status === 'Finalizado') {
                        return -1;
                    }
                    if (a.status === 'Finalizado' && b.status === 'Em Andamento') {
                        return 1;
                    }
                    
                    // 3. Se tudo for igual, ordenar por ID (mais recentes primeiro)
                    return b.id.localeCompare(a.id, undefined, {numeric: true, sensitivity: 'base'});
                });
                
                const modeDescription = window.viewMode === 'list' 
                    ? '<div style="text-align:center;margin-bottom:20px;padding:12px;background:#e8f4fd;border-radius:8px;border-left:4px solid #74b9ff;"><p style="color:#2c3e50;margin:0;">💡 <strong>Modo Lista:</strong> Clique em qualquer OP para expandir os detalhes completos<br><small style="color:#fd7e14;">  OPs com etapas pendentes aparecem primeiro | 🟢 OPs com produção completa aparecem depois</small></p></div>'
                    : '<div style="text-align:center;margin-bottom:20px;padding:12px;background:#f0f8e8;border-radius:8px;border-left:4px solid #27ae60;"><p style="color:#2c3e50;margin:0;">💡 <strong>Modo Detalhado:</strong> Todas as informações visíveis<br><small style="color:#fd7e14;">  OPs com etapas pendentes aparecem primeiro | 🟢 OPs com produção completa aparecem depois</small></p></div>';
                
                if(window.viewMode==='list'){
                    el.innerHTML = modeDescription + sortedList.map(o=>buildCompactItem(o)).join('');
                }else{
                    el.innerHTML = modeDescription + sortedList.map(o=>buildDetailedCard(o)).join('');
                }
            }

            function duplicateOrder(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(!order){showNotification('Erro: Ordem não encontrada!','error');return;}
                fillFormWithTemplate(order);
                document.getElementById('quantidade').value='';
                document.getElementById('status').value='Em Andamento';
                showNotification(`Dados da ordem ${orderId} carregados para nova ordem!`,'success');
                document.querySelector('.main-content-new').scrollIntoView({behavior:'smooth'});
            }

            async function advanceStep(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(order&&order.currentStep<4){
                    order.currentStep++;
                    if(order.currentStep===4){order.status='Finalizado';}
                    await setJSON('productionOrders', orders);
                    displayOrders();updateStats();
                    showNotification(`Ordem ${orderId} avançou para a próxima etapa!`,'success');
                }
            }
            async function deleteOrder(orderId){
                if(confirm('Tem certeza que deseja excluir esta ordem de produção?')){
                    try {
                        // Remove do array local e localStorage
                        orders=orders.filter(o=>o.id!==orderId);
                        await setJSON('productionOrders', orders);
                        displayOrders();updateStats();updateGraficaFilter();
                        showNotification(`Ordem ${orderId} excluída com sucesso!`,'info');
                    } catch (error) {
                        console.error('Erro ao excluir ordem:', error);
                        showNotification('❌ Erro ao excluir ordem: ' + error.message, 'error');
                    }
                }
            }

            /* IMPRESSÃO – preservando formatação e sem bloco de “Processo de Produção” */
            function printOrderModal(orderId){
                const order=orders.find(o=>o.id===orderId);
                if(!order){showNotification('Ordem não encontrada!','error');return;}

                const printHTML = `
                    <div class="print-header">
                        <h1 style="color:#2c3e50;font-size:22px;margin:0 0 6px 0;">ORDEM DE PRODUÇÃO</h1>
                        <h2 style="color:#667eea;font-size:18px;margin:0 0 6px 0;">${order.id}</h2>
                        ${order.nomeTemplate?`<h3 style="color:#2c3e50;font-size:16px;margin:0 0 6px 0;">📦 ${order.nomeTemplate}</h3>`:''}
                        <p style="color:#666;margin:2px 0;">Data: ${order.dataCreated} ${order.timeCreated?'às '+order.timeCreated:''}</p>
                        <p style="color:#666;margin:2px 0;">Status: ${order.status} | Prioridade: ${order.prioridade||'Média'}</p>
                        ${order.fornecedor?`<p style="color:#666;margin:2px 0;">Gráfica: 🏢 ${order.fornecedor}</p>`:''}
                        ${order.lastModified?`<p style="color:#e67e22;margin:2px 0;font-size:12px;">Última edição: ${order.lastModified}</p>`:''}
                    </div>

                    <!-- Layout adaptativo: tenta vertical primeiro, mas muda para lateral se necessário -->
                    <div class="print-layout-adaptive">
                        <div style="margin:10px 0;">
                            <h3 style="color:#2c3e50;margin-bottom:8px;font-size:14px;">📏 ESPECIFICAÇÕES</h3>
                            <table style="width:100%;border-collapse:collapse;max-width:600px;margin:0 auto;">
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Formato:</td><td style="padding:6px 0;color:#333;">${order.formato||'-'}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Medidas da Folha Impressa:</td><td style="padding:6px 0;color:#333;">${order.medidasFolha}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Quantidade de impressão:</td><td style="padding:6px 0;color:#333;">${parseInt(order.quantidade).toLocaleString()}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Quantidade Folhas/Resma:</td><td style="padding:6px 0;color:#333;">${order.folhasResma||'-'}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Tipo de Papel:</td><td style="padding:6px 0;color:#333;">${order.tipoPapel}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Gramatura:</td><td style="padding:6px 0;color:#333;">${order.gramatura}</td></tr>
                                <tr style="border-bottom:1px solid #ddd;"><td style="padding:6px 0;font-weight:bold;color:#333;">Impressão:</td><td style="padding:6px 0;color:#333;">${order.impressao}</td></tr>
                            </table>
                        </div>

                        <!-- Seções de texto compactas -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0;">
                            <div style="margin:0;">
                                <h3 style="color:#2c3e50;margin-bottom:4px;font-size:13px;">🎨 Acabamento</h3>
                                <div style="background:#f8f9fa;padding:6px;border-radius:6px;border-left:3px solid #667eea;max-height:80px;overflow:hidden;">
                                    <pre style="white-space:pre-wrap;margin:0;font-size:11px;line-height:1.3;color:#333;">${order.acabamento||'N/A'}</pre>
                                </div>
                            </div>
                            <div style="margin:0;">
                                <h3 style="color:#2c3e50;margin-bottom:4px;font-size:13px;">📝 Observação</h3>
                                <div style="background:#f8f9fa;padding:6px;border-radius:6px;border-left:3px solid #667eea;max-height:80px;overflow:hidden;">
                                    <pre style="white-space:pre-wrap;margin:0;font-size:11px;line-height:1.3;color:#333;">${order.descricaoEmbalagens||'N/A'}</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Imagens - layout adaptativo -->
                        ${order.imagemFaca||order.imagemArte?`
                        <div class="print-images-container" style="margin:10px 0;">
                            <h3 style="color:#2c3e50;margin-bottom:8px;font-size:14px;text-align:center;">🖼️ IMAGENS</h3>
                            <div class="print-images print-images-bottom" style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:0;">
                                ${order.imagemFaca?`<div class="print-image" style="text-align:center;"><div style="font-size:12px;margin-bottom:6px;font-weight:bold;">🔧 Faca</div><img src="${order.imagemFaca}" alt="Faca" style="max-height:280px;max-width:100%;border:2px solid #ddd;border-radius:8px;"></div>`:''}
                                ${order.imagemArte?`<div class="print-image" style="text-align:center;"><div style="font-size:12px;margin-bottom:6px;font-weight:bold;">🎨 Arte</div><img src="${order.imagemArte}" alt="Arte" style="max-height:280px;max-width:100%;border:2px solid #ddd;border-radius:8px;"></div>`:''}
                            </div>
                        </div>`:`<div></div>`}
                    </div>
                `;
                document.getElementById('printContent').innerHTML=printHTML;
                document.getElementById('printModal').style.display='block';
                const modal=document.getElementById('printModal');const modalContent=document.getElementById('printContent');
                modal.style.visibility='visible';modalContent.style.visibility='visible';modalContent.style.display='block';
                showNotification('Preview da impressão carregado!','success');
            }

            function closePrintModal(){document.getElementById('printModal').style.display='none';}
            function printOrder(){
                const modal=document.getElementById('printModal');
                const content=document.getElementById('printContent');
                if(modal.style.display==='none'||!content.innerHTML.trim()){showNotification('Erro: Nenhum conteúdo para imprimir!','error');return;}
                content.style.display='block';content.style.visibility='visible';
                setTimeout(()=>{try{window.print();showNotification('Enviando para impressão...','info');}catch(e){console.error(e);showNotification('Erro ao imprimir. Tente novamente.','error');}},300);
            }

            function exportData(){
                if(orders.length===0){showNotification('Nenhuma ordem para exportar.','info');return;}
                const dataStr=JSON.stringify({orders,productTemplates},null,2);
                const blob=new Blob([dataStr],{type:'application/json'});
                const url=URL.createObjectURL(blob);
                const a=document.createElement('a');a.href=url;a.download=`ordens_producao_completo_${new Date().toISOString().split('T')[0]}.json`;a.click();
                showNotification('Dados exportados com sucesso!','success');
            }
            function importData(){document.getElementById('importFile').click();}
            


            async function handleImport(ev){
                const file=ev.target.files[0];if(!file)return;
                const r=new FileReader();
                r.onload=async e=>{
                    try{
                        const imported=JSON.parse(e.target.result);
                        if(imported.orders&&Array.isArray(imported.orders)){
                            orders=imported.orders;
                            if(imported.productTemplates&&Array.isArray(imported.productTemplates)){productTemplates=imported.productTemplates;await setJSON('productTemplates', productTemplates);}
                            
                            await setJSON('productionOrders', orders);displayOrders();updateStats();updateGraficaFilter();showNotification('Dados importados com sucesso!','success');
                        }else if(Array.isArray(imported)){
                            orders=imported;
                            
                            await setJSON('productionOrders', orders);displayOrders();updateStats();updateGraficaFilter();showNotification('Dados importados com sucesso!','success');
                        }else{throw new Error('Formato inválido');}
                    }catch(err){showNotification('Erro ao importar dados. Verifique o formato do arquivo.','error');}
                };
                r.readAsText(file);
            }

            async function clearAllData(){
                if(confirm('ATENÇÃO: Isso irá excluir TODAS as ordens de produção E modelos salvos. Esta ação não pode ser desfeita. Deseja continuar?')){
                    orders=[];productTemplates=[];orderIdCounter=1;
                    
                    // Limpa localStorage
                    localStorage.removeItem('productionOrders');localStorage.removeItem('productTemplates');localStorage.removeItem('orderIdCounter');
                    
                    displayOrders();updateStats();updateGraficaFilter();showNotification('Todos os dados foram removidos.','info');
                }
            }

            // Inicialização principal da aplicação
            async function initializeApp() {
                try {
                    await loadInitialData();
                    setViewMode(viewMode);
                    displayOrders();
                    updateStats();
                    updateGraficaFilter(); // Atualizar filtro de gráficas
                    await migrateAndCompactOrdersIfNeeded();
                    
                    showNotification('✅ Sistema carregado com localStorage!', 'success');
                } catch (e) {
                    console.error('Erro na inicialização:', e);
                    showNotification('Erro ao carregar dados.', 'warning');
                }
            }

            // Inicialização quando o DOM estiver pronto
            document.addEventListener('DOMContentLoaded', initializeApp);

            // Fechar modais ao clicar fora
            window.onclick=function(e){
                const pm=document.getElementById('printModal');
                const em=document.getElementById('editModal');
                const tm=document.getElementById('templatesModal');
                if(e.target===pm)closePrintModal();
                if(e.target===em)closeEditModal();
                if(e.target===tm)closeTemplatesModal();
            }

        // Auto-salvar assíncrono
            setInterval(async ()=>{
                try{
                    if(orders.length>0) await setJSON('productionOrders', orders);
                    if(productTemplates.length>0) await setJSON('productTemplates', productTemplates);
                } catch(e) {
                    console.warn('Auto-save error:', e);
                }
            }, 30000);

            // Listeners de impressão
            window.addEventListener('beforeprint',function(){const pc=document.getElementById('printContent');if(pc){pc.style.display='block !important';pc.style.visibility='visible !important';}});
            window.addEventListener('afterprint',function(){showNotification('Impressão enviada!','success');});
        
            /* ===== Scroll FAB (Topo <-> Ordens) ===== */
    document.addEventListener('DOMContentLoaded', function(){
        let initialized = false;
        function initFab(){
            if(initialized) return;
            const fab = document.getElementById('scrollFab');
            const ordersSection = document.querySelector('.orders-list');
            if(!fab) return;
            initialized = true;

            function atTop(){ return (window.scrollY || document.documentElement.scrollTop || 0) < 150; }
            function updateFab(){
                if(atTop()){
                    fab.textContent = '📋';
                    fab.setAttribute('aria-label','Ir para Ordens');
                    fab.title = 'Ir para Ordens';
                }else{
                    fab.textContent = '⬆️';
                    fab.setAttribute('aria-label','Voltar ao topo');
                    fab.title = 'Voltar ao topo';
                }
            }
            fab.addEventListener('click', function(){
                if(atTop()){
                    if(ordersSection){ ordersSection.scrollIntoView({behavior:'smooth', block:'start'}); }
                }else{
                    window.scrollTo({top:0, behavior:'smooth'});
                }
            });
            window.addEventListener('scroll', updateFab, {passive:true});
            updateFab();
        }
        initFab();
        window.addEventListener('load', initFab, {once:true});
    });
    /* ===== Compatibilidade Mobile (evitar zoom em inputs no iOS) ===== */
            (function(){
                try{
                    const set16 = el => el && (el.style.fontSize = '16px');
                    document.querySelectorAll('input, select, textarea, button').forEach(set16);
                }catch(e){/* no-op */}
            })();
    window.addEventListener('error', function(e){ try{ if(typeof showNotification==='function'){ showNotification('⚠️ Erro de script detectado. Verifique os dados/ações recentes.', 'warning'); } }catch(_){} });
    </script>
        </main>
        
        <!-- Placeholder da página Orçamentos (fica oculto até montar) -->
        <section id="orcamentos-host" style="display:none"></section>
        
        <!-- Botão Flutuante: Topo / Ir para Ordens -->
        <button id="scrollFab" class="fab" aria-label="Ir para Ordens" title="Ir para Ordens">📋</button>

        <!-- Página de Ficha Técnica do Produto -->
        <main id="page-ficha" class="ft" aria-label="Ficha Técnica do Produto" hidden>
            <div class="container">
                <div class="header">
                    <h1>📋 Ficha Técnica do Produto</h1>
                    <p>Especificações Completas de Embalagens</p>
                </div>

                <div class="form-card">
                    <form id="fichaTecnicaForm">
                        <!-- Informações Básicas do Produto -->
                        <div class="section">
                            <h2>📦 Informações Básicas</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fotoProduto">Foto do Produto</label>
                                    <div class="image-upload" onclick="document.getElementById('fotoProduto').click()">
                                        <input type="file" id="fotoProduto" accept="image/*" style="display:none;">
                                        <p>📸 Clique para adicionar foto do produto</p>
                                    </div>
                                    <img id="prevFoto" class="image-preview" style="display:none;">
                                </div>
                                <div class="form-group">
                                    <label for="codigo">Código do Produto</label>
                                    <input type="text" id="codigo" placeholder="Ex: EMB-001">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nome">Nome do Produto</label>
                                    <input type="text" id="nome" placeholder="Ex: Caixa Pizza Grande">
                                </div>
                                <div class="form-group">
                                    <label for="tipoEmb">Tipo de Embalagem</label>
                                    <input type="text" id="tipoEmb" placeholder="Ex: Caixa, Sacola, Envelope">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="data">Data de Criação</label>
                                    <input type="date" id="data">
                                </div>
                                <div class="form-group">
                                    <label for="versao">Versão</label>
                                    <input type="text" id="versao" placeholder="Ex: v1.0">
                                </div>
                            </div>
                        </div>

                        <!-- Especificações do Material -->
                        <div class="section">
                            <h2>📄 Especificações do Material</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="material">Material</label>
                                    <input type="text" id="material" placeholder="Ex: Papel Cartão, Kraft">
                                </div>
                                <div class="form-group">
                                    <label for="gramatura">Gramatura (g/m²)</label>
                                    <input type="number" id="gramatura" placeholder="Ex: 300">
                                </div>
                            </div>
                        </div>

                        <!-- Dimensões Abertas -->
                        <div class="section">
                            <h2>📐 Dimensões Abertas (mm)</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="compAberta">Comprimento</label>
                                    <input type="number" id="compAberta" placeholder="mm">
                                </div>
                                <div class="form-group">
                                    <label for="largAberta">Largura</label>
                                    <input type="number" id="largAberta" placeholder="mm">
                                </div>
                                <div class="form-group">
                                    <label for="altAberta">Altura</label>
                                    <input type="number" id="altAberta" placeholder="mm">
                                </div>
                            </div>
                        </div>

                        <!-- Faca e Montagem -->
                        <div class="section">
                            <h2>🔧 Faca e Montagem</h2>
                            <div class="form-group">
                                <label for="facaEMontada">Arquivo da Faca e Montagem</label>
                                <div class="image-upload" onclick="document.getElementById('facaEMontada').click()">
                                    <input type="file" id="facaEMontada" accept="image/*,application/pdf" style="display:none;">
                                    <p>📄 Clique para adicionar arquivo da faca</p>
                                </div>
                                <img id="prevFaca" class="image-preview" style="display:none;">
                            </div>
                        </div>

                        <!-- Dimensões Fechadas -->
                        <div class="section">
                            <h2>📦 Dimensões Fechadas (mm)</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="compFechada">Comprimento</label>
                                    <input type="number" id="compFechada" placeholder="mm">
                                </div>
                                <div class="form-group">
                                    <label for="largFechada">Largura</label>
                                    <input type="number" id="largFechada" placeholder="mm">
                                </div>
                                <div class="form-group">
                                    <label for="altFechada">Altura</label>
                                    <input type="number" id="altFechada" placeholder="mm">
                                </div>
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="section">
                            <h2>📝 Observações</h2>
                            <div class="form-group">
                                <label for="obs">Observações Técnicas</label>
                                <textarea id="obs" placeholder="Observações sobre montagem, acabamento, etc."></textarea>
                            </div>
                        </div>

                        <!-- Processos de Produção -->
                        <div class="section">
                            <h2>🏭 Processos de Produção</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="processoImpressao">Processo de Impressão</label>
                                    <input type="text" id="processoImpressao" placeholder="Ex: Offset, Digital">
                                </div>
                                <div class="form-group">
                                    <label for="acabamentos">Acabamentos</label>
                                    <input type="text" id="acabamentos" placeholder="Ex: Verniz UV, Laminação">
                                </div>
                            </div>
                        </div>

                        <!-- Informações Comerciais -->
                        <div class="section">
                            <h2>💼 Informações Comerciais</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="marca">Marca</label>
                                    <input type="text" id="marca" placeholder="Nome da marca">
                                </div>
                                <div class="form-group">
                                    <label for="codigoBarras">Código de Barras</label>
                                    <input type="text" id="codigoBarras" placeholder="Código de barras">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="peso">Peso (g)</label>
                                    <input type="number" id="peso" placeholder="Peso em gramas">
                                </div>
                                <div class="form-group">
                                    <label for="dimPac">Dimensões da Embalagem</label>
                                    <input type="text" id="dimPac" placeholder="Ex: 20x15x10 cm">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="categoria">Categoria</label>
                                    <input type="text" id="categoria" placeholder="Ex: Alimentício, Cosmético">
                                </div>
                                <div class="form-group">
                                    <label for="descricao">Descrição</label>
                                    <input type="text" id="descricao" placeholder="Descrição do produto">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quantPac">Quantidade por Pacote</label>
                                    <input type="number" id="quantPac" placeholder="Unidades por pacote">
                                </div>
                                <div class="form-group">
                                    <label for="variacao">Variação</label>
                                    <input type="text" id="variacao" placeholder="Ex: Tamanho P, M, G">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="preco">Preço Unitário (R$)</label>
                                    <input type="number" id="preco" step="0.01" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label for="ncm">NCM</label>
                                    <input type="text" id="ncm" placeholder="Código NCM">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="sku">SKU</label>
                                <input type="text" id="sku" placeholder="Código SKU">
                            </div>
                        </div>

                        <!-- Arquivos Técnicos -->
                        <div class="section">
                            <h2>📎 Arquivos Técnicos</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="arteFinal">Arte Final</label>
                                    <div class="image-upload" onclick="document.getElementById('arteFinal').click()">
                                        <input type="file" id="arteFinal" accept="image/*,application/pdf" style="display:none;">
                                        <p>🎨 Clique para adicionar arte final</p>
                                    </div>
                                    <img id="prevArte" class="image-preview" style="display:none;">
                                </div>
                                <div class="form-group">
                                    <label for="fotosProt">Fotos do Protótipo</label>
                                    <div class="image-upload" onclick="document.getElementById('fotosProt').click()">
                                        <input type="file" id="fotosProt" accept="image/*" multiple style="display:none;">
                                        <p>📷 Clique para adicionar fotos do protótipo</p>
                                    </div>
                                    <img id="prevProt" class="image-preview" style="display:none;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="fotoMontada">Foto do Produto Montado</label>
                                <div class="image-upload" onclick="document.getElementById('fotoMontada').click()">
                                    <input type="file" id="fotoMontada" accept="image/*" style="display:none;">
                                    <p>📦 Clique para adicionar foto do produto montado</p>
                                </div>
                                <img id="prevMontada" class="image-preview" style="display:none;">
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="form-actions">
                            <button type="button" id="limpar" class="btn btn-secondary">🗑️ Limpar</button>
                            <button type="button" id="salvar" class="btn btn-primary">💾 Salvar</button>
                            <button type="button" id="imprimir" class="btn btn-success">🖨️ Imprimir</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>


        <!-- Modal Envio à Gráfica -->
        <div id="graficaModal" class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeGraficaModal()">&times;</span>
                <div class="print-preview">
                    <div class="print-header">
                        <h1>📦 Relatório de Envio à Gráfica</h1>
                        <p id="graficaMeta"></p>
                    </div>
                    <div id="graficaOrders"></div>
                    <div id="graficaTotais" style="margin-top:15px;"></div>
                </div>
                <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #ddd;">
                    <button class="btn btn-primary" onclick="printGraficaReport()">🖨️ Imprimir Relatório</button>
                    <button class="btn btn-warning" onclick="closeGraficaModal()">❌ Fechar</button>
                </div>
            </div>
        </div>
        
        <!-- JavaScript de Roteamento SPA -->
        <script>
        (function(){
            const OP     = document.getElementById('page-op');
            const FICHA  = document.getElementById('page-ficha');
            const goOp   = document.getElementById('go-op');
            const goFi   = document.getElementById('go-ficha');

            function show(view){            // view: 'op' | 'ficha'
                const isFicha = view === 'ficha';
                OP.hidden    = isFicha;
                FICHA.hidden = !isFicha;
                // foco acessível
                (isFicha ? FICHA : OP).setAttribute('tabindex','-1');
                (isFicha ? FICHA : OP).focus({preventScroll:true});
            }

            function route(){
                const hash = (location.hash || '#/op').toLowerCase();
                if (hash.includes('/ficha')) show('ficha');
                else show('op');
            }

            // botões
            goOp  .addEventListener('click', () => { location.hash = '#/op';    });
            goFi  .addEventListener('click', () => { location.hash = '#/ficha'; });

            // escuta de rota
            window.addEventListener('hashchange', route);
            // rota inicial
            route();
        })();

        // JavaScript da Ficha Técnica
        if(document.getElementById('page-ficha')) {
            const STORAGE_KEY = 'ficha-tecnica-simples-v1';

            // IDs dos campos
            const fieldIds = [
                'codigo', 'nome', 'tipoEmb', 'data', 'versao',
                'material', 'gramatura',
                'compAberta', 'largAberta', 'altAberta',
                'compFechada', 'largFechada', 'altFechada',
                'obs', 'processoImpressao', 'acabamentos',
                'marca', 'codigoBarras', 'peso', 'dimPac',
                'categoria', 'descricao', 'quantPac', 'variacao',
                'preco', 'ncm', 'sku'
            ];

            // Pré-visualização de imagens
            function setupFilePreview(inputId, previewId) {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                
                if(input && preview) {
                    input.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if(file && file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            };
                            reader.readAsDataURL(file);
                        } else {
                            preview.style.display = 'none';
                        }
                    });
                }
            }

            // Configurar pré-visualizações
            setupFilePreview('fotoProduto', 'prevFoto');
            setupFilePreview('facaEMontada', 'prevFaca');
            setupFilePreview('arteFinal', 'prevArte');
            setupFilePreview('fotosProt', 'prevProt');
            setupFilePreview('fotoMontada', 'prevMontada');

            // Salvar rascunho
            function salvarRascunho() {
                const data = {};
                fieldIds.forEach(id => {
                    const field = document.getElementById(id);
                    if(field) data[id] = field.value;
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                alert('✅ Rascunho salvo com sucesso!');
            }

            // Carregar rascunho
            function carregarRascunho() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if(saved) {
                    try {
                        const data = JSON.parse(saved);
                        fieldIds.forEach(id => {
                            const field = document.getElementById(id);
                            if(field && data[id]) field.value = data[id];
                        });
                    } catch(e) {
                        console.error('Erro ao carregar rascunho:', e);
                    }
                }
            }

            // Limpar formulário
            function limparFormulario() {
                if(confirm('Deseja limpar todos os campos?')) {
                    fieldIds.forEach(id => {
                        const field = document.getElementById(id);
                        if(field) field.value = '';
                    });
                    
                    // Limpar pré-visualizações
                    ['prevFoto', 'prevFaca', 'prevArte', 'prevProt', 'prevMontada'].forEach(id => {
                        const preview = document.getElementById(id);
                        if(preview) preview.style.display = 'none';
                    });
                    
                    // Limpar arquivos
                    ['fotoProduto', 'facaEMontada', 'arteFinal', 'fotosProt', 'fotoMontada'].forEach(id => {
                        const input = document.getElementById(id);
                        if(input) input.value = '';
                    });
                    
                    localStorage.removeItem(STORAGE_KEY);
                    alert('✅ Formulário limpo!');
                }
            }

            // Imprimir
            function imprimirFicha() {
                window.print();
            }

            // Event listeners
            document.getElementById('salvar').addEventListener('click', salvarRascunho);
            document.getElementById('limpar').addEventListener('click', limparFormulario);
            document.getElementById('imprimir').addEventListener('click', imprimirFicha);

            // Carregar ao inicializar
            carregarRascunho();

            // Auto-salvar a cada 30 segundos
            setInterval(() => {
                const data = {};
                fieldIds.forEach(id => {
                    const field = document.getElementById(id);
                    if(field && field.value.trim()) data[id] = field.value;
                });
                if(Object.keys(data).length > 0) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                }
            }, 30000);
        }
        </script>
        
<script>
(() => {
  // ========= Seletores da sua plataforma =========
  // Ajuste o seletor do "contêiner principal" se necessário,
  // para que possamos ocultá-lo ao abrir Orçamentos e reexibi-lo ao voltar.
  const mainAppSelector = '#page-op, #page-ficha, #topnav, #scrollFab'; // tente na ordem
  const mainElements = document.querySelectorAll(mainAppSelector);

  // Botão do topo (já inserido em A)
  const btnGo = document.getElementById('btnGoOrcamentos');
  const host = document.getElementById('orcamentos-host');

  // ========= Funções de navegação =========
  function openOrcamentos(){
    mainElements.forEach(el => el.style.display = 'none');
    host.style.display = 'block';
    // Monta o módulo apenas uma vez
    if(!host._mounted) mountOrcamentos();
  }
  function closeOrcamentos(){
    host.style.display = 'none';
    mainElements.forEach(el => el.style.display = '');
  }

  if(btnGo){
    btnGo.addEventListener('click', openOrcamentos);
  }

  // ========= Montagem do módulo em Shadow DOM =========
  function mountOrcamentos(){
    const shadow = host.attachShadow({mode:'open'});

    // ---------- CSS do módulo (escopado) ----------
    const style = document.createElement('style');
    style.textContent = `
      :host{all:initial;font-family:Segoe UI,Arial,Helvetica,sans-serif;color:#333}
      .wrap{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:16px}
      .container{max-width:1300px;margin:0 auto}
      .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
      .row{display:grid;gap:10px}
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:repeat(3,1fr)}
      .row.four{grid-template-columns:repeat(4,1fr)}
      @media(max-width:900px){.row.two,.row.three,.row.four{grid-template-columns:1fr}}
      label{display:block;font-weight:700;margin:6px 0}
      input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:2px solid #e0e6ed;background:#f8f9fa;font-size:14px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px;border-bottom:1px solid #e0e6ed;font-size:14px;text-align:left}
      th{background:#f6f7ff}
      .btn{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:700}
      .primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
      .success{background:linear-gradient(135deg,#28a745,#20c997);color:#fff}
      .light{background:#eef1ff;color:#364fc7;border:2px solid #d9ddff}
      .danger{background:linear-gradient(135deg,#fd79a8,#e84393);color:#fff}
      .muted{color:#6b7280}
      .topbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
      .tabs{display:flex;gap:6px;background:#f1f3f4;padding:6px;border-radius:12px}
      .tab{border:0;background:transparent;padding:10px 14px;border-radius:10px;font-weight:700;color:#6c757d;cursor:pointer}
      .tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
      .panel{display:none}
      .panel.active{display:block}
      .totals{display:grid;gap:6px}
      .grid{display:grid;gap:10px}
      .hist-item{background:#fff;border:1px solid #e5e7eb;border-left:6px solid #667eea;border-radius:12px;padding:10px}
      .details{display:none;background:#f9fafb;border:1px dashed #d1d5db;border-radius:12px;padding:10px;margin-top:8px}
      .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#eceff7;color:#334155;font-size:.8rem;font-weight:800}
      .warn{background:#fff3cd;color:#b45309}
      .dark{background:#eceff7;color:#334155}
      .header h1{color:#2c3e50;font-size:1.6rem;margin:0 0 4px 0}
      .right{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    `;

    // ---------- HTML estático ----------
    const root = document.createElement('div');
    root.className = 'wrap';
    root.innerHTML = `
      <div class="container">
        <div class="card header" style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap">
            <div>
              <h1>🧾 Plataforma de Orçamentos — Embalagens Conceito</h1>
              <div class="muted">Módulo completo embutido no index.html (Shadow DOM isolado)</div>
            </div>
            <button id="btnVoltar" class="btn light">⬅️ Voltar para a plataforma</button>
          </div>
        </div>

        <div class="card topbar">
          <button class="btn primary" id="btnNovo">➕ Novo Orçamento</button>
          <button class="btn success" id="btnSalvar">💾 Salvar</button>
          <button class="btn light" id="btnDuplicar">📄 Duplicar</button>
          <button class="btn light" id="btnExportar">⬇️ Exportar JSON</button>
          <input id="fileImport" type="file" style="display:none" accept=".json"/>
          <button class="btn light" id="btnImportar">⬆️ Importar JSON</button>
          <button class="btn primary" id="btnImprimir">🖨️ Imprimir</button>
          <select id="status" class="btn light">
            <option value="Rascunho">⬜ Rascunho</option>
            <option value="Em negociação">🟧 Em negociação</option>
            <option value="Aprovado">🟩 Aprovado</option>
            <option value="Perdido">🟥 Perdido</option>
          </select>
          <button class="btn light" id="btnWhats">📲 WhatsApp</button>
          <button class="btn danger" id="btnLimpar">🗑️ Limpar</button>
        </div>

        <div class="card">
          <div class="tabs">
            <button class="tab active" data-k="cliente">1. 👤 Cliente</button>
            <button class="tab" data-k="itens">2. 📦 Itens</button>
            <button class="tab" data-k="condicoes">3. 📑 Condições</button>
            <button class="tab" data-k="resumo">4. 🧮 Resumo</button>
          </div>

          <div id="p-cliente" class="panel active">
            <div class="row two" style="margin-top:10px">
              <div><label>Cliente / Empresa *</label><input id="cliNome"/></div>
              <div><label>CNPJ/CPF</label><input id="cliDoc"/></div>
            </div>
            <div class="row two">
              <div><label>E-mail</label><input id="cliEmail"/></div>
              <div><label>Telefone</label><input id="cliFone"/></div>
            </div>
            <div class="row two">
              <div><label>Endereço</label><input id="cliEndereco"/></div>
              <div><label>Contato</label><input id="cliContato"/></div>
            </div>
          </div>

          <div id="p-itens" class="panel">
            <div class="right" style="margin:10px 0"><button class="btn primary" id="btnAddItem">➕ Adicionar Item</button></div>
            <div class="card">
              <table id="tblItens">
                <thead>
                  <tr><th>#</th><th>Descrição</th><th>Material</th><th>Impressão</th><th>Acabamento</th><th>Qtd</th><th>Custo (R$)</th><th>Margem %</th><th>Unit (R$)</th><th>Total (R$)</th><th>Ações</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="p-condicoes" class="panel">
            <h3>Condições Comerciais</h3>
            <div class="row three" style="margin-top:6px">
              <div><label>Validade (dias)</label><input id="validade" type="number" value="7"/></div>
              <div><label>Prazo de entrega (dias)</label><input id="prazoEntrega" type="number" value="15"/></div>
              <div><label>Pagamento</label><input id="pagamento" value="30/60 dias"/></div>
            </div>
            <div class="row three">
              <div><label>ICMS (%)</label><input id="icms" type="number" step="0.01" value="12"/></div>
              <div><label>Frete</label>
                <select id="frete">
                  <option value="Incluso" selected>Incluso</option>
                  <option value="FOB">FOB</option>
                  <option value="A combinar">A combinar</option>
                </select>
              </div>
              <div><label>Desconto Global (%)</label><input id="desconto" type="number" step="0.01" value="0"/></div>
            </div>

            <div class="card" style="margin-top:10px">
              <h3>Base de Cálculo Interna (não imprime)</h3>
              <div class="row four" style="margin-top:6px">
                <div><label>Faca (R$)</label><input id="c_faca" type="number" step="0.01" value="0"/></div>
                <div><label>Papel (R$)</label><input id="c_papel" type="number" step="0.01" value="0"/></div>
                <div><label>Cola (R$)</label><input id="c_cola" type="number" step="0.01" value="0"/></div>
                <div><label>Impressão (R$)</label><input id="c_impressao" type="number" step="0.01" value="0"/></div>
              </div>
              <div class="row four" style="margin-top:6px">
                <div><label>Custo Fixo (R$)</label><input id="c_fixos" type="number" step="0.01" value="0"/></div>
                <div><label>Visor (R$)</label><input id="c_visor" type="number" step="0.01" value="0"/></div>
                <div><label>NF (R$)</label><input id="c_nf" type="number" step="0.01" value="0"/></div>
                <div><label>IPI (R$)</label><input id="c_ipi" type="number" step="0.01" value="0"/></div>
              </div>
              <div class="row three" style="margin-top:6px">
                <div><label>Margem de Lucro Global (%)</label><input id="c_margem_glob" type="number" step="0.01" value="0"/></div>
                <div><label><strong>Soma Custos Internos</strong></label><input id="c_soma" readonly/></div>
                <div><label><strong>Base (Itens + Custos)</strong></label><input id="c_base" readonly/></div>
              </div>
              <div class="row three" style="margin-top:6px">
                <div><label><strong>Com Margem Global</strong></label><input id="c_com_margem" readonly/></div>
              </div>
              <div class="muted" style="margin-top:6px">Estes valores afetam apenas o cálculo e não aparecem no PDF.</div>
            </div>

            <label style="margin-top:10px">Observações (aparecem no PDF)</label>
            <textarea id="obs"></textarea>
          </div>

          <div id="p-resumo" class="panel">
            <h3>Resumo Financeiro</h3>
            <div class="row two" style="margin:6px 0">
              <div class="card">
                <div class="totals">
                  <div style="display:flex;justify-content:space-between"><span>Subtotal (itens)</span><span id="tSubtotal">R$ 0,00</span></div>
                  <div style="display:flex;justify-content:space-between"><span>Desconto global</span><span id="tDesc">- R$ 0,00</span></div>
                  <div style="display:flex;justify-content:space-between"><span>ICMS (informativo)</span><span id="tIcms">12%</span></div>
                  <div style="display:flex;justify-content:space-between;font-size:1.1rem"><strong>Total Geral</strong><strong id="tGeral">R$ 0,00</strong></div>
                </div>
              </div>
              <div class="card">
                <label>Mensagem ao cliente (capa do PDF)</label>
                <textarea id="mensagemCliente">Agradecemos sua consulta. Seguem valores e condições.</textarea>
              </div>
            </div>

            <h3>Prévia para Impressão</h3>
            <div class="card" id="printPreview"></div>
            <div class="right" style="margin-top:8px">
              <button class="btn primary" id="btnAtualizarPreview">🔄 Atualizar Prévia</button>
              <button class="btn success" id="btnIrImprimir">🖨️ Imprimir agora</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <h3>📜 Histórico de Orçamentos</h3>
          <div id="listaHistorico" class="grid"></div>
        </div>
      </div>
    `;

        // ---------- JS do módulo ----------
        // Criar uma função para inicializar o módulo
        window.initOrcamentosModule = function(rootElement) {
            const root = rootElement;
            if (!root || !root.isConnected) {
                console.error('Root element não disponível para o módulo de orçamentos');
                return;
            }

            // Definir funções helper primeiro
            const qS = (sel, ctx = root) => ctx.querySelector(sel);
            const qSA = (sel, ctx = root) => Array.from(ctx.querySelectorAll(sel));
      
            // Função helper para definir propriedades aninhadas
            function set(obj,path,val){const ks=path.split('.'); let r=obj; while(ks.length>1){const k=ks.shift(); if(!(k in r)) r[k]={}; r=r[k];} r[ks[0]]=val;}
      
            // Função para formatação de valores
            function fmt(v, currency = false){
                const num = Number(v||0);
                if(currency) {
                    return num.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
                }
                return num.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
            }
      
            // Função para gerar ID único
            function genId(){return 'ORC-'+Math.random().toString(36).slice(2,8).toUpperCase();}
      
            // Funções de cálculo
            function unitario(it){return Math.max(0,(it.custo*(1+(Number(it.margem)||0)/100))/Math.max(1,Number(it.qtd)||1));}
            function totalItem(it){return unitario(it)*Math.max(1,Number(it.qtd)||1);}
      
            // Funções de localStorage
            function loadAll(){try{return JSON.parse(localStorage.getItem('conceito_orc_v4')||'[]')}catch(_){return[]}}
            function saveAll(l){localStorage.setItem('conceito_orc_v4',JSON.stringify(l))}

            const state={
        id:genId(),status:'Rascunho',
        cliente:{nome:'',doc:'',email:'',fone:'',endereco:'',contato:''},
        itens:[],
        condicoes:{validade:7,prazoEntrega:15,pagamento:'30/60 dias',icms:12,frete:'Incluso',desconto:0,obs:''},
        custos:{faca:0,papel:0,cola:0,impressao:0,fixos:0,visor:0,nf:0,ipi:0,margemGlob:0},
        mensagemCliente:'Agradecemos sua consulta. Seguem valores e condições.',
        criadoEm:Date.now(),atualizadoEm:Date.now()
      };

      const storageKey='conceito_orc_v4';

      function saveCurrent(){
        const l=loadAll(); const i=l.findIndex(x=>x.id===state.id);
        state.atualizadoEm=Date.now();
        if(i>=0) l[i]=structuredClone(state); else l.unshift(structuredClone(state));
        saveAll(l); renderHistorico();
      }

      // Funções para manipulação de itens
      const tbody=qS('#tblItens tbody',root);
      function addItem(d={}){const it=Object.assign({id:'I'+Math.random().toString(36).slice(2,8),descricao:'',material:'',impressao:'4x0',acabamento:'',qtd:1000,custo:0,margem:30},d); state.itens.push(it); drawItens(); saveCurrent();}
      function removeItem(id){state.itens=state.itens.filter(i=>i.id!==id); drawItens(); saveCurrent(); calcAll();}
      function drawItens(){
        tbody.innerHTML='';
        state.itens.forEach((it,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML='<td>'+(idx+1)+'</td><td><input value="'+it.descricao+'" data-k="descricao" data-id="'+it.id+'"/></td><td><input value="'+it.material+'" data-k="material" data-id="'+it.id+'"/></td><td><select data-k="impressao" data-id="'+it.id+'"><option '+(it.impressao==='4x0'?'selected':'')+' value="4x0">4x0</option><option '+(it.impressao==='4x4'?'selected':'')+' value="4x4">4x4</option></select></td><td><input value="'+it.acabamento+'" data-k="acabamento" data-id="'+it.id+'"/></td><td><input type="number" min="1" value="'+it.qtd+'" data-k="qtd" data-id="'+it.id+'"/></td><td><input type="number" min="0" step="0.01" value="'+it.custo+'" data-k="custo" data-id="'+it.id+'"/></td><td><input type="number" min="0" step="0.01" value="'+it.margem+'" data-k="margem" data-id="'+it.id+'"/></td><td>'+fmt(unitario(it), true)+'</td><td>'+fmt(totalItem(it), true)+'</td><td><button class="btn danger" data-del="'+it.id+'">Excluir</button></td>';
          tbody.appendChild(tr);
        });
        qSA('input,select',tbody).forEach(inp=>{
          if(inp.dataset.k){
            inp.addEventListener('input',e=>{
              const id=e.target.dataset.id; const k=e.target.dataset.k; const it=state.itens.find(x=>x.id===id);
              let v=e.target.value; if(['qtd','custo','margem'].includes(k)) v=Number(v||0);
              it[k]=v; drawItens(); saveCurrent(); calcAll();
            });
          }
          if(inp.dataset.del) inp.addEventListener('click',()=>removeItem(inp.dataset.del));
        });
      }

      // Tabs
      qSA('.tab',root).forEach(b=>{
        b.addEventListener('click',()=>{
          qSA('.tab',root).forEach(x=>x.classList.remove('active')); b.classList.add('active');
          qSA('.panel',root).forEach(p=>p.classList.remove('active'));
          const id=b.dataset.k;
          qS(id==='cliente'?'#p-cliente':id==='itens'?'#p-itens':id==='condicoes'?'#p-condicoes':'#p-resumo',root).classList.add('active');
          if(id==='resumo'){calcAll();renderPreview();}
        });
      });

      // Bind cliente
      const bindC={'cliNome':'cliente.nome','cliDoc':'cliente.doc','cliEmail':'cliente.email','cliFone':'cliente.fone','cliEndereco':'cliente.endereco','cliContato':'cliente.contato'};
      Object.entries(bindC).forEach(([id,path])=>{
        qS('#'+id,root).addEventListener('input',e=>{set(state,path,e.target.value);saveCurrent();});
      });

      // Condições
      const bindCond={validade:'condicoes.validade',prazoEntrega:'condicoes.prazoEntrega',pagamento:'condicoes.pagamento',icms:'condicoes.icms',frete:'condicoes.frete',desconto:'condicoes.desconto',obs:'condicoes.obs'};
      Object.entries(bindCond).forEach(([id,path])=>{
        const el=qS('#'+id,root); el.addEventListener('input',()=>{const v=(id==='icms'||id==='desconto'||id==='validade'||id==='prazoEntrega')?Number(el.value||0):el.value; set(state,path,v); saveCurrent(); calcAll();});
      });

      // Custos internos
      const bindCost={'c_faca':'custos.faca','c_papel':'custos.papel','c_cola':'custos.cola','c_impressao':'custos.impressao','c_fixos':'custos.fixos','c_visor':'custos.visor','c_nf':'custos.nf','c_ipi':'custos.ipi','c_margem_glob':'custos.margemGlob'};
      Object.entries(bindCost).forEach(([id,path])=>{
        qS('#'+id,root).addEventListener('input',e=>{set(state,path,Number(e.target.value||0)); saveCurrent(); calcAll();});
      });

      qS('#mensagemCliente',root).addEventListener('input',e=>{state.mensagemCliente=e.target.value; saveCurrent();});

      // Resumo
      function calcAll(){
        const subtotalItens=state.itens.reduce((s,i)=>s+totalItem(i),0);
        const c=state.custos;
        const soma=(c.faca||0)+(c.papel||0)+(c.cola||0)+(c.impressao||0)+(c.fixos||0)+(c.visor||0)+(c.nf||0)+(c.ipi||0);
        const base=subtotalItens+soma;
        const comMargem=base*(1+((c.margemGlob||0)/100));
        const desc=comMargem*((state.condicoes.desconto||0)/100);
        const total=Math.max(0,comMargem-desc);
        qS('#tSubtotal',root).textContent=fmt(subtotalItens, true);
        qS('#tDesc',root).textContent='- '+fmt(desc, true);
        qS('#tIcms',root).textContent=(Number(state.condicoes.icms)||0).toFixed(2)+'%';
        qS('#tGeral',root).textContent=fmt(total, true);
        setRead('c_soma',soma); setRead('c_base',base); setRead('c_com_margem',comMargem);
        return {subtotalItens,desc,total};
      }
      function setRead(id,val){const el=qS('#'+id,root); if(el) el.value=fmt(val);}

      function renderPreview(){
        const {subtotalItens,desc,total}=calcAll();
        const ESC=s=>String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        const NL=s=>String(s||'').replace(/\\n/g,'<br/>');
        let h='<div style="text-align:center;padding-bottom:10px;margin-bottom:12px;border-bottom:3px solid #667eea"><div style="font-size:1.3rem;font-weight:800;color:#111">Embalagens Conceito</div><div style="color:#444;margin-top:6px">'+ESC(state.mensagemCliente||'')+'</div></div>';
        h+='<div style="margin-bottom:12px"><div style="font-weight:800;margin-bottom:6px">Resumo Financeiro</div>';
        h+='<div style="display:grid;gap:6px"><div style="display:flex;justify-content:space-between"><span>Subtotal (itens)</span><strong>'+fmt(subtotalItens)+'</strong></div>';
        h+='<div style="display:flex;justify-content:space-between"><span>Desconto global</span><strong>- '+fmt(desc)+'</strong></div>';
        h+='<div style="display:flex;justify-content:space-between"><span>ICMS (informativo)</span><strong>'+((Number(state.condicoes.icms)||0).toFixed(2))+'%</strong></div>';
        h+='<div style="display:flex;justify-content:space-between;font-size:1.05rem"><span>Total Geral</span><strong>'+fmt(total)+'</strong></div></div></div>';
        h+='<div style="border-top:1px solid #e5e7eb;padding-top:8px;margin-top:4px"><div style="font-weight:800;margin-bottom:6px">Proposta Comercial</div>';
        h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">';
        h+='<div><strong>Cliente:</strong> '+ESC(state.cliente.nome)+'<br/><strong>Documento:</strong> '+ESC(state.cliente.doc)+'<br/><strong>Contato:</strong> '+ESC(state.cliente.contato)+'<br/><strong>Telefone:</strong> '+ESC(state.cliente.fone)+'</div>';
        h+='<div><strong>E-mail:</strong> '+ESC(state.cliente.email)+'<br/><strong>Endereço:</strong> '+ESC(state.cliente.endereco)+'<br/><strong>Orçamento:</strong> '+state.id+'<br/><strong>Status:</strong> '+state.status+'</div></div></div>';
        h+='<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f6f7ff"><th style="padding:8px;border-bottom:1px solid #e5e7eb">#</th><th style="padding:8px;border-bottom:1px solid #e5e7eb">Descrição</th><th style="padding:8px;border-bottom:1px solid #e5e7eb">Material</th><th style="padding:8px;border-bottom:1px solid #e5e7eb">Impressão</th><th style="padding:8px;border-bottom:1px solid #e5e7eb">Acabamento</th><th style="padding:8px;border-bottom:1px solid #e5e7eb">Qtd</th><th style="padding:8px;border-bottom:1px solid #e5e7eb">Unit</th><th style="padding:8px;border-bottom:1px solid #e5e7eb">Total</th></tr></thead><tbody>';
        state.itens.forEach((it,i)=>{
          const unit=fmt((it.custo*(1+(Number(it.margem)||0)/100))/Math.max(1,Number(it.qtd)||1));
          const tot=fmt((it.custo*(1+(Number(it.margem)||0)/100)));
          h+='<tr><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+(i+1)+'</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+ESC(it.descricao)+'</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+ESC(it.material)+'</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+ESC(it.impressao)+'</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+ESC(it.acabamento)+'</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+(Number(it.qtd)||0)+'</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+unit+'</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">'+tot+'</td></tr>';
        });
        h+='</tbody></table><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px"><div>';
        h+='<div><strong>Pagamento:</strong> '+ESC(state.condicoes.pagamento)+'</div>';
        h+='<div><strong>Prazo de entrega:</strong> '+(Number(state.condicoes.prazoEntrega)||0)+' dias</div>';
        h+='<div><strong>Validade da proposta:</strong> '+(Number(state.condicoes.validade)||0)+' dias</div>';
        h+='<div><strong>ICMS:</strong> '+(Number(state.condicoes.icms)||0)+'% (informativo)</div>';
        h+='<div><strong>Frete:</strong> '+ESC(state.condicoes.frete)+'</div></div>';
        h+='<div style="background:#f8f9ff;border:1px dashed #dbe1ff;padding:8px;border-radius:10px">';
        h+='<div style="display:flex;justify-content:space-between"><strong>Subtotal</strong><span>'+fmt(subtotalItens)+'</span></div>';
        h+='<div style="display:flex;justify-content:space-between"><strong>Desconto</strong><span>- '+fmt(desc)+'</span></div>';
        h+='<div style="display:flex;justify-content:space-between;font-size:1.05rem"><strong>Total</strong><span><strong>'+fmt(total)+'</strong></span></div></div></div>';
        h+='<div style="margin-top:8px;font-size:.95rem;color:#374151"><strong>Observações:</strong><br/>'+NL(state.condicoes.obs||'* Quantidades confirmadas podem variar em até 10% (para mais ou menos), sendo excedentes faturados.\\n* Tributação ICMS 12% (informe se diferente para recálculo).\\n* Conferir mercadoria no ato do recebimento; não aceitamos reclamações posteriores por avarias/faltas.\\n* Arquivos fornecidos pelo cliente: nos isentamos de erros.')+'</div>';
        h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px"><div><span class="tag warn">⚠️ Tolerância de quantidade: ±10%</span> <span class="tag dark">📌 Conferir mercadoria no recebimento</span></div>';
        h+='<div style="text-align:right"><div style="display:inline-block;padding:10px 12px;border:2px solid #e5e7eb;border-radius:10px">';
        h+='<div style="font-size:.9rem;color:#6b7280">Autorizo a confecção dos itens acima assinalados:</div>';
        h+='<div style="height:40px"></div><div style="border-top:1px solid #cbd5e1;padding-top:4px">Assinatura e carimbo</div></div></div></div>';
        qS('#printPreview',root).innerHTML=h;
      }

      function printInPopup(){
        const html=qS('#printPreview',root).innerHTML;
        const w=window.open('','printwin','width=900,height=1000');
        if(!w){alert('Permita pop-ups para imprimir.');return;}
        w.document.open();
        w.document.write('<!doctype html><html lang="pt-BR"><head><meta charset="utf-8"><title>Orçamento '+state.id+'</title><style>body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:24px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #e5e7eb}th{background:#f6f7ff;text-align:left}</style></head><body>'+html+'</body></html>');
        w.document.close(); w.focus(); w.print(); w.close();
      }

      // Histórico
      function renderHistorico(){
        const list=loadAll(); const box=qS('#listaHistorico',root); box.innerHTML='';
        if(!list.length){box.innerHTML='<div class="muted">Sem orçamentos salvos.</div>'; return;}
        list.forEach(or=>{
          const el=document.createElement('div'); el.className='hist-item';
          const dt=new Date(or.atualizadoEm||or.criadoEm);
          const detId='d'+or.id;
          el.innerHTML='<div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap"><div><strong>'+or.id+'</strong> — '+esc(or.cliente?.nome||'(sem cliente)')+'</div><div class="tag">'+or.status+'</div></div><div class="muted">'+(or.itens?.length||0)+' item(ns) • Atualizado em '+dt.toLocaleString('pt-BR')+'</div><div class="right" style="margin-top:6px"><button class="btn light" data-open="'+or.id+'">Abrir</button><button class="btn light" data-dup="'+or.id+'">Duplicar</button><button class="btn danger" data-del="'+or.id+'">Excluir</button></div><div class="details" id="'+detId+'"></div>';
          box.appendChild(el);
        });
        qSA('[data-open]',root).forEach(b=> b.onclick=()=>toggleDetalhes(b.dataset.open));
        qSA('[data-dup]',root).forEach(b=> b.onclick=()=>dupId(b.dataset.dup));
        qSA('[data-del]',root).forEach(b=> b.onclick=()=>delId(b.dataset.del));
      }
      function toggleDetalhes(id){
        const list=loadAll(); const or=list.find(x=>x.id===id); if(!or) return;
        const det=qS('#d'+id,root); const opened=det.style.display==='block';
        if(opened){det.style.display='none'; det.innerHTML=''; return;}
        const linhas=(or.itens||[]).map((it,i)=>'<tr><td>'+(i+1)+'</td><td>'+esc(it.descricao||'')+'</td><td>'+esc(it.material||'')+'</td><td>'+esc(it.impressao||'')+'</td><td>'+esc(it.acabamento||'')+'</td><td>'+(Number(it.qtd)||0)+'</td><td>'+fmt(it.custo||0)+'</td><td>'+(Number(it.margem||0))+'%</td></tr>').join('');
        det.innerHTML='<div class="grid"><div><strong>Cliente:</strong> '+esc(or.cliente?.nome||'')+' • <strong>Doc:</strong> '+esc(or.cliente?.doc||'')+'</div><div><strong>Contato:</strong> '+esc(or.cliente?.contato||'')+' • <strong>Fone:</strong> '+esc(or.cliente?.fone||'')+'</div><div><strong>Email:</strong> '+esc(or.cliente?.email||'')+' • <strong>Endereço:</strong> '+esc(or.cliente?.endereco||'')+'</div><div><strong>Pagamento:</strong> '+esc(or.condicoes?.pagamento||'')+' • <strong>Entrega:</strong> '+(or.condicoes?.prazoEntrega||0)+'d • <strong>Validade:</strong> '+(or.condicoes?.validade||0)+'d • <strong>ICMS:</strong> '+(or.condicoes?.icms||0)+'% • <strong>Frete:</strong> '+esc(or.condicoes?.frete||'')+'</div><div class="card" style="padding:8px"><table style="width:100%"><thead><tr><th>#</th><th>Descrição</th><th>Material</th><th>Impressão</th><th>Acabamento</th><th>Qtd</th><th>Custo</th><th>Margem</th></tr></thead><tbody>'+(linhas||'<tr><td colspan="8" class="muted">Sem itens</td></tr>')+'</tbody></table></div><div class="right"><button class="btn light" data-load="'+or.id+'">Carregar no editor</button><button class="btn success" data-print="'+or.id+'">Imprimir este</button></div></div>';
        det.style.display='block';
        qS('[data-load="'+or.id+'"]',det).onclick=()=>openId(or.id);
        qS('[data-print="'+or.id+'"]',det).onclick=()=>{openId(or.id); renderPreview(); printInPopup();};
      }

      function openId(id){const l=loadAll(); const or=l.find(x=>x.id===id); if(!or) return alert('Não encontrado.'); Object.assign(state,structuredClone(or)); rebindAll();}
      function dupId(id){const l=loadAll(); const or=l.find(x=>x.id===id); if(!or) return; const cp=structuredClone(or); cp.id=genId(); cp.status='Rascunho'; cp.criadoEm=Date.now(); cp.atualizadoEm=Date.now(); l.unshift(cp); saveAll(l); renderHistorico(); alert('📄 Duplicado!');}
      function delId(id){if(!confirm('Excluir este orçamento?')) return; let l=loadAll(); l=l.filter(x=>x.id!==id); saveAll(l); renderHistorico();}

      // Botões topo do módulo
      qS('#btnVoltar',root).onclick=()=>window.__closeOrcamentos && window.__closeOrcamentos();
      qS('#btnAddItem',root).onclick=()=>addItem({});
      qS('#btnNovo',root).onclick=()=>{Object.assign(state,{id:genId(),status:'Rascunho',cliente:{nome:'',doc:'',email:'',fone:'',endereco:'',contato:''},itens:[],condicoes:{validade:7,prazoEntrega:15,pagamento:'30/60 dias',icms:12,frete:'Incluso',desconto:0,obs:''},custos:{faca:0,papel:0,cola:0,impressao:0,fixos:0,visor:0,nf:0,ipi:0,margemGlob:0},mensagemCliente:'Agradecemos sua consulta. Seguem valores e condições.',criadoEm:Date.now(),atualizadoEm:Date.now()}); drawItens(); calcAll(); renderPreview(); saveCurrent();};
      qS('#btnSalvar',root).onclick=()=>{saveCurrent(); alert('✅ Orçamento salvo.');};
      qS('#btnDuplicar',root).onclick=()=>{const cp=structuredClone(state); cp.id=genId(); cp.status='Rascunho'; cp.criadoEm=Date.now(); cp.atualizadoEm=Date.now(); const l=loadAll(); l.unshift(cp); saveAll(l); renderHistorico(); alert('📄 Duplicado!');};
      qS('#btnExportar',root).onclick=()=>{const blob=new Blob([JSON.stringify(loadAll(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='orcamentos_conceito.json'; a.click(); URL.revokeObjectURL(a.href);};
      qS('#btnImportar',root).onclick=()=>qS('#fileImport',root).click();
      qS('#fileImport',root).addEventListener('change',e=>{const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{try{const arr=JSON.parse(r.result); if(Array.isArray(arr)){saveAll(arr); renderHistorico(); alert('⬆️ Importado!');}}catch{alert('Arquivo inválido.')}}; r.readAsText(f);});
      const goPrint=()=>{renderPreview(); printInPopup();};
      qS('#btnImprimir',root).onclick=goPrint;
      qS('#btnIrImprimir',root).onclick=goPrint;
      qS('#btnLimpar',root).onclick=()=>{if(confirm('Limpar todos os orçamentos do navegador?')){localStorage.removeItem(storageKey); renderHistorico(); alert('🗑️ Limpo.');}};
      qS('#status',root).onchange=(e)=>{state.status=e.target.value; saveCurrent(); renderHistorico();};
      qS('#btnWhats',root).onclick=()=>{const {total}=calcAll(); const itensTxt=state.itens.map((it,i)=>(i+1)+'. '+it.descricao+' ('+it.qtd+' un) — Unit '+fmt(unitario(it))).join('\\n'); const url='https://wa.me/?text='+encodeURIComponent('Olá! Segue proposta '+state.id+':\\n\\nCliente: '+state.cliente.nome+'\\n\\nItens:\\n'+itensTxt+'\\n\\nTotal: '+fmt(total)+'\\nPagamento: '+state.condicoes.pagamento+'\\nEntrega: '+state.condicoes.prazoEntrega+' dias\\nValidade: '+state.condicoes.validade+' dias\\nFrete: '+state.condicoes.frete+'\\n\\n'+state.mensagemCliente); window.open(url,'_blank');};

      // Helpers
      function rebindAll(){
        qS('#cliNome',root).value=state.cliente.nome||''; qS('#cliDoc',root).value=state.cliente.doc||'';
        qS('#cliEmail',root).value=state.cliente.email||''; qS('#cliFone',root).value=state.cliente.fone||'';
        qS('#cliEndereco',root).value=state.cliente.endereco||''; qS('#cliContato',root).value=state.cliente.contato||'';
        drawItens();
        qS('#validade',root).value=state.condicoes.validade||7; qS('#prazoEntrega',root).value=state.condicoes.prazoEntrega||15;
        qS('#pagamento',root).value=state.condicoes.pagamento||'30/60 dias'; qS('#icms',root).value=state.condicoes.icms||12;
        qS('#frete',root).value=state.condicoes.frete||'Incluso'; qS('#desconto',root).value=state.condicoes.desconto||0; qS('#obs',root).value=state.condicoes.obs||'';
        qS('#c_faca',root).value=state.custos.faca||0; qS('#c_papel',root).value=state.custos.papel||0; qS('#c_cola',root).value=state.custos.cola||0; qS('#c_impressao',root).value=state.custos.impressao||0;
        qS('#c_fixos',root).value=state.custos.fixos||0; qS('#c_visor',root).value=state.custos.visor||0; qS('#c_nf',root).value=state.custos.nf||0; qS('#c_ipi',root).value=state.custos.ipi||0; qS('#c_margem_glob',root).value=state.custos.margemGlob||0;
        qS('#mensagemCliente',root).value=state.mensagemCliente||''; qS('#status',root).value=state.status||'Rascunho';
        calcAll(); renderPreview();
      }

      // Inicialização
      addItem({});
      renderHistorico();
      rebindAll();

      // Expor para botão "Voltar"
      window.__closeOrcamentos = () => {
        // volta para página principal (fora do shadow)
        const ev = new CustomEvent('orcamentos:close', {bubbles:true});
        root.dispatchEvent(ev);
      };

            function esc(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
    };

        // Append e wire "voltar"
        shadow.appendChild(style);
        shadow.appendChild(root);

        if (typeof window.initOrcamentosModule === 'function') {
            try {
                window.initOrcamentosModule(root);
            } catch (err) {
                console.error('Falha ao iniciar o módulo de orçamentos:', err);
            }
        } else {
            console.error('initOrcamentosModule não está disponível para inicialização');
        }

    root.addEventListener('orcamentos:close', () => {
      if(window.closeOrcamentos) window.closeOrcamentos();
    });

    // Expor handlers no window para a página mãe
    window.closeOrcamentos = () => {
      if(typeof window.__orcembe_close === 'function') { window.__orcembe_close(); }
      // a página mãe escuta e oculta/mostra containers
      const ev = new CustomEvent('parent:close-orcamentos');
      window.dispatchEvent(ev);
    };

    host._mounted = true;
  }

  // Listener do botão "Voltar" (emitido de dentro do Shadow)
  window.addEventListener('parent:close-orcamentos', closeOrcamentos);

  // Disponibiliza globalmente (útil caso precise chamar por console)
  window.openOrcamentos = openOrcamentos;
  window.closeOrcamentos = closeOrcamentos;
})();
</script>

    </body>
    </html>
